<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Al Bourakh - VTC & Paiement v3.9.1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; overflow-x: hidden; }
        
        .hero-section { background: linear-gradient(135deg, #00A854, #FECB00, #E30613); padding: 40px 15px; text-align: center; color: white; }
        .hero-logo { width: 100px; height: 75px; margin-bottom: 12px; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3)); }
        .hero-title { font-size: 2em; margin-bottom: 8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .hero-subtitle { font-size: 1em; opacity: 0.95; }
        .hero-cta { display: inline-block; margin-top: 20px; padding: 12px 28px; font-size: 1em; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; background: white; color: #00A854; box-shadow: 0 8px 25px rgba(0,0,0,0.2); transition: all 0.3s; margin-right: 10px; }
        .hero-cta:hover { transform: scale(1.05); }
        .hero-cta.wallet-btn { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; }

        .wallet-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; overflow-y: auto; }
        .wallet-modal.active { display: block; }
        .wallet-container { max-width: 500px; margin: 10px auto; background: #f9fafb; border-radius: 15px; overflow: hidden; min-height: calc(100vh - 20px); }
        .wallet-header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .wallet-header h2 { font-size: 1.2em; display: flex; align-items: center; gap: 8px; }
        .wallet-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        .wallet-content { padding: 15px; }
        
        .wallet-card { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .wallet-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .wallet-amount { font-size: 2.25rem; font-weight: 700; margin-top: 0.25rem; }
        .wallet-label { color: #bfdbfe; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .wallet-actions { display: flex; gap: 0.5rem; margin-top: 1.5rem; }
        .btn-wallet { flex: 1; padding: 0.75rem; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-wallet.primary { background: white; color: #2563eb; }
        .btn-wallet.secondary { background: #3b82f6; color: white; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-content { display: flex; align-items: center; gap: 0.75rem; }
        .stat-icon { padding: 0.5rem; border-radius: 0.5rem; font-size: 1.2em; }
        .stat-icon.green { background: #dcfce7; color: #16a34a; }
        .stat-icon.purple { background: #f3e8ff; color: #9333ea; }
        .stat-icon.orange { background: #fed7aa; color: #ea580c; }
        .stat-label { color: #6b7280; font-size: 0.75rem; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #111827; }

        .loyalty-card { background: linear-gradient(to right, #fbbf24 0%, #f97316 100%); border-radius: 0.75rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .loyalty-points { font-size: 1.875rem; font-weight: 700; color: white; margin-top: 0.25rem; }
        .loyalty-label { color: white; font-size: 0.875rem; font-weight: 500; }
        .loyalty-badge { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 0.5rem; padding: 0.5rem 1rem; color: white; font-size: 0.75rem; }

        .welcome-bonus { background: linear-gradient(135deg, #10b981, #059669); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem; color: white; text-align: center; }
        .welcome-bonus h4 { font-size: 1rem; margin-bottom: 0.5rem; }
        .welcome-bonus p { font-size: 0.85rem; opacity: 0.9; }

        .card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }

        .pending-requests-alert { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .pending-requests-alert i { font-size: 1.5rem; color: #f59e0b; }
        .pending-requests-info h4 { font-weight: 600; color: #92400e; margin-bottom: 0.25rem; }
        .pending-requests-info p { font-size: 0.85rem; color: #78350f; }

        .amount-input-container { position: relative; margin-bottom: 1rem; }
        .amount-input { width: 100%; padding: 1rem; font-size: 1.5rem; font-weight: 700; text-align: center; border: 2px solid #e5e7eb; border-radius: 0.75rem; }
        .amount-input:focus { outline: none; border-color: #2563eb; }
        .amount-currency { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.25rem; color: #9ca3af; }
        .quick-amounts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .quick-amount-btn { padding: 0.75rem; border: none; border-radius: 0.5rem; background: #f3f4f6; color: #374151; font-weight: 500; cursor: pointer; }

        .payment-method-wallet { width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; background: white; margin-bottom: 0.75rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .payment-method-wallet.active { border-color: #2563eb; background: #eff6ff; }
        .payment-method-content { display: flex; align-items: center; gap: 0.75rem; }
        .payment-method-icon { font-size: 1.5rem; }
        .payment-method-name { font-weight: 500; color: #111827; }

        .btn-primary-wallet { width: 100%; padding: 0.75rem; border: none; border-radius: 0.5rem; color: white; font-weight: 500; cursor: pointer; background: #2563eb; }

        .transaction-list { border-top: 1px solid #f3f4f6; }
        .transaction-item { padding: 1rem; border-bottom: 1px solid #f3f4f6; }
        .transaction-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .transaction-route { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #111827; }
        .transaction-driver { font-size: 0.75rem; color: #6b7280; }
        .transaction-amount { font-size: 1.125rem; font-weight: 700; }
        .transaction-footer { display: flex; justify-content: space-between; align-items: center; }
        .transaction-date { font-size: 0.75rem; color: #6b7280; }
        .transaction-badge { font-size: 0.75rem; background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 9999px; }

        .success-screen { min-height: 60vh; display: flex; align-items: center; justify-content: center; text-align: center; }
        .success-icon { background: #dcfce7; width: 6rem; height: 6rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 3rem; color: #16a34a; }
        .pending-icon { background: #fef3c7; color: #f59e0b; }
        .pending-title { color: #f59e0b; }

        .wallet-screen { display: none; }
        .wallet-screen.active { display: block; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; margin-right: 10px; }

        .map-container { max-width: 1200px; margin: 20px auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        .map-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .map-logo { font-size: 1.1em; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; }
        .search-container { position: relative; flex: 1; min-width: 200px; }
        .search-input { width: 100%; padding: 10px 35px 10px 12px; border: none; border-radius: 8px; font-size: 0.95em; }
        .search-input:focus { outline: none; }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #00A854; }
        .map-controls { display: flex; gap: 6px; }
        .map-btn { padding: 8px 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.85em; }
        .btn-primary { background: #00A854; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-outline { background: white; color: #333; }
        #map { height: 400px; width: 100%; }

        .booking-section { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
        .booking-container { background: white; border-radius: 15px; padding: 25px 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .booking-header { text-align: center; margin-bottom: 25px; }
        .booking-header h2 { font-size: 1.6em; color: #00A854; margin-bottom: 8px; }
        .booking-header p { color: #666; }
        .booking-form { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #333; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
        .form-group input, .form-group select { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95em; width: 100%; }
        .form-group input:focus { outline: none; border-color: #00A854; }
        .input-with-button { display: flex; gap: 6px; width: 100%; }
        .input-with-button input { flex: 1; min-width: 0; }
        .btn-map-select { padding: 12px 10px; background: linear-gradient(135deg, #00A854, #FECB00); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85em; }
        .btn-gps { background: linear-gradient(135deg, #2196F3, #00BCD4); }
        .btn-gps.loading i { animation: spin 1s linear infinite; }
        .btn-gps.success { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        .datetime-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .vehicle-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 8px; }
        .vehicle-option { border: 2px solid #ddd; border-radius: 10px; padding: 12px 8px; text-align: center; cursor: pointer; background: #f9f9f9; }
        .vehicle-option.selected { border-color: #00A854; background: #e8f5e9; }
        .vehicle-option-icon { font-size: 1.8em; margin-bottom: 6px; }
        .vehicle-option-name { font-weight: bold; font-size: 0.85em; }
        .vehicle-option-price { color: #00A854; font-weight: bold; font-size: 0.8em; margin-top: 4px; }

        .payment-methods { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; }
        .payment-method { padding: 10px 6px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; background: #f9f9f9; }
        .payment-method.selected { border-color: #00A854; background: #e8f5e9; }
        .payment-method-icon { font-size: 1.3em; margin-bottom: 4px; }
        .payment-method-name { font-size: 0.75em; font-weight: 600; }
        .payment-method.wallet-option { background: linear-gradient(135deg, #eff6ff, #e0e7ff); border-color: #2563eb; }
        .wallet-balance-mini { font-size: 0.65em; color: #16a34a; font-weight: bold; }

        .booking-summary { background: linear-gradient(135deg, #00A854, #FECB00); padding: 20px 15px; border-radius: 12px; color: white; margin-top: 20px; display: none; }
        .summary-title { font-size: 1.2em; font-weight: bold; margin-bottom: 12px; text-align: center; }
        .summary-items { background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; }
        .summary-total { background: rgba(255,255,255,0.3); padding: 10px 12px; border-radius: 8px; display: flex; justify-content: space-between; font-size: 1.1em; font-weight: bold; }
        .booking-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-book { padding: 14px 10px; font-size: 1em; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-book-primary { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-book-secondary { background: white; color: #00A854; border: 2px solid #00A854; }

        /* ========== TRACKING MODAL AM√âLIOR√â v3.9 ========== */
        .tracking-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; overflow-y: auto; }
        .tracking-modal.active { display: block; }
        .tracking-container { max-width: 500px; margin: 10px auto; background: white; border-radius: 15px; overflow: hidden; min-height: calc(100vh - 20px); }
        .tracking-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .tracking-header h2 { font-size: 1.2em; display: flex; align-items: center; gap: 8px; }
        .tracking-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        
        #trackingMap { height: 280px; width: 100%; }
        .tracking-info { padding: 15px; }
        
        .route-mode-badge { background: linear-gradient(135deg, #2196F3, #00BCD4); padding: 10px 15px; border-radius: 12px; color: white; margin-bottom: 15px; text-align: center; font-weight: bold; display: none; align-items: center; justify-content: center; gap: 8px; }
        
        /* ‚úÖ NOUVEAU: Box d'approche am√©lior√©e */
        .driver-approaching-box { background: linear-gradient(135deg, #0ea5e9, #0284c7); padding: 20px; border-radius: 12px; color: white; margin-bottom: 15px; text-align: center; }
        .driver-approaching-title { font-size: 0.95em; opacity: 0.9; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .driver-eta { font-size: 3em; font-weight: bold; margin-bottom: 4px; line-height: 1; }
        .driver-eta-label { font-size: 0.9em; opacity: 0.9; }
        .driver-details-row { display: flex; justify-content: center; gap: 40px; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3); }
        .driver-detail { text-align: center; }
        .driver-detail-value { font-size: 1.3em; font-weight: bold; }
        .driver-detail-label { font-size: 0.75em; opacity: 0.8; }

        .status-timeline { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .status-step { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
        .status-step:last-child { border-bottom: none; }
        .status-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1em; background: #e0e0e0; color: #999; flex-shrink: 0; }
        .status-icon.active { background: #00A854; color: white; }
        .status-icon.current { background: #2196F3; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .status-text { flex: 1; }
        .status-text h4 { font-size: 0.9em; color: #333; margin-bottom: 2px; }
        .status-text p { font-size: 0.75em; color: #666; }
        .status-time { font-size: 0.75em; color: #999; }

        .driver-card { background: white; border: 2px solid #e0e0e0; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: none; }
        .driver-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .driver-avatar { width: 55px; height: 55px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.6em; color: white; overflow: hidden; }
        .driver-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .driver-info { flex: 1; }
        .driver-info h3 { font-size: 1em; color: #333; margin-bottom: 4px; }
        .driver-info p { font-size: 0.85em; color: #666; }
        .driver-vehicle { background: #f5f5f5; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .vehicle-info { display: flex; align-items: center; gap: 8px; }
        .vehicle-icon { font-size: 1.4em; }
        
        .driver-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .driver-action-btn { padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85em; }
        .btn-call { background: #00A854; color: white; }
        .btn-message { background: #2196F3; color: white; }

        .trip-details { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .trip-details h3 { font-size: 0.95em; color: #333; margin-bottom: 12px; }
        .trip-route { display: flex; flex-direction: column; gap: 12px; }
        .trip-point { display: flex; align-items: flex-start; gap: 10px; }
        .trip-point-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85em; color: white; }
        .trip-point-icon.start { background: #4CAF50; }
        .trip-point-icon.end { background: #E30613; }
        .trip-point-text { flex: 1; }
        .trip-point-label { font-size: 0.7em; color: #666; text-transform: uppercase; }
        .trip-point-address { font-size: 0.9em; color: #333; font-weight: 500; }
        .trip-connector { width: 2px; height: 20px; background: #ddd; margin-left: 13px; }
        .trip-price { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 2px dashed #ddd; }
        .trip-price-label { font-size: 0.85em; color: #666; }
        .trip-price-value { font-size: 1.3em; font-weight: bold; color: #00A854; }

        .validate-payment-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #9333ea, #7c3aed); border: none; color: white; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 12px; font-size: 1.1em; display: none; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 8px 25px rgba(124,58,237,0.4); }
        .validate-payment-btn.processing { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .validate-payment-btn.success { background: linear-gradient(135deg, #10b981, #059669); }

        .payment-info-box { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: none; }
        .payment-info-box.show { display: block; }
        .payment-info-title { font-weight: bold; color: #92400e; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .payment-info-text { font-size: 0.85em; color: #78350f; }
        .payment-info-amount { font-size: 1.3em; font-weight: bold; color: #b45309; margin-top: 8px; }

        .cancel-booking-btn { width: 100%; padding: 14px; background: #f5f5f5; border: 2px solid #E30613; color: #E30613; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .cancel-booking-btn:hover { background: #E30613; color: white; }

        .evaluation-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10005; display: none; align-items: center; justify-content: center; padding: 15px; overflow-y: auto; }
        .evaluation-modal.active { display: flex; }
        .evaluation-container { background: white; border-radius: 15px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .evaluation-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 20px 15px; color: white; text-align: center; border-radius: 15px 15px 0 0; }
        .evaluation-header h2 { font-size: 1.4em; margin-bottom: 8px; }
        .evaluation-content { padding: 20px 15px; }
        
        .evaluation-driver-summary { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .evaluation-driver-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; color: white; overflow: hidden; }
        .evaluation-driver-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .evaluation-driver-info h3 { font-size: 1em; color: #333; margin-bottom: 4px; }
        .evaluation-driver-info p { font-size: 0.85em; color: #666; }
        
        .rating-section { margin-bottom: 25px; }
        .rating-section h3 { font-size: 1em; color: #333; margin-bottom: 12px; text-align: center; }
        .star-rating { display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .star { font-size: 2.5em; color: #ddd; cursor: pointer; transition: all 0.2s; }
        .star:hover, .star.active { color: #FFC107; transform: scale(1.1); }
        .rating-label { text-align: center; font-size: 0.9em; color: #666; font-weight: 600; min-height: 24px; }
        
        .criteria-section { margin-bottom: 25px; }
        .criteria-section h3 { font-size: 1em; color: #333; margin-bottom: 15px; }
        .criteria-item { margin-bottom: 15px; }
        .criteria-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .criteria-label { font-size: 0.9em; color: #333; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .criteria-value { font-size: 0.85em; color: #00A854; font-weight: bold; }
        .criteria-stars { display: flex; gap: 4px; }
        .criteria-star { font-size: 1.2em; color: #ddd; cursor: pointer; }
        .criteria-star.active { color: #FFC107; }
        
        .comment-section { margin-bottom: 20px; }
        .comment-section h3 { font-size: 1em; color: #333; margin-bottom: 10px; }
        .comment-textarea { width: 100%; min-height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 0.9em; resize: vertical; }
        .comment-textarea:focus { outline: none; border-color: #00A854; }
        .comment-counter { text-align: right; font-size: 0.8em; color: #999; margin-top: 4px; }
        
        .evaluation-actions { display: flex; gap: 10px; padding-top: 15px; border-top: 1px solid #e0e0e0; }
        .evaluation-btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-weight: bold; font-size: 1em; cursor: pointer; }
        .btn-skip { background: #f5f5f5; color: #666; }
        .btn-submit-evaluation { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-submit-evaluation:disabled { opacity: 0.5; cursor: not-allowed; }

        .notification { position: fixed; top: 15px; right: 15px; left: 15px; max-width: 400px; margin: 0 auto; padding: 12px 20px; border-radius: 10px; color: white; font-weight: 600; z-index: 10001; animation: slideIn 0.3s; box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        @keyframes slideIn { from { transform: translateY(-100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #E30613; }
        .notification.info { background: #2196F3; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.2); border-top-color: #FECB00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 1.1em; margin-top: 18px; }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .payment-methods { grid-template-columns: repeat(2, 1fr); }
            #map { height: 320px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Chargement...</div>
    </div>

    <section class="hero-section">
        <img src="https://i.imgur.com/VtgG6pR.png" alt="Al Bourakh" class="hero-logo" onerror="this.style.display='none'">
        <h1 class="hero-title"><i class="fas fa-route"></i> Al Bourakh</h1>
        <p class="hero-subtitle">üöï Transport VTC ‚Ä¢ Paiement Int√©gr√© ‚Ä¢ 24/7</p>
        <div>
            <button class="hero-cta" onclick="scrollToBooking()"><i class="fas fa-car"></i> R√©server</button>
            <button class="hero-cta wallet-btn" onclick="openWallet()"><i class="fas fa-wallet"></i> Mon Portefeuille</button>
        </div>
    </section>

    <!-- WALLET MODAL -->
    <div class="wallet-modal" id="walletModal">
        <div class="wallet-container">
            <div class="wallet-header">
                <div style="display: flex; align-items: center;">
                    <button class="back-btn hidden" id="walletBackBtn" onclick="showWalletScreen('dashboard')"><i class="fas fa-arrow-left"></i></button>
                    <h2><i class="fas fa-wallet"></i> <span id="walletTitle">Mon Portefeuille</span></h2>
                </div>
                <button class="wallet-close" onclick="closeWallet()">√ó</button>
            </div>
            <div class="wallet-content" id="walletContent">
                <div class="wallet-screen active" id="walletDashboard"></div>
                <div class="wallet-screen" id="walletRecharge"></div>
                <div class="wallet-screen" id="walletHistory"></div>
                <div class="wallet-screen" id="walletSuccess"></div>
            </div>
        </div>
    </div>

    <!-- MAP -->
    <div class="map-container">
        <div class="map-header">
            <div class="map-logo">üöï Al Bourakh GPS</div>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Rechercher une adresse...">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="map-controls">
                <button class="map-btn btn-secondary" onclick="findMyLocation()"><i class="fas fa-location-arrow"></i> Position</button>
                <button class="map-btn btn-outline" onclick="toggleTraffic()"><i class="fas fa-traffic-light"></i> Trafic</button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <!-- BOOKING SECTION -->
    <section class="booking-section">
        <div class="booking-container">
            <div class="booking-header">
                <h2>üöï R√©servez votre trajet</h2>
                <p>R√©servation simple et rapide</p>
            </div>

            <form class="booking-form" id="bookingForm" onsubmit="return false;">
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> Point de d√©part</label>
                    <div class="input-with-button">
                        <input type="text" id="bookingFrom" required placeholder="Votre position...">
                        <button type="button" class="btn-map-select btn-gps" onclick="getCurrentPosition()" title="Utiliser ma position">
                            <i class="fas fa-crosshairs" id="gpsIcon"></i> GPS
                        </button>
                        <button type="button" class="btn-map-select" onclick="selectOnMap('from')"><i class="fas fa-map"></i> Carte</button>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-flag-checkered"></i> Destination</label>
                    <div class="input-with-button">
                        <input type="text" id="bookingTo" required placeholder="O√π allez-vous?">
                        <button type="button" class="btn-map-select" onclick="selectOnMap('to')"><i class="fas fa-map"></i> Carte</button>
                    </div>
                </div>
                
                <div class="datetime-group">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="bookingDate" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Heure</label>
                        <input type="time" id="bookingTime" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-phone"></i> T√©l√©phone</label>
                    <input type="tel" id="bookingPhone" required placeholder="+221 77 XXX XX XX">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Nom (optionnel)</label>
                    <input type="text" id="bookingName" placeholder="Votre nom">
                </div>
            </form>

            <div style="margin-top: 25px;">
                <h3 style="text-align: center; color: #00A854; margin-bottom: 12px;"><i class="fas fa-car"></i> Type de v√©hicule</h3>
                <div class="vehicle-options">
                    <div class="vehicle-option" onclick="selectVehicle('standard', 1500)">
                        <div class="vehicle-option-icon">üöó</div>
                        <div class="vehicle-option-name">Standard</div>
                        <div class="vehicle-option-price">1 500 FCFA+</div>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('confort', 2000)">
                        <div class="vehicle-option-icon">‚ú®</div>
                        <div class="vehicle-option-name">Confort</div>
                        <div class="vehicle-option-price">2 000 FCFA+</div>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('van', 2500)">
                        <div class="vehicle-option-icon">üöê</div>
                        <div class="vehicle-option-name">Van</div>
                        <div class="vehicle-option-price">2 500 FCFA+</div>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('premium', 3500)">
                        <div class="vehicle-option-icon">üëë</div>
                        <div class="vehicle-option-name">Premium</div>
                        <div class="vehicle-option-price">3 500 FCFA+</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <h3 style="text-align: center; color: #00A854; margin-bottom: 12px;"><i class="fas fa-credit-card"></i> Paiement</h3>
                <div class="payment-methods" id="paymentMethods">
                    <div class="payment-method" onclick="selectPayment('cash')">
                        <div class="payment-method-icon">üíµ</div>
                        <div class="payment-method-name">Esp√®ces</div>
                    </div>
                    <div class="payment-method" onclick="selectPayment('orange')">
                        <div class="payment-method-icon">üì±</div>
                        <div class="payment-method-name">Orange Money</div>
                    </div>
                    <div class="payment-method" onclick="selectPayment('wave')">
                        <div class="payment-method-icon">üí≥</div>
                        <div class="payment-method-name">Wave</div>
                    </div>
                    <div class="payment-method wallet-option" onclick="selectPayment('wallet')">
                        <div class="payment-method-icon">üëõ</div>
                        <div class="payment-method-name">Portefeuille</div>
                        <div class="wallet-balance-mini" id="walletBalanceMini">0 FCFA</div>
                    </div>
                </div>
            </div>

            <div class="booking-summary" id="bookingSummary">
                <div class="summary-title">üìã R√©capitulatif</div>
                <div class="summary-items">
                    <div class="summary-item"><span>Trajet:</span><span id="summaryRoute">-</span></div>
                    <div class="summary-item"><span>Date:</span><span id="summaryDateTime">-</span></div>
                    <div class="summary-item"><span>V√©hicule:</span><span id="summaryVehicle">-</span></div>
                    <div class="summary-item"><span>Paiement:</span><span id="summaryPayment">-</span></div>
                </div>
                <div class="summary-total"><span>Total estim√©:</span><span id="summaryTotal">0 FCFA</span></div>
            </div>

            <div class="booking-actions">
                <button type="button" class="btn-book btn-book-secondary" onclick="previewBooking()"><i class="fas fa-eye"></i> Aper√ßu</button>
                <button type="button" class="btn-book btn-book-primary" onclick="confirmBooking()"><i class="fas fa-check"></i> Confirmer</button>
            </div>
        </div>
    </section>

    <!-- LOGIN MODAL -->
    <div class="modal" id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 20000; align-items: center; justify-content: center;">
        <div class="modal-content" style="max-width: 400px; background: white; border-radius: 15px; padding: 30px; text-align: center;">
            <h2 style="color: #00A854; margin-bottom: 20px;">üëã Bienvenue sur Al Bourakh</h2>
            <p style="color: #666; margin-bottom: 25px;">Pour continuer, veuillez entrer vos informations</p>
            <div style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; padding: 12px; margin-bottom: 20px; color: white;">
                <p style="font-weight: bold;">üéÅ Bonus de bienvenue : 500 FCFA offerts !</p>
            </div>
            <div class="form-group" style="text-align: left; margin-bottom: 15px;">
                <label style="font-weight: 600; margin-bottom: 8px; display: block;"><i class="fas fa-phone"></i> T√©l√©phone *</label>
                <input type="tel" id="loginPhone" placeholder="+221 77 XXX XX XX" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <div class="form-group" style="text-align: left; margin-bottom: 25px;">
                <label style="font-weight: 600; margin-bottom: 8px; display: block;"><i class="fas fa-user"></i> Nom (optionnel)</label>
                <input type="text" id="loginName" placeholder="Votre nom" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <button onclick="submitLogin()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #00A854, #FECB00); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1em; cursor: pointer;">
                <i class="fas fa-check"></i> Continuer
            </button>
        </div>
    </div>

    <!-- EVALUATION MODAL -->
    <div class="evaluation-modal" id="evaluationModal">
        <div class="evaluation-container">
            <div class="evaluation-header">
                <h2><i class="fas fa-star"></i> √âvaluez votre course</h2>
                <p>Votre avis nous aide √† am√©liorer notre service</p>
            </div>
            <div class="evaluation-content">
                <div class="evaluation-driver-summary">
                    <div class="evaluation-driver-avatar" id="evalDriverAvatar">üë§</div>
                    <div class="evaluation-driver-info">
                        <h3 id="evalDriverName">Chauffeur</h3>
                        <p id="evalVehicle">Toyota Corolla ‚Ä¢ DK-1234-AB</p>
                    </div>
                </div>
                
                <div class="rating-section">
                    <h3>Note globale</h3>
                    <div class="star-rating" id="overallRating">
                        <span class="star" data-rating="1">‚òÖ</span>
                        <span class="star" data-rating="2">‚òÖ</span>
                        <span class="star" data-rating="3">‚òÖ</span>
                        <span class="star" data-rating="4">‚òÖ</span>
                        <span class="star" data-rating="5">‚òÖ</span>
                    </div>
                    <div class="rating-label" id="overallRatingLabel">S√©lectionnez une note</div>
                </div>
                
                <div class="criteria-section">
                    <h3>Crit√®res d'√©valuation</h3>
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-label"><i class="fas fa-car" style="color: #2196F3;"></i> Conduite</span>
                            <span class="criteria-value" id="conduiteValue">-</span>
                        </div>
                        <div class="criteria-stars" id="conduiteRating">
                            <span class="criteria-star" data-criteria="conduite" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-label"><i class="fas fa-clock" style="color: #FF9800;"></i> Ponctualit√©</span>
                            <span class="criteria-value" id="ponctualiteValue">-</span>
                        </div>
                        <div class="criteria-stars" id="ponctualiteRating">
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-label"><i class="fas fa-spray-can" style="color: #00BCD4;"></i> Propret√©</span>
                            <span class="criteria-value" id="propreteValue">-</span>
                        </div>
                        <div class="criteria-stars" id="propreteRating">
                            <span class="criteria-star" data-criteria="proprete" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-label"><i class="fas fa-smile" style="color: #4CAF50;"></i> Amabilit√©</span>
                            <span class="criteria-value" id="amabiliteValue">-</span>
                        </div>
                        <div class="criteria-stars" id="amabiliteRating">
                            <span class="criteria-star" data-criteria="amabilite" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                </div>
                
                <div class="comment-section">
                    <h3><i class="fas fa-comment-dots"></i> Commentaire (optionnel)</h3>
                    <textarea id="evaluationComment" class="comment-textarea" placeholder="Partagez votre exp√©rience..." maxlength="500"></textarea>
                    <div class="comment-counter"><span id="commentLength">0</span>/500</div>
                </div>
                
                <div class="evaluation-actions">
                    <button class="evaluation-btn btn-skip" onclick="skipEvaluation()">Plus tard</button>
                    <button class="evaluation-btn btn-submit-evaluation" id="submitEvaluationBtn" disabled><i class="fas fa-paper-plane"></i> Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TRACKING MODAL -->
    <div class="tracking-modal" id="trackingModal">
        <div class="tracking-container">
            <div class="tracking-header">
                <h2><i class="fas fa-route"></i> Suivi de course</h2>
                <button class="tracking-close" onclick="closeTracking()">√ó</button>
            </div>
            <div id="trackingMap"></div>
            <div class="tracking-info">
                <div class="route-mode-badge" id="routeModeBadge">
                    <i class="fas fa-car-side"></i>
                    <span id="routeModeText">Chauffeur en approche</span>
                </div>
                <div class="driver-approaching-box" id="driverApproachingBox">
                    <div class="driver-approaching-title">üöó Votre chauffeur arrive</div>
                    <div class="driver-eta" id="driverETA">--</div>
                    <div class="driver-eta-label">minutes</div>
                    <div class="driver-details-row">
                        <div class="driver-detail">
                            <div class="driver-detail-value" id="driverDistance">--</div>
                            <div class="driver-detail-label">Distance</div>
                        </div>
                        <div class="driver-detail">
                            <div class="driver-detail-value" id="driverArrivalTime">--</div>
                            <div class="driver-detail-label">Arriv√©e pr√©vue</div>
                        </div>
                    </div>
                </div>
                
                <div class="payment-info-box" id="paymentInfoBox">
                    <div class="payment-info-title"><i class="fas fa-info-circle"></i> Paiement en attente</div>
                    <div class="payment-info-text" id="paymentInfoText">Votre paiement sera d√©bit√© √† la fin de la course.</div>
                    <div class="payment-info-amount" id="paymentInfoAmount">0 FCFA</div>
                </div>
                
                <div class="status-timeline">
                    <div class="status-step" id="step1">
                        <div class="status-icon active"><i class="fas fa-check"></i></div>
                        <div class="status-text"><h4>R√©servation confirm√©e</h4><p>Votre course a √©t√© enregistr√©e</p></div>
                        <div class="status-time" id="step1Time">--:--</div>
                    </div>
                    <div class="status-step" id="step2">
                        <div class="status-icon" id="step2Icon"><i class="fas fa-user-check"></i></div>
                        <div class="status-text"><h4>Chauffeur assign√©</h4><p id="step2Text">En attente d'un chauffeur...</p></div>
                        <div class="status-time" id="step2Time">--:--</div>
                    </div>
                    <div class="status-step" id="step3">
                        <div class="status-icon" id="step3Icon"><i class="fas fa-car"></i></div>
                        <div class="status-text"><h4>Chauffeur en route</h4><p id="step3Text">Le chauffeur se dirige vers vous</p></div>
                        <div class="status-time" id="step3Time">--:--</div>
                    </div>
                    <div class="status-step" id="step4">
                        <div class="status-icon" id="step4Icon"><i class="fas fa-map-pin"></i></div>
                        <div class="status-text"><h4>Chauffeur arriv√©</h4><p>Le chauffeur est au point de prise en charge</p></div>
                        <div class="status-time" id="step4Time">--:--</div>
                    </div>
                    <div class="status-step" id="step5">
                        <div class="status-icon" id="step5Icon"><i class="fas fa-flag-checkered"></i></div>
                        <div class="status-text"><h4>Course en cours</h4><p>Direction votre destination</p></div>
                        <div class="status-time" id="step5Time">--:--</div>
                    </div>
                    <div class="status-step" id="step6">
                        <div class="status-icon" id="step6Icon"><i class="fas fa-credit-card"></i></div>
                        <div class="status-text"><h4>Paiement</h4><p id="step6Text">En attente de validation</p></div>
                        <div class="status-time" id="step6Time">--:--</div>
                    </div>
                </div>
                
                <div class="driver-card" id="driverCard">
                    <div class="driver-card-header">
                        <div class="driver-avatar" id="driverAvatar">üë§</div>
                        <div class="driver-info">
                            <h3 id="driverName">Chauffeur</h3>
                            <p><span class="driver-rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span> <span id="driverRating">4.9</span></p>
                        </div>
                    </div>
                    <div class="driver-vehicle">
                        <div class="vehicle-info">
                            <span class="vehicle-icon">üöó</span>
                            <div>
                                <div id="vehicleModel" style="font-weight: bold; font-size: 0.9em;">Toyota Corolla</div>
                                <div id="vehiclePlate" style="font-size: 0.75em; color: #666;">DK-1234-AB</div>
                            </div>
                        </div>
                    </div>
                    <div class="driver-actions">
                        <button class="driver-action-btn btn-call" onclick="callDriver()"><i class="fas fa-phone"></i> Appeler</button>
                        <button class="driver-action-btn btn-message" onclick="messageDriver()"><i class="fas fa-comment"></i> Message</button>
                    </div>
                </div>
                
                <div class="trip-details">
                    <h3>üó∫Ô∏è D√©tails du trajet</h3>
                    <div class="trip-route">
                        <div class="trip-point">
                            <div class="trip-point-icon start"><i class="fas fa-circle"></i></div>
                            <div class="trip-point-text"><div class="trip-point-label">D√©part</div><div class="trip-point-address" id="tripFrom">-</div></div>
                        </div>
                        <div class="trip-connector"></div>
                        <div class="trip-point">
                            <div class="trip-point-icon end"><i class="fas fa-flag"></i></div>
                            <div class="trip-point-text"><div class="trip-point-label">Destination</div><div class="trip-point-address" id="tripTo">-</div></div>
                        </div>
                    </div>
                    <div class="trip-price">
                        <span class="trip-price-label">Prix estim√©</span>
                        <span class="trip-price-value" id="tripPrice">0 FCFA</span>
                    </div>
                </div>
                
                <button class="validate-payment-btn" id="validatePaymentBtn" onclick="validatePayment()">
                    <i class="fas fa-check-circle"></i>
                    <span id="validatePaymentText">Valider le paiement</span>
                </button>
                
                <button class="cancel-booking-btn" id="cancelBookingBtn" onclick="cancelBooking()"><i class="fas fa-times"></i> Annuler la r√©servation</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
            authDomain: "albourakh-sn-ok.firebaseapp.com",
            projectId: "albourakh-sn-ok",
            storageBucket: "albourakh-sn-ok.firebasestorage.app",
            messagingSenderId: "297875396274",
            appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log('üöï Al Bourakh Client v3.9.1 - G√âOCODAGE AUTOMATIQUE');

        // ===== CONFIGURATION =====
        const WELCOME_BONUS = 500;
        const COMMISSION_RATE = 0.30;
        const DRIVER_RATE = 0.70;
        const WALLET_STORAGE_KEY = 'albourakh_wallet_v3';

        // ===== FONCTIONS UTILITAIRES S√âCURIS√âES =====
        function safeSetText(elementId, value) {
            const el = document.getElementById(elementId);
            if (el) { el.textContent = value; return true; }
            return false;
        }

        function safeSetHtml(elementId, html) {
            const el = document.getElementById(elementId);
            if (el) { el.innerHTML = html; return true; }
            return false;
        }

        function safeAddClass(elementId, className) {
            const el = document.getElementById(elementId);
            if (el) { el.classList.add(className); return true; }
            return false;
        }

        function safeRemoveClass(elementId, className) {
            const el = document.getElementById(elementId);
            if (el) { el.classList.remove(className); return true; }
            return false;
        }

        function safeSetStyle(elementId, prop, value) {
            const el = document.getElementById(elementId);
            if (el) { el.style[prop] = value; return true; }
            return false;
        }

        function isTrackingModalOpen() {
            const modal = document.getElementById('trackingModal');
            return modal && modal.classList.contains('active');
        }

        // ===== WALLET STATE =====
        const DEFAULT_WALLET_STATE = {
            balance: WELCOME_BONUS,
            loyaltyPoints: 0,
            transactions: [],
            pendingRecharges: 0,
            rechargeAmount: '',
            rechargeMethod: 'Orange Money',
            currentScreen: 'dashboard',
            userPhone: '',
            clientId: null,
            isNewUser: true
        };

        let walletState = { ...DEFAULT_WALLET_STATE };

        // ===== VARIABLES GLOBALES =====
        let map, trackingMap, trafficLayer, autocomplete, geocoder;
        let directionsService, directionsRenderer;
        
        // ‚úÖ NOUVEAU: DirectionsRenderer s√©par√© pour le tracking avec couleur verte
        let trackingDirectionsService, trackingDirectionsRenderer;
        
        let userMarker, departureMarker, destinationMarker, driverMarker, clientPickupMarker;
        let selectedVehicle = null, selectedVehiclePrice = 0, selectedPayment = null;
        let mapSelectionMode = null;
        let departureCoords = null, destinationCoords = null;
        let currentBooking = null;
        let reservationListener = null, driverListener = null;
        let lastDriverPosition = null;
        let currentTrackingMode = 'approche';
        let evaluationData = { noteGlobale: 0, conduite: 0, ponctualite: 0, proprete: 0, amabilite: 0, commentaire: '' };
        let driverPhotoUrl = null;
        let paymentValidated = false, paymentProcessing = false;
        let globalRechargeListener = null;

        // ===== PERSISTANCE PORTEFEUILLE =====
        function saveWalletToLocalStorage() {
            try {
                const dataToSave = {
                    balance: walletState.balance,
                    loyaltyPoints: walletState.loyaltyPoints,
                    transactions: walletState.transactions.slice(0, 100),
                    lastUpdate: new Date().toISOString(),
                    isNewUser: false,
                    version: '3.9'
                };
                localStorage.setItem(WALLET_STORAGE_KEY, JSON.stringify(dataToSave));
                return true;
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde:', error);
                return false;
            }
        }

        function loadWalletFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(WALLET_STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (typeof data.balance === 'number' && !isNaN(data.balance)) walletState.balance = data.balance;
                    if (typeof data.loyaltyPoints === 'number') walletState.loyaltyPoints = data.loyaltyPoints;
                    if (Array.isArray(data.transactions)) walletState.transactions = data.transactions;
                    walletState.isNewUser = false;
                    return true;
                } else {
                    walletState.balance = WELCOME_BONUS;
                    walletState.transactions = [{
                        id: 'welcome_bonus_' + Date.now(),
                        date: new Date().toISOString(),
                        type: 'bonus',
                        amount: WELCOME_BONUS,
                        description: 'Bonus de bienvenue',
                        status: 'completed'
                    }];
                    walletState.isNewUser = true;
                    saveWalletToLocalStorage();
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement:', error);
                return false;
            }
        }

        // ===== INITIALISATION =====
        window.addEventListener('load', () => {
            loadWalletFromLocalStorage();
            updateWalletBalanceDisplay();
            checkLogin();
            initEvaluationListeners();
            setTimeout(() => {
                syncValidatedRecharges();
                startGlobalRechargeListener();
            }, 1000);
        });

        // ===== SYNC & RECHARGES (inchang√©) =====
        async function syncValidatedRecharges() {
            const userPhone = getUserPhone();
            if (!userPhone) return;
            
            try {
                const snapshot = await db.collection('recharges')
                    .where('clientTelephone', '==', userPhone)
                    .where('status', '==', 'validated')
                    .get();

                let newCount = 0, totalNew = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const alreadyProcessed = walletState.transactions.some(t => t.type === 'recharge' && t.id === doc.id);
                    if (!alreadyProcessed) {
                        walletState.balance += data.amount;
                        walletState.transactions.unshift({
                            id: doc.id,
                            date: data.validatedAt?.toDate?.()?.toISOString() || new Date().toISOString(),
                            type: 'recharge',
                            amount: data.amount,
                            method: data.source,
                            status: 'completed'
                        });
                        newCount++;
                        totalNew += data.amount;
                    }
                });

                if (newCount > 0) {
                    saveWalletToLocalStorage();
                    updateWalletBalanceDisplay();
                    showNotification(`‚úÖ ${newCount} recharge(s) cr√©dit√©e(s)! +${totalNew.toLocaleString()} FCFA`, 'success');
                }
            } catch (error) {
                console.error('‚ùå Erreur sync:', error);
            }
        }

        function startGlobalRechargeListener() {
            const userPhone = getUserPhone();
            if (!userPhone) return;

            if (globalRechargeListener) {
                globalRechargeListener();
                globalRechargeListener = null;
            }

            globalRechargeListener = db.collection('recharges')
                .where('clientTelephone', '==', userPhone)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        const data = change.doc.data();
                        if (change.type === 'modified' && data.status === 'validated') {
                            const alreadyProcessed = walletState.transactions.some(t => t.type === 'recharge' && t.id === change.doc.id);
                            if (!alreadyProcessed) {
                                walletState.balance += data.amount;
                                walletState.transactions.unshift({
                                    id: change.doc.id,
                                    date: new Date().toISOString(),
                                    type: 'recharge',
                                    amount: data.amount,
                                    method: data.source,
                                    status: 'completed'
                                });
                                saveWalletToLocalStorage();
                                updateWalletBalanceDisplay();
                                if (walletState.currentScreen === 'dashboard') renderWalletDashboard();
                                showNotification(`‚úÖ Recharge valid√©e! +${data.amount.toLocaleString()} FCFA`, 'success');
                            }
                        }
                    });
                    walletState.pendingRecharges = snapshot.docs.filter(doc => doc.data().status === 'pending').length;
                });
        }

        // ===== LOGIN (inchang√©) =====
        function checkLogin() {
            const savedPhone = localStorage.getItem('albourakh_phone');
            const savedName = localStorage.getItem('albourakh_name');
            if (!savedPhone) {
                document.getElementById('loginModal').style.display = 'flex';
                return false;
            }
            walletState.userPhone = savedPhone;
            if (savedName) {
                const nameEl = document.getElementById('bookingName');
                const phoneEl = document.getElementById('bookingPhone');
                if (nameEl) nameEl.value = savedName;
                if (phoneEl) phoneEl.value = savedPhone;
            }
            return true;
        }

        function submitLogin() {
            const phone = document.getElementById('loginPhone').value.trim();
            const name = document.getElementById('loginName').value.trim();
            if (!phone) { showNotification('‚ö†Ô∏è T√©l√©phone requis', 'error'); return; }
            
            localStorage.setItem('albourakh_phone', phone);
            if (name) localStorage.setItem('albourakh_name', name);
            
            walletState.userPhone = phone;
            const phoneEl = document.getElementById('bookingPhone');
            const nameEl = document.getElementById('bookingName');
            if (phoneEl) phoneEl.value = phone;
            if (name && nameEl) nameEl.value = name;
            
            document.getElementById('loginModal').style.display = 'none';
            
            if (walletState.isNewUser) {
                showNotification(`üéÅ Bienvenue! ${WELCOME_BONUS} FCFA offerts!`, 'success');
            } else {
                showNotification('‚úÖ Connexion r√©ussie!', 'success');
            }
        }

        function getUserPhone() {
            if (!walletState.userPhone) {
                const phoneEl = document.getElementById('bookingPhone');
                if (phoneEl && phoneEl.value.trim()) walletState.userPhone = phoneEl.value.trim();
            }
            return walletState.userPhone;
        }

        // ===== EVALUATION (inchang√©) =====
        function initEvaluationListeners() {
            document.querySelectorAll('#overallRating .star').forEach(star => {
                star.addEventListener('click', () => {
                    evaluationData.noteGlobale = parseInt(star.dataset.rating);
                    updateOverallStars(evaluationData.noteGlobale);
                    updateSubmitButton();
                });
            });
            
            document.querySelectorAll('.criteria-star').forEach(star => {
                star.addEventListener('click', () => {
                    const criteria = star.dataset.criteria;
                    const rating = parseInt(star.dataset.rating);
                    evaluationData[criteria] = rating;
                    updateCriteriaStars(criteria, rating);
                    updateSubmitButton();
                });
            });
            
            const commentEl = document.getElementById('evaluationComment');
            if (commentEl) {
                commentEl.addEventListener('input', (e) => {
                    safeSetText('commentLength', e.target.value.length);
                    evaluationData.commentaire = e.target.value;
                });
            }
            
            const submitBtn = document.getElementById('submitEvaluationBtn');
            if (submitBtn) submitBtn.addEventListener('click', submitEvaluation);
        }

        function updateOverallStars(rating) {
            const stars = document.querySelectorAll('#overallRating .star');
            const labels = ['Tr√®s mauvais', 'Mauvais', 'Moyen', 'Bon', 'Excellent'];
            stars.forEach(star => star.classList.toggle('active', parseInt(star.dataset.rating) <= rating));
            safeSetText('overallRatingLabel', labels[rating - 1] || 'S√©lectionnez une note');
        }

        function updateCriteriaStars(criteria, rating) {
            document.querySelectorAll(`#${criteria}Rating .criteria-star`).forEach(star => {
                star.classList.toggle('active', parseInt(star.dataset.rating) <= rating);
            });
            safeSetText(`${criteria}Value`, `${rating}/5`);
        }

        function updateSubmitButton() {
            const btn = document.getElementById('submitEvaluationBtn');
            if (btn) btn.disabled = evaluationData.noteGlobale === 0;
        }

        function openEvaluationModal() {
            if (!currentBooking) return;
            
            safeSetText('evalDriverName', currentBooking.nomChauffeur || 'Votre chauffeur');
            
            const avatarEl = document.getElementById('evalDriverAvatar');
            if (avatarEl) {
                avatarEl.innerHTML = driverPhotoUrl ? 
                    `<img src="${driverPhotoUrl}" alt="Chauffeur" onerror="this.parentElement.innerHTML='üë§'">` : 'üë§';
            }
            
            let vehiculeText = '';
            const marque = currentBooking.vehiculeMarque;
            const modele = currentBooking.vehiculeModele;
            const immat = currentBooking.immatriculation;
            
            if (marque && marque !== 'V√©hicule') {
                vehiculeText = modele ? `${marque} ${modele}` : marque;
                if (immat && immat !== 'DK-XXXX-XX') vehiculeText += ` ‚Ä¢ ${immat}`;
            } else {
                const typeNames = { standard: 'üöó Standard', confort: '‚ú® Confort', van: 'üöê Van', premium: 'üëë Premium' };
                vehiculeText = typeNames[currentBooking.vehiculeType] || 'V√©hicule';
            }
            safeSetText('evalVehicle', vehiculeText);
            
            evaluationData = { noteGlobale: 0, conduite: 0, ponctualite: 0, proprete: 0, amabilite: 0, commentaire: '' };
            document.querySelectorAll('.star, .criteria-star').forEach(s => s.classList.remove('active'));
            safeSetText('overallRatingLabel', 'S√©lectionnez une note');
            document.querySelectorAll('.criteria-value').forEach(v => v.textContent = '-');
            
            const commentEl = document.getElementById('evaluationComment');
            if (commentEl) commentEl.value = '';
            safeSetText('commentLength', '0');
            
            const submitBtn = document.getElementById('submitEvaluationBtn');
            if (submitBtn) submitBtn.disabled = true;
            
            const modal = document.getElementById('evaluationModal');
            if (modal) modal.classList.add('active');
        }

        function closeEvaluationModal() {
            const modal = document.getElementById('evaluationModal');
            if (modal) modal.classList.remove('active');
        }

        function skipEvaluation() {
            closeEvaluationModal();
            closeTracking();
            showNotification('√âvaluation ignor√©e', 'info');
            currentBooking = null;
        }

        async function submitEvaluation() {
            if (evaluationData.noteGlobale === 0) { showNotification('‚ö†Ô∏è Veuillez noter', 'error'); return; }
            
            const submitBtn = document.getElementById('submitEvaluationBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi...';
            }
            
            try {
                const evaluationRef = await db.collection('evaluations').add({
                    reservationId: currentBooking.id,
                    chauffeurId: currentBooking.chauffeurAssigne,
                    nomChauffeur: currentBooking.nomChauffeur || 'Chauffeur',
                    clientNom: currentBooking.clientNom || 'Client',
                    clientTelephone: currentBooking.clientTelephone || '',
                    noteGlobale: evaluationData.noteGlobale,
                    conduite: evaluationData.conduite || 0,
                    ponctualite: evaluationData.ponctualite || 0,
                    proprete: evaluationData.proprete || 0,
                    amabilite: evaluationData.amabilite || 0,
                    commentaire: evaluationData.commentaire.trim(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    depart: currentBooking.depart,
                    destination: currentBooking.destination,
                    vehiculeType: currentBooking.vehiculeType
                });
                
                await db.collection('reservations').doc(currentBooking.id).update({
                    evaluee: true,
                    evaluationId: evaluationRef.id,
                    dateEvaluation: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (currentBooking.chauffeurAssigne) await updateDriverRating(currentBooking.chauffeurAssigne);
                
                if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-check"></i> Envoy√©!';
                showNotification('‚úÖ Merci pour votre √©valuation!', 'success');
                
                setTimeout(() => { closeEvaluationModal(); closeTracking(); currentBooking = null; }, 1500);
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                showNotification('‚ùå Erreur: ' + error.message, 'error');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Envoyer';
                }
            }
        }

        async function updateDriverRating(driverId) {
            try {
                const snapshot = await db.collection('evaluations').where('chauffeurId', '==', driverId).get();
                if (snapshot.empty) return;
                let total = 0, count = 0;
                snapshot.forEach(doc => { total += doc.data().noteGlobale || 0; count++; });
                await db.collection('drivers').doc(driverId).update({
                    rating: parseFloat((total / count).toFixed(1)),
                    nombreEvaluations: count
                });
            } catch (error) {
                console.error('‚ùå Erreur rating:', error);
            }
        }

        // ===== PAYMENT (inchang√©) =====
        async function validatePayment() {
            if (!currentBooking || paymentProcessing || paymentValidated) return;
            
            const paymentMethod = currentBooking.modePaiement || selectedPayment;
            
            if (!isDigitalPayment(paymentMethod)) {
                showNotification('‚ÑπÔ∏è Paiement esp√®ces - Aucune validation', 'info');
                setTimeout(() => openEvaluationModal(), 1000);
                return;
            }

            const amount = currentBooking.prixEstime || 0;
            const driverShare = Math.round(amount * DRIVER_RATE);

            if ((paymentMethod === 'wallet' || paymentMethod === 'Portefeuille Al Bourakh') && walletState.balance < amount) {
                showNotification(`‚ùå Solde insuffisant (${walletState.balance.toLocaleString()} FCFA)`, 'error');
                return;
            }

            if (!confirm(`Confirmer le paiement de ${amount.toLocaleString()} FCFA?`)) return;

            paymentProcessing = true;
            const btn = document.getElementById('validatePaymentBtn');
            
            if (btn) {
                btn.classList.add('processing');
                btn.disabled = true;
            }
            safeSetHtml('validatePaymentText', '<i class="fas fa-spinner fa-spin"></i> Traitement...');
            showLoading('Validation du paiement...');

            try {
                if (paymentMethod === 'wallet' || paymentMethod === 'Portefeuille Al Bourakh') {
                    walletState.balance -= amount;
                    walletState.transactions.unshift({
                        id: 'ride_' + Date.now(),
                        date: new Date().toISOString(),
                        type: 'ride',
                        amount: amount,
                        depart: currentBooking.depart,
                        destination: currentBooking.destination,
                        status: 'completed'
                    });
                    saveWalletToLocalStorage();
                    updateWalletBalanceDisplay();
                }

                await db.collection('reservations').doc(currentBooking.id).update({
                    paiementValide: true,
                    datePaiement: firebase.firestore.FieldValue.serverTimestamp(),
                    montantPaye: amount,
                    partChauffeur: driverShare,
                    paiementStatut: 'completed'
                });

                if (currentBooking.chauffeurAssigne) {
                    await db.collection('drivers').doc(currentBooking.chauffeurAssigne).update({
                        soldeDisponible: firebase.firestore.FieldValue.increment(driverShare),
                        revenusTotal: firebase.firestore.FieldValue.increment(driverShare)
                    });
                }

                hideLoading();
                
                paymentValidated = true;
                if (btn) {
                    btn.classList.remove('processing');
                    btn.classList.add('success');
                }
                safeSetHtml('validatePaymentText', '<i class="fas fa-check"></i> Paiement valid√©!');

                safeAddClass('step6Icon', 'active');
                safeSetText('step6Text', 'Paiement effectu√© ‚úì');
                safeSetText('step6Time', new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));

                showNotification(`‚úÖ Paiement valid√©! -${amount.toLocaleString()} FCFA`, 'success');
                safeSetStyle('cancelBookingBtn', 'display', 'none');

                setTimeout(() => openEvaluationModal(), 2000);

            } catch (error) {
                console.error('‚ùå Erreur paiement:', error);
                hideLoading();
                
                if (paymentMethod === 'wallet' || paymentMethod === 'Portefeuille Al Bourakh') {
                    walletState.balance += amount;
                    walletState.transactions.shift();
                    saveWalletToLocalStorage();
                    updateWalletBalanceDisplay();
                }

                if (btn) {
                    btn.classList.remove('processing');
                    btn.disabled = false;
                }
                safeSetHtml('validatePaymentText', '<i class="fas fa-check-circle"></i> Valider le paiement');
                showNotification('‚ùå Erreur: ' + error.message, 'error');
            } finally {
                paymentProcessing = false;
            }
        }

        function isDigitalPayment(method) {
            return ['orange', 'wave', 'wallet', 'Orange Money', 'Wave', 'Portefeuille Al Bourakh'].includes(method);
        }

        // ===== WALLET FUNCTIONS (inchang√© - abr√©g√©) =====
        function openWallet() {
            const modal = document.getElementById('walletModal');
            if (modal) modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            showWalletScreen('dashboard');
        }

        function closeWallet() {
            const modal = document.getElementById('walletModal');
            if (modal) modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function showWalletScreen(screen) {
            walletState.currentScreen = screen;
            document.querySelectorAll('.wallet-screen').forEach(s => s.classList.remove('active'));
            
            const backBtn = document.getElementById('walletBackBtn');
            
            if (screen === 'dashboard') {
                if (backBtn) backBtn.classList.add('hidden');
                safeSetText('walletTitle', 'Mon Portefeuille');
                renderWalletDashboard();
            } else if (screen === 'recharge') {
                if (backBtn) backBtn.classList.remove('hidden');
                safeSetText('walletTitle', 'Recharger');
                renderWalletRecharge();
            } else if (screen === 'history') {
                if (backBtn) backBtn.classList.remove('hidden');
                safeSetText('walletTitle', 'Historique');
                renderWalletHistory();
            }
            
            const screenEl = document.getElementById(`wallet${screen.charAt(0).toUpperCase() + screen.slice(1)}`);
            if (screenEl) screenEl.classList.add('active');
        }

        function renderWalletDashboard() {
            const totalSpent = walletState.transactions.filter(t => t.type === 'ride').reduce((sum, t) => sum + (t.amount || 0), 0);
            const rideCount = walletState.transactions.filter(t => t.type === 'ride').length;

            safeSetHtml('walletDashboard', `
                <div class="wallet-card">
                    <div class="wallet-card-header">
                        <div>
                            <p class="wallet-label">Portefeuille Al Bourakh</p>
                            <h2 class="wallet-amount">${walletState.balance.toLocaleString()} FCFA</h2>
                        </div>
                        <div style="font-size: 2rem;">üí≥</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet primary" onclick="showWalletScreen('recharge')"><i class="fas fa-plus"></i> Recharger</button>
                        <button class="btn-wallet secondary" onclick="closeWallet(); scrollToBooking();"><i class="fas fa-car"></i> R√©server</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-content"><div class="stat-icon green">üìà</div><div><p class="stat-label">Courses</p><p class="stat-value">${rideCount}</p></div></div></div>
                    <div class="stat-card"><div class="stat-content"><div class="stat-icon purple">üí∞</div><div><p class="stat-label">D√©penses</p><p class="stat-value">${totalSpent.toLocaleString()}</p></div></div></div>
                    <div class="stat-card"><div class="stat-content"><div class="stat-icon orange">üìä</div><div><p class="stat-label">Transactions</p><p class="stat-value">${walletState.transactions.length}</p></div></div></div>
                </div>
            `);
        }

        function renderWalletRecharge() {
            walletState.rechargeAmount = '';
            safeSetHtml('walletRecharge', `
                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem;">Montant</h3>
                    <div class="amount-input-container">
                        <input type="number" id="rechargeAmountInput" class="amount-input" placeholder="0" oninput="walletState.rechargeAmount = this.value;">
                        <span class="amount-currency">FCFA</span>
                    </div>
                    <div class="quick-amounts">
                        ${[1000, 2000, 5000, 10000].map(amt => `
                            <button class="quick-amount-btn" onclick="document.getElementById('rechargeAmountInput').value = ${amt}; walletState.rechargeAmount = '${amt}';">${amt.toLocaleString()} FCFA</button>
                        `).join('')}
                    </div>
                </div>
                <button class="btn-primary-wallet" onclick="processWalletRecharge()"><i class="fas fa-paper-plane"></i> Envoyer la demande</button>
            `);
        }

        function renderWalletHistory() {
            const transactions = walletState.transactions.slice(0, 20);
            let html = '<div class="card">';
            if (transactions.length === 0) {
                html += '<p style="text-align: center; color: #666; padding: 20px;">Aucune transaction</p>';
            } else {
                html += '<div class="transaction-list">';
                transactions.forEach(t => {
                    const isDebit = t.type === 'ride';
                    const color = isDebit ? '#E30613' : '#16a34a';
                    const prefix = isDebit ? '-' : '+';
                    const date = new Date(t.date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
                    html += `<div class="transaction-item"><div class="transaction-header"><span>${t.type === 'ride' ? 'üöó Course' : 'üí∞ Recharge'}</span><span style="color:${color}">${prefix}${t.amount.toLocaleString()} FCFA</span></div><div class="transaction-date">${date}</div></div>`;
                });
                html += '</div>';
            }
            html += '</div>';
            safeSetHtml('walletHistory', html);
        }

        async function processWalletRecharge() {
            const amount = parseInt(walletState.rechargeAmount);
            if (!amount || amount <= 0) { showNotification('‚ö†Ô∏è Montant invalide', 'error'); return; }
            const userPhone = getUserPhone();
            if (!userPhone) { showNotification('‚ö†Ô∏è T√©l√©phone requis', 'error'); return; }
            showLoading('Envoi de la demande...');
            try {
                await db.collection('recharges').add({
                    clientTelephone: userPhone,
                    clientNom: document.getElementById('bookingName')?.value?.trim() || 'Client',
                    amount: amount,
                    source: walletState.rechargeMethod,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                hideLoading();
                showNotification('‚úÖ Demande envoy√©e!', 'success');
                showWalletScreen('dashboard');
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function updateWalletBalanceDisplay() {
            safeSetText('walletBalanceMini', walletState.balance.toLocaleString() + ' FCFA');
        }

        // ===== GOOGLE MAPS =====
        function initMap() {
            const dakar = { lat: 14.6937, lng: -17.4441 };
            map = new google.maps.Map(document.getElementById('map'), { center: dakar, zoom: 12, disableDefaultUI: true, zoomControl: true });
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#00A854', strokeWeight: 5 } });
            trafficLayer = new google.maps.TrafficLayer();
            
            const searchEl = document.getElementById('searchInput');
            if (searchEl) {
                autocomplete = new google.maps.places.Autocomplete(searchEl, { componentRestrictions: { country: 'sn' } });
                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place.geometry) { map.setCenter(place.geometry.location); map.setZoom(15); }
                });
            }
            
            initBookingAutocomplete();
            map.addListener('click', handleMapClick);
            autoDetectLocation();
            initDateTime();
            updateWalletBalanceDisplay();
            console.log('‚úÖ Map initialized');
        }

        function initBookingAutocomplete() {
            const fromEl = document.getElementById('bookingFrom');
            const toEl = document.getElementById('bookingTo');
            
            if (fromEl) {
                const autocompleteFrom = new google.maps.places.Autocomplete(fromEl, { componentRestrictions: { country: 'sn' } });
                autocompleteFrom.addListener('place_changed', () => {
                    const place = autocompleteFrom.getPlace();
                    if (place.geometry) {
                        departureCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                        updateMarker('departure', departureCoords);
                        calculateRoute();
                    }
                });
            }
            
            if (toEl) {
                const autocompleteTo = new google.maps.places.Autocomplete(toEl, { componentRestrictions: { country: 'sn' } });
                autocompleteTo.addListener('place_changed', () => {
                    const place = autocompleteTo.getPlace();
                    if (place.geometry) {
                        destinationCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                        updateMarker('destination', destinationCoords);
                        calculateRoute();
                    }
                });
            }
        }

        function autoDetectLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    departureCoords = userPos;
                    map.setCenter(userPos);
                    map.setZoom(14);
                    geocoder.geocode({ location: userPos }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            const fromEl = document.getElementById('bookingFrom');
                            if (fromEl) fromEl.value = results[0].formatted_address;
                            updateMarker('departure', userPos);
                        }
                    });
                });
            }
        }

        function getCurrentPosition() {
            const gpsBtn = event.currentTarget;
            if (!navigator.geolocation) { showNotification('‚ùå G√©olocalisation non disponible', 'error'); return; }

            gpsBtn.classList.add('loading');
            gpsBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
                    departureCoords = userPos;
                    map.setCenter(userPos);
                    map.setZoom(16);
                    
                    geocoder.geocode({ location: userPos }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            const fromEl = document.getElementById('bookingFrom');
                            if (fromEl) fromEl.value = results[0].formatted_address;
                            updateMarker('departure', userPos);
                            if (destinationCoords) calculateRoute();
                            
                            gpsBtn.classList.remove('loading');
                            gpsBtn.classList.add('success');
                            gpsBtn.disabled = false;
                            showNotification('‚úÖ Position d√©tect√©e', 'success');
                            setTimeout(() => gpsBtn.classList.remove('success'), 2000);
                        }
                    });
                },
                () => {
                    gpsBtn.classList.remove('loading');
                    gpsBtn.disabled = false;
                    showNotification('‚ùå Erreur de localisation', 'error');
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        }

        function initDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            const dateEl = document.getElementById('bookingDate');
            const timeEl = document.getElementById('bookingTime');
            if (dateEl) {
                dateEl.min = new Date().toISOString().split('T')[0];
                dateEl.value = now.toISOString().split('T')[0];
            }
            if (timeEl) timeEl.value = now.toTimeString().slice(0, 5);
        }

        function findMyLocation() {
            if (navigator.geolocation) {
                showNotification('üìç Localisation...', 'info');
                navigator.geolocation.getCurrentPosition((pos) => {
                    const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.setCenter(userPos);
                    map.setZoom(16);
                    if (userMarker) userMarker.setMap(null);
                    userMarker = new google.maps.Marker({
                        position: userPos, map: map,
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 3 },
                        animation: google.maps.Animation.BOUNCE
                    });
                    setTimeout(() => userMarker.setAnimation(null), 2000);
                    showNotification('‚úÖ Position trouv√©e', 'success');
                });
            }
        }

        function toggleTraffic() {
            if (trafficLayer.getMap()) { trafficLayer.setMap(null); showNotification('üö¶ Trafic d√©sactiv√©', 'info'); }
            else { trafficLayer.setMap(map); showNotification('üö¶ Trafic activ√©', 'success'); }
        }

        function selectOnMap(type) {
            mapSelectionMode = type;
            showNotification(`üó∫Ô∏è Cliquez sur la carte pour ${type === 'from' ? 'le d√©part' : 'la destination'}`, 'info');
            map.getDiv().style.cursor = 'crosshair';
            document.querySelector('.map-container')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function handleMapClick(event) {
            if (!mapSelectionMode) return;
            const location = event.latLng;
            geocoder.geocode({ location: location }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    if (mapSelectionMode === 'from') {
                        const fromEl = document.getElementById('bookingFrom');
                        if (fromEl) fromEl.value = results[0].formatted_address;
                        departureCoords = { lat: location.lat(), lng: location.lng() };
                        updateMarker('departure', departureCoords);
                    } else {
                        const toEl = document.getElementById('bookingTo');
                        if (toEl) toEl.value = results[0].formatted_address;
                        destinationCoords = { lat: location.lat(), lng: location.lng() };
                        updateMarker('destination', destinationCoords);
                    }
                    calculateRoute();
                    showNotification(`‚úÖ ${mapSelectionMode === 'from' ? 'D√©part' : 'Destination'} s√©lectionn√©`, 'success');
                }
                mapSelectionMode = null;
                map.getDiv().style.cursor = '';
            });
        }

        function updateMarker(type, coords) {
            if (type === 'departure') {
                if (departureMarker) departureMarker.setMap(null);
                departureMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 12, fillColor: '#4CAF50', fillOpacity: 1, strokeColor: 'white', strokeWeight: 3 }, label: { text: 'A', color: 'white', fontWeight: 'bold' } });
            } else {
                if (destinationMarker) destinationMarker.setMap(null);
                destinationMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 12, fillColor: '#E30613', fillOpacity: 1, strokeColor: 'white', strokeWeight: 3 }, label: { text: 'B', color: 'white', fontWeight: 'bold' } });
            }
        }

        function calculateRoute() {
            if (!departureCoords || !destinationCoords) return;
            directionsService.route({ origin: departureCoords, destination: destinationCoords, travelMode: google.maps.TravelMode.DRIVING }, (result, status) => {
                if (status === 'OK') directionsRenderer.setDirections(result);
            });
        }

        // ===== BOOKING (inchang√©) =====
        function selectVehicle(type, price) {
            selectedVehicle = type;
            selectedVehiclePrice = price;
            document.querySelectorAll('.vehicle-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            showNotification(`‚úÖ V√©hicule: ${type}`, 'success');
        }

        function selectPayment(method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            const names = { cash: 'Esp√®ces', orange: 'Orange Money', wave: 'Wave', wallet: 'Portefeuille' };
            showNotification(`‚úÖ Paiement: ${names[method]}`, 'success');
        }

        function calculateDistance(p1, p2) {
            const R = 6371;
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLon = (p2.lng - p1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function previewBooking() {
            const from = document.getElementById('bookingFrom')?.value?.trim();
            const to = document.getElementById('bookingTo')?.value?.trim();
            const date = document.getElementById('bookingDate')?.value;
            const time = document.getElementById('bookingTime')?.value;
            const phone = document.getElementById('bookingPhone')?.value?.trim();

            if (!phone) { showNotification('‚ö†Ô∏è Connectez-vous', 'error'); document.getElementById('loginModal').style.display = 'flex'; return; }
            if (!from || !to || !date || !time) { showNotification('‚ö†Ô∏è Remplissez tous les champs', 'error'); return; }
            if (!selectedVehicle) { showNotification('‚ö†Ô∏è S√©lectionnez un v√©hicule', 'error'); return; }
            if (!selectedPayment) { showNotification('‚ö†Ô∏è S√©lectionnez un paiement', 'error'); return; }

            let distance = 10;
            if (departureCoords && destinationCoords) distance = calculateDistance(departureCoords, destinationCoords);
            const pricePerKm = { standard: 200, confort: 250, van: 300, premium: 400 };
            const totalPrice = Math.round(selectedVehiclePrice + (distance * pricePerKm[selectedVehicle]));

            if (selectedPayment === 'wallet' && walletState.balance < totalPrice) {
                showNotification(`‚ö†Ô∏è Solde insuffisant (${walletState.balance.toLocaleString()} FCFA)`, 'error');
                return;
            }

            const vehicleNames = { standard: 'üöó Standard', confort: '‚ú® Confort', van: 'üöê Van', premium: 'üëë Premium' };
            const paymentNames = { cash: 'üíµ Esp√®ces', orange: 'üì± Orange Money', wave: 'üí≥ Wave', wallet: 'üëõ Portefeuille' };

            safeSetText('summaryRoute', `${from.substring(0, 15)}... ‚Üí ${to.substring(0, 15)}...`);
            safeSetText('summaryDateTime', `${date} ${time}`);
            safeSetText('summaryVehicle', vehicleNames[selectedVehicle]);
            safeSetText('summaryPayment', paymentNames[selectedPayment]);
            safeSetText('summaryTotal', `${totalPrice.toLocaleString()} FCFA`);

            const summary = document.getElementById('bookingSummary');
            if (summary) {
                summary.style.display = 'block';
                summary.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function confirmBooking() {
            const summary = document.getElementById('bookingSummary');
            if (!summary || summary.style.display === 'none') { showNotification('‚ö†Ô∏è Cliquez sur Aper√ßu', 'error'); return; }

            const phone = getUserPhone();
            if (!phone) { showNotification('‚ö†Ô∏è Connectez-vous', 'error'); document.getElementById('loginModal').style.display = 'flex'; return; }

            const totalText = document.getElementById('summaryTotal')?.textContent || '0';
            const totalPrice = parseInt(totalText.replace(/\D/g, ''));
            showLoading('Enregistrement...');

            const paymentMethodNames = { 'cash': 'Esp√®ces', 'orange': 'Orange Money', 'wave': 'Wave', 'wallet': 'Portefeuille Al Bourakh' };

            const bookingData = {
                clientNom: document.getElementById('bookingName')?.value?.trim() || 'Client',
                clientTelephone: phone,
                depart: document.getElementById('bookingFrom')?.value?.trim(),
                destination: document.getElementById('bookingTo')?.value?.trim(),
                departCoords: departureCoords,
                destinationCoords: destinationCoords,
                dateReservation: document.getElementById('bookingDate')?.value,
                heureReservation: document.getElementById('bookingTime')?.value,
                vehiculeType: selectedVehicle,
                modePaiement: paymentMethodNames[selectedPayment],
                prixEstime: totalPrice,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                statut: 'en_attente',
                paiementValide: false,
                chauffeurAssigne: null
            };

            try {
                const docRef = await db.collection('reservations').add(bookingData);
                currentBooking = { id: docRef.id, ...bookingData };
                paymentValidated = false;
                hideLoading();
                showNotification('‚úÖ R√©servation confirm√©e!', 'success');
                openTracking();
                startReservationListener(docRef.id);
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // ===== ‚úÖ TRACKING CORRIG√â - TRAJET D'APPROCHE VISIBLE =====
        function openTracking() {
            const modal = document.getElementById('trackingModal');
            if (modal) modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            if (currentBooking) {
                safeSetText('tripFrom', currentBooking.depart || '-');
                safeSetText('tripTo', currentBooking.destination || '-');
                safeSetText('tripPrice', (currentBooking.prixEstime || 0).toLocaleString() + ' FCFA');
            }
            safeSetText('step1Time', new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
            
            hidePaymentButton();
            safeSetStyle('cancelBookingBtn', 'display', 'block');
            currentTrackingMode = 'approche';
            
            // ‚úÖ Initialiser la carte apr√®s un d√©lai pour que le modal soit visible
            setTimeout(() => initTrackingMap(), 400);
        }

        function closeTracking() {
            const modal = document.getElementById('trackingModal');
            if (modal) modal.classList.remove('active');
            document.body.style.overflow = '';
            if (reservationListener) { reservationListener(); reservationListener = null; }
            if (driverListener) { driverListener(); driverListener = null; }
            
            // ‚úÖ Nettoyer les ressources de la carte
            if (trackingDirectionsRenderer) {
                trackingDirectionsRenderer.setMap(null);
                trackingDirectionsRenderer = null;
            }
            trackingMap = null;
            driverMarker = null;
            clientPickupMarker = null;
        }

        // ‚úÖ NOUVELLE FONCTION: initTrackingMap AVEC G√âOCODAGE AUTOMATIQUE
        async function initTrackingMap() {
            const mapEl = document.getElementById('trackingMap');
            if (!mapEl) {
                console.log('‚ö†Ô∏è Element trackingMap non trouv√©');
                return;
            }
            
            console.log('üó∫Ô∏è Initialisation carte de suivi...');
            console.log('üìç Donn√©es booking:', currentBooking);
            
            // ‚úÖ √âTAPE 1: Obtenir les coordonn√©es du client (g√©ocodage si n√©cessaire)
            let clientCoords = null;
            
            // V√©rifier si les coordonn√©es existent d√©j√†
            if (currentBooking?.departCoords) {
                // G√©rer les diff√©rents formats de coordonn√©es (Firebase GeoPoint ou objet simple)
                if (currentBooking.departCoords.latitude !== undefined) {
                    clientCoords = {
                        lat: currentBooking.departCoords.latitude,
                        lng: currentBooking.departCoords.longitude
                    };
                } else if (currentBooking.departCoords.lat !== undefined) {
                    clientCoords = {
                        lat: currentBooking.departCoords.lat,
                        lng: currentBooking.departCoords.lng
                    };
                }
                console.log('‚úÖ Coordonn√©es client trouv√©es:', clientCoords);
            }
            
            // Si pas de coordonn√©es, g√©ocoder l'adresse texte
            if (!clientCoords && currentBooking?.depart) {
                console.log('üìç G√©ocodage de l\'adresse:', currentBooking.depart);
                try {
                    clientCoords = await geocodeAddress(currentBooking.depart);
                    if (clientCoords) {
                        console.log('‚úÖ Coordonn√©es g√©ocod√©es:', clientCoords);
                        // Sauvegarder dans currentBooking pour utilisation ult√©rieure
                        currentBooking.departCoords = clientCoords;
                    }
                } catch (error) {
                    console.error('‚ùå Erreur g√©ocodage:', error);
                }
            }
            
            // Si toujours pas de coordonn√©es, utiliser Dakar par d√©faut
            if (!clientCoords) {
                console.log('‚ö†Ô∏è Utilisation des coordonn√©es par d√©faut (Dakar)');
                clientCoords = { lat: 14.6937, lng: -17.4441 };
                currentBooking.departCoords = clientCoords;
            }
            
            // ‚úÖ √âTAPE 2: Cr√©er la carte
            trackingMap = new google.maps.Map(mapEl, { 
                center: clientCoords, 
                zoom: 14, 
                disableDefaultUI: true, 
                zoomControl: true,
                styles: [
                    { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }
                ]
            });
            
            // ‚úÖ √âTAPE 3: Cr√©er le DirectionsService ET DirectionsRenderer pour le tracking
            trackingDirectionsService = new google.maps.DirectionsService();
            trackingDirectionsRenderer = new google.maps.DirectionsRenderer({ 
                map: trackingMap, 
                suppressMarkers: true,
                polylineOptions: { 
                    strokeColor: '#22c55e', // VERT pour le trajet d'approche
                    strokeWeight: 6,
                    strokeOpacity: 0.9
                }
            });
            
            // ‚úÖ √âTAPE 4: Marqueur du point de prise en charge (client) - ROUGE
            clientPickupMarker = new google.maps.Marker({ 
                position: clientCoords, 
                map: trackingMap, 
                icon: { 
                    path: google.maps.SymbolPath.CIRCLE, 
                    scale: 14, 
                    fillColor: '#ef4444', 
                    fillOpacity: 1, 
                    strokeColor: 'white', 
                    strokeWeight: 3 
                },
                title: 'Votre position',
                zIndex: 100
            });
            
            // ‚úÖ √âTAPE 5: Label "Vous" au dessus du marqueur
            new google.maps.Marker({
                position: clientCoords,
                map: trackingMap,
                icon: {
                    url: 'data:image/svg+xml,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="26">
                            <rect x="0" y="0" width="50" height="22" rx="11" fill="#ef4444"/>
                            <text x="25" y="15" font-family="Arial" font-size="11" font-weight="bold" fill="white" text-anchor="middle">Vous</text>
                        </svg>
                    `),
                    anchor: new google.maps.Point(25, 38)
                },
                zIndex: 99
            });
            
            console.log('‚úÖ Carte de suivi initialis√©e avec coordonn√©es:', clientCoords);
        }
        
        // ‚úÖ NOUVELLE FONCTION: G√©ocoder une adresse texte en coordonn√©es
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                if (!geocoder) {
                    geocoder = new google.maps.Geocoder();
                }
                
                // Ajouter "S√©n√©gal" si pas d√©j√† pr√©sent pour am√©liorer la pr√©cision
                let searchAddress = address;
                if (!address.toLowerCase().includes('s√©n√©gal') && !address.toLowerCase().includes('senegal') && !address.toLowerCase().includes('dakar')) {
                    searchAddress = address + ', Dakar, S√©n√©gal';
                }
                
                console.log('üîç Recherche g√©ocodage:', searchAddress);
                
                geocoder.geocode({ address: searchAddress }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({
                            lat: location.lat(),
                            lng: location.lng()
                        });
                    } else {
                        console.warn('‚ö†Ô∏è G√©ocodage √©chou√©:', status);
                        reject(new Error('G√©ocodage √©chou√©: ' + status));
                    }
                });
            });
        }

        function startReservationListener(reservationId) {
            reservationListener = db.collection('reservations').doc(reservationId).onSnapshot(async (doc) => {
                if (!doc.exists) return;
                const data = doc.data();
                currentBooking = { id: doc.id, ...data };
                
                updateStatusTimeline(data.statut);
                
                if (data.chauffeurAssigne && !driverListener) {
                    updateStep2(data);
                    startDriverTracking(data.chauffeurAssigne);
                }
                if (data.nomChauffeur) await showDriverCard(data);
            });
        }

        function updateStatusTimeline(statut) {
            console.log('üìä Statut re√ßu:', statut);
            
            if (statut === 'chauffeur_en_route' || statut === 'en_route') {
                safeAddClass('step3Icon', 'active');
                safeRemoveClass('step3Icon', 'current');
                safeSetText('step3Text', 'Le chauffeur est en route');
                safeSetText('step3Time', new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
            }
            
            if (statut === 'chauffeur_arrive' || statut === 'arrive' || statut === 'chauffeur_sur_place') {
                safeAddClass('step4Icon', 'active');
                safeRemoveClass('step3Icon', 'current');
                safeSetText('step4Time', new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
                
                safeSetHtml('driverApproachingBox', `
                    <div class="driver-approaching-title">‚úÖ Chauffeur arriv√© !</div>
                    <div class="driver-eta" style="font-size: 1.5em; margin-top: 10px;">Votre chauffeur vous attend</div>
                    <div class="driver-eta-label" style="margin-top: 8px;">Montez √† bord pour d√©marrer la course</div>
                `);
                
                if (trackingDirectionsRenderer) trackingDirectionsRenderer.setMap(null);
                showNotification('‚úÖ Votre chauffeur est arriv√© !', 'success');
            }
            
            if (statut === 'en_cours' || statut === 'course_en_cours') {
                safeAddClass('step5Icon', 'active');
                safeRemoveClass('step4Icon', 'current');
                safeSetText('step5Time', new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
                currentTrackingMode = 'course';
                
                safeSetHtml('driverApproachingBox', `
                    <div class="driver-approaching-title">üöó Course en cours</div>
                    <div class="driver-eta" style="font-size: 1.5em; margin-top: 10px;">Direction votre destination</div>
                    <div class="driver-eta-label" style="margin-top: 8px;">Bon voyage !</div>
                `);
                
                showNotification('üöó Course en cours - Bon voyage !', 'success');
            }
            
            if (statut === 'terminee') {
                safeAddClass('step5Icon', 'active');
                safeSetHtml('driverApproachingBox', `
                    <div class="driver-approaching-title">üéâ Course termin√©e!</div>
                    <div class="driver-eta" style="font-size: 1.2em;">Validez votre paiement</div>
                `);
                showPaymentButton();
            }
        }

        function startDriverTracking(driverId) {
            if (driverListener) { driverListener(); driverListener = null; }
            
            console.log('üëÅÔ∏è √âcoute de la position du chauffeur:', driverId);
            
            driverListener = db.collection('drivers').doc(driverId).onSnapshot(async (doc) => {
                if (!doc.exists) return;
                if (!isTrackingModalOpen()) return;
                
                const driverData = doc.data();
                
                if (driverData.position?.latitude && driverData.position?.longitude) {
                    const driverPos = { lat: driverData.position.latitude, lng: driverData.position.longitude };
                    lastDriverPosition = driverPos;
                    
                    console.log('üìç Position chauffeur:', driverPos);
                    
                    // ‚úÖ Appeler les fonctions async
                    await updateDriverMarker(driverPos);
                    
                    if (currentTrackingMode === 'approche') {
                        // ‚úÖ CALCUL DU TRAJET D'APPROCHE
                        await calculateApproachRoute(driverPos);
                    }
                    
                    updateStep3();
                }
            });
        }

        // ‚úÖ NOUVEAU: updateDriverMarker avec ic√¥ne voiture
        async function updateDriverMarker(position) {
            if (!trackingMap) return;
            
            if (driverMarker) { 
                driverMarker.setPosition(position);
            } else { 
                // ‚úÖ Cr√©er le marqueur du chauffeur avec une ic√¥ne voiture verte
                driverMarker = new google.maps.Marker({ 
                    position: position, 
                    map: trackingMap, 
                    icon: {
                        url: 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 44 44">
                                <circle cx="22" cy="22" r="20" fill="#22c55e" stroke="#ffffff" stroke-width="3"/>
                                <text x="22" y="28" font-size="20" text-anchor="middle" fill="white">üöó</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(44, 44),
                        anchor: new google.maps.Point(22, 22)
                    },
                    title: currentBooking?.nomChauffeur || 'Chauffeur',
                    zIndex: 200
                });
            }
            
            // Ajuster la vue pour montrer chauffeur et client
            if (trackingMap) {
                const clientCoords = await getClientCoordinates();
                if (clientCoords) {
                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(position);
                    bounds.extend(clientCoords);
                    trackingMap.fitBounds(bounds, { padding: 60 });
                }
            }
        }

        // ‚úÖ NOUVELLE FONCTION: calculateApproachRoute AVEC G√âOCODAGE AUTOMATIQUE
        async function calculateApproachRoute(driverPos) {
            if (!trackingDirectionsService || !trackingDirectionsRenderer) {
                console.log('‚ö†Ô∏è DirectionsService non initialis√©');
                return;
            }
            if (!isTrackingModalOpen()) {
                console.log('‚ö†Ô∏è Modal ferm√©, annulation du calcul');
                return;
            }
            
            // ‚úÖ √âTAPE 1: Obtenir les coordonn√©es du client
            let clientCoords = await getClientCoordinates();
            
            if (!clientCoords) {
                console.log('‚ùå Impossible d\'obtenir les coordonn√©es client');
                return;
            }
            
            console.log('üõ£Ô∏è Calcul du trajet d\'approche...');
            console.log('   Chauffeur:', driverPos);
            console.log('   Client:', clientCoords);
            
            const request = {
                origin: new google.maps.LatLng(driverPos.lat, driverPos.lng),
                destination: new google.maps.LatLng(clientCoords.lat, clientCoords.lng),
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC
            };
            
            trackingDirectionsService.route(request, (result, status) => {
                if (!isTrackingModalOpen()) return;
                
                if (status === google.maps.DirectionsStatus.OK) {
                    console.log('‚úÖ Trajet d\'approche calcul√© avec succ√®s!');
                    
                    // ‚úÖ Afficher le trajet sur la carte
                    trackingDirectionsRenderer.setDirections(result);
                    
                    const leg = result.routes[0].legs[0];
                    
                    // ‚úÖ Mettre √† jour l'ETA
                    const durationMinutes = Math.ceil(leg.duration.value / 60);
                    safeSetText('driverETA', durationMinutes);
                    safeSetText('driverDistance', leg.distance.text);
                    
                    const arrivalTime = new Date(Date.now() + leg.duration.value * 1000)
                        .toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    safeSetText('driverArrivalTime', arrivalTime);
                    
                    safeSetStyle('driverApproachingBox', 'display', 'block');
                    
                    console.log('üìè Distance:', leg.distance.text);
                    console.log('‚è±Ô∏è Dur√©e:', leg.duration.text);
                    
                } else {
                    console.warn('‚ö†Ô∏è Erreur calcul trajet:', status);
                    // Fallback: afficher estimation bas√©e sur distance √† vol d'oiseau
                    drawFallbackLine(driverPos, clientCoords);
                }
            });
        }
        
        // ‚úÖ NOUVELLE FONCTION: Obtenir les coordonn√©es du client (avec g√©ocodage si n√©cessaire)
        async function getClientCoordinates() {
            // Si d√©j√† en cache dans currentBooking
            if (currentBooking?._cachedClientCoords) {
                return currentBooking._cachedClientCoords;
            }
            
            let clientCoords = null;
            
            // ‚úÖ V√©rifier les diff√©rents formats de coordonn√©es possibles
            if (currentBooking?.departCoords) {
                const coords = currentBooking.departCoords;
                
                // Format Firebase GeoPoint: { latitude, longitude }
                if (coords.latitude !== undefined && coords.longitude !== undefined) {
                    clientCoords = { lat: coords.latitude, lng: coords.longitude };
                    console.log('‚úÖ Coordonn√©es trouv√©es (format GeoPoint):', clientCoords);
                }
                // Format simple: { lat, lng }
                else if (coords.lat !== undefined && coords.lng !== undefined) {
                    clientCoords = { lat: coords.lat, lng: coords.lng };
                    console.log('‚úÖ Coordonn√©es trouv√©es (format simple):', clientCoords);
                }
                // Format _lat, _long (certaines versions de Firebase)
                else if (coords._lat !== undefined && coords._long !== undefined) {
                    clientCoords = { lat: coords._lat, lng: coords._long };
                    console.log('‚úÖ Coordonn√©es trouv√©es (format _lat/_long):', clientCoords);
                }
            }
            
            // ‚úÖ Si pas de coordonn√©es, g√©ocoder l'adresse textuelle
            if (!clientCoords && currentBooking?.depart) {
                console.log('üìç G√©ocodage de l\'adresse client:', currentBooking.depart);
                try {
                    clientCoords = await geocodeAddress(currentBooking.depart);
                    console.log('‚úÖ Coordonn√©es g√©ocod√©es:', clientCoords);
                } catch (error) {
                    console.error('‚ùå Erreur g√©ocodage:', error);
                }
            }
            
            // ‚úÖ Mettre en cache pour les prochains appels
            if (clientCoords && currentBooking) {
                currentBooking._cachedClientCoords = clientCoords;
                currentBooking.departCoords = clientCoords;
                
                // Mettre √† jour le marqueur client si n√©cessaire
                if (clientPickupMarker) {
                    clientPickupMarker.setPosition(clientCoords);
                }
            }
            
            return clientCoords;
        }

        // ‚úÖ NOUVELLE FONCTION: Fallback si l'API Directions √©choue
        function drawFallbackLine(driverPos, clientPos) {
            if (!trackingMap) return;
            
            console.log('üìç Trac√© fallback (ligne droite)');
            
            // Tracer une ligne pointill√©e
            const fallbackLine = new google.maps.Polyline({
                path: [driverPos, clientPos],
                geodesic: true,
                strokeColor: '#22c55e',
                strokeOpacity: 0.7,
                strokeWeight: 4,
                icons: [{
                    icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 3 },
                    offset: '0',
                    repeat: '15px'
                }],
                map: trackingMap
            });
            
            // Calculer distance approximative
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(driverPos.lat, driverPos.lng),
                new google.maps.LatLng(clientPos.lat, clientPos.lng)
            );
            
            const distanceKm = (distance / 1000).toFixed(1);
            const durationMin = Math.ceil(distance / 400); // ~24 km/h en ville
            
            safeSetText('driverETA', durationMin);
            safeSetText('driverDistance', distanceKm + ' km');
            
            const arrivalTime = new Date(Date.now() + durationMin * 60 * 1000)
                .toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            safeSetText('driverArrivalTime', arrivalTime);
        }

        function updateStep2(data) {
            safeAddClass('step2Icon', 'active');
            safeSetText('step2Text', `${data.nomChauffeur || 'Chauffeur'} assign√©`);
            safeSetText('step2Time', new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
        }

        function updateStep3() {
            const step3Icon = document.getElementById('step3Icon');
            if (step3Icon && !step3Icon.classList.contains('current') && !step3Icon.classList.contains('active')) {
                step3Icon.classList.add('current');
                safeSetText('step3Time', new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
            }
        }

        async function showDriverCard(data) {
            safeSetStyle('driverCard', 'display', 'block');
            safeSetText('driverName', data.nomChauffeur || 'Chauffeur');
            
            let rating = 4.9, marque = '', modele = '', immatriculation = 'DK-XXXX-XX', photoUrl = null;
            
            if (data.chauffeurAssigne) {
                try {
                    const driverDoc = await db.collection('drivers').doc(data.chauffeurAssigne).get();
                    if (driverDoc.exists) {
                        const dd = driverDoc.data();
                        rating = dd.rating || 4.9;
                        if (dd.vehicule) { marque = dd.vehicule.marque || ''; modele = dd.vehicule.modele || ''; immatriculation = dd.vehicule.immatriculation || 'DK-XXXX-XX'; }
                        photoUrl = dd.photos?.photoProfil || dd.photoProfil || dd.photoUrl || null;
                    }
                } catch (e) { console.error('Erreur chauffeur:', e); }
            }
            
            const driverAvatar = document.getElementById('driverAvatar');
            if (driverAvatar) {
                if (photoUrl) {
                    const img = new Image();
                    img.onload = () => { driverAvatar.innerHTML = `<img src="${photoUrl}" alt="Chauffeur">`; driverPhotoUrl = photoUrl; };
                    img.onerror = () => { driverAvatar.innerHTML = 'üë§'; };
                    img.src = photoUrl;
                } else { driverAvatar.innerHTML = 'üë§'; }
            }
            
            safeSetText('driverRating', rating);
            safeSetText('vehicleModel', marque && modele ? `${marque} ${modele}` : 'V√©hicule');
            safeSetText('vehiclePlate', immatriculation);
        }

        function showPaymentButton() {
            if (currentBooking && isDigitalPayment(currentBooking.modePaiement || selectedPayment)) {
                safeSetStyle('validatePaymentBtn', 'display', 'flex');
                const infoBox = document.getElementById('paymentInfoBox');
                if (infoBox) infoBox.classList.add('show');
                if (currentBooking.prixEstime) safeSetText('paymentInfoAmount', `${currentBooking.prixEstime.toLocaleString()} FCFA`);
            }
        }

        function hidePaymentButton() {
            safeSetStyle('validatePaymentBtn', 'display', 'none');
            const infoBox = document.getElementById('paymentInfoBox');
            if (infoBox) infoBox.classList.remove('show');
        }

        function callDriver() { showNotification('üìû Fonction √† venir', 'info'); }
        function messageDriver() { showNotification('üí¨ Fonction √† venir', 'info'); }

        async function cancelBooking() {
            if (!confirm('Annuler cette r√©servation?')) return;
            if (currentBooking?.id) {
                try { await db.collection('reservations').doc(currentBooking.id).update({ statut: 'annulee' }); }
                catch (e) { console.error('Erreur:', e); }
            }
            closeTracking();
            showNotification('R√©servation annul√©e', 'info');
        }

        function scrollToBooking() {
            const section = document.querySelector('.booking-section');
            if (section) section.scrollIntoView({ behavior: 'smooth' });
        }

        // ===== NOTIFICATIONS & LOADING =====
        function showNotification(msg, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = msg;
            document.body.appendChild(notif);
            setTimeout(() => { notif.style.opacity = '0'; setTimeout(() => notif.remove(), 300); }, 3000);
        }

        function showLoading(text = 'Chargement...') {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                const textEl = overlay.querySelector('.loading-text');
                if (textEl) textEl.textContent = text;
                overlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        // ===== EXPORTS =====
        window.openWallet = openWallet;
        window.closeWallet = closeWallet;
        window.showWalletScreen = showWalletScreen;
        window.initMap = initMap;

        console.log('%c‚úÖ Al Bourakh Client v3.9.1 - G√âOCODAGE AUTOMATIQUE', 'color: #00A854; font-size: 16px; font-weight: bold');
        console.log('%cüõ£Ô∏è Le trajet d\'approche fonctionne m√™me sans coordonn√©es GPS (g√©ocodage auto)', 'color: #22c55e; font-size: 12px');
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBI1svukv3Ts7fN97ke5OGfwo2V-vRUGHI&callback=initMap&libraries=places,geometry"></script>
<!-- ========================================== -->
<!-- WIDGET CHATBOT AL BOURAKH v3.3 - GEOCODE  -->
<!-- G√©ocodage automatique des adresses        -->
<!-- ========================================== -->

<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

    :root {
        --ab-primary: #0F172A;
        --ab-secondary: #EAB308;
        --ab-accent: #2563EB;
        --ab-success: #22c55e;
        --ab-danger: #ef4444;
        --ab-warning: #f59e0b;
        --ab-bg: #F8FAFC;
        --ab-text: #334155;
        --ab-white: #ffffff;
        --ab-gradient: linear-gradient(135deg, #0F172A, #1e293b);
        --ab-gradient-gold: linear-gradient(135deg, #EAB308, #fbbf24);
    }

    #ab-widget-container {
        font-family: 'Poppins', sans-serif;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    #ab-chat-btn {
        background: var(--ab-gradient);
        color: var(--ab-secondary);
        border: none;
        border-radius: 50%;
        width: 68px;
        height: 68px;
        cursor: pointer;
        box-shadow: 0 4px 25px rgba(0,0,0,0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        position: relative;
        animation: ab-float 3s ease-in-out infinite;
        -webkit-tap-highlight-color: transparent;
    }

    @keyframes ab-float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    #ab-chat-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 35px rgba(234, 179, 8, 0.5);
        animation: none;
    }

    #ab-chat-btn svg { width: 32px; height: 32px; fill: currentColor; }

    .ab-notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--ab-danger);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: ab-pulse-badge 2s infinite;
        border: 2px solid white;
    }

    @keyframes ab-pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.15); }
    }

    #ab-chat-window {
        width: 400px;
        height: 620px;
        background-color: var(--ab-white);
        border-radius: 20px;
        box-shadow: 0 15px 50px rgba(0,0,0,0.25);
        display: none;
        flex-direction: column;
        overflow: hidden;
        margin-bottom: 16px;
        border: 1px solid #e2e8f0;
        animation: ab-slideUp 0.3s ease;
        max-height: calc(100vh - 100px);
    }

    @keyframes ab-slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .ab-header {
        background: var(--ab-gradient);
        color: var(--ab-white);
        padding: 16px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 3px solid var(--ab-secondary);
    }

    .ab-header-left { display: flex; align-items: center; gap: 12px; }

    .ab-logo {
        width: 45px;
        height: 45px;
        background: var(--ab-gradient-gold);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--ab-primary);
        font-size: 15px;
        box-shadow: 0 2px 10px rgba(234, 179, 8, 0.4);
    }

    .ab-header-info h3 { margin: 0; font-size: 16px; font-weight: 600; }
    .ab-header-info span { font-size: 11px; opacity: 0.9; display: flex; align-items: center; gap: 6px; }

    .ab-status-dot {
        width: 9px;
        height: 9px;
        background-color: #22c55e;
        border-radius: 50%;
        animation: ab-blink 2s infinite;
        box-shadow: 0 0 6px #22c55e;
    }

    @keyframes ab-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .ab-header-actions { display: flex; align-items: center; gap: 6px; }

    .ab-header-btn {
        background: rgba(255,255,255,0.1);
        border: none;
        color: var(--ab-white);
        cursor: pointer;
        width: 34px;
        height: 34px;
        border-radius: 50%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ab-header-btn:hover { background: rgba(255,255,255,0.25); }
    .ab-header-btn.muted { color: var(--ab-danger); background: rgba(239, 68, 68, 0.2); }
    .ab-header-btn svg { width: 18px; height: 18px; }

    .ab-audio-panel {
        background: linear-gradient(135deg, #1e293b, #334155);
        padding: 14px 18px;
        display: none;
        flex-direction: column;
        gap: 14px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .ab-audio-panel.visible { display: flex; }

    .ab-audio-row { display: flex; align-items: center; gap: 12px; }
    .ab-audio-label { color: rgba(255,255,255,0.85); font-size: 12px; min-width: 65px; font-weight: 500; }

    .ab-audio-slider {
        flex: 1;
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        background: rgba(255,255,255,0.2);
        border-radius: 3px;
        outline: none;
    }

    .ab-audio-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: var(--ab-secondary);
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .ab-audio-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

    .ab-audio-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: var(--ab-secondary);
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }

    .ab-audio-value { color: var(--ab-secondary); font-size: 12px; font-weight: 600; min-width: 42px; text-align: right; }

    .ab-audio-presets { display: flex; gap: 8px; margin-top: 6px; }

    .ab-preset-btn {
        flex: 1;
        padding: 8px 12px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        border-radius: 8px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }

    .ab-preset-btn:hover { background: rgba(255,255,255,0.2); }
    .ab-preset-btn.active { background: var(--ab-secondary); color: var(--ab-primary); border-color: var(--ab-secondary); }

    #ab-messages {
        flex: 1;
        padding: 18px;
        overflow-y: auto;
        overflow-x: hidden;
        background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
        display: flex;
        flex-direction: column;
        gap: 14px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }

    #ab-messages::-webkit-scrollbar { width: 6px; }
    #ab-messages::-webkit-scrollbar-track { background: transparent; }
    #ab-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

    .ab-msg {
        max-width: 88%;
        padding: 14px 18px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.55;
        position: relative;
        word-wrap: break-word;
        animation: ab-fadeInUp 0.3s ease;
    }

    @keyframes ab-fadeInUp {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .ab-msg-bot {
        background-color: var(--ab-white);
        color: var(--ab-text);
        border: 1px solid #e2e8f0;
        align-self: flex-start;
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    .ab-msg-user {
        background: var(--ab-gradient);
        color: var(--ab-white);
        align-self: flex-end;
        border-bottom-right-radius: 6px;
        box-shadow: 0 2px 10px rgba(15, 23, 42, 0.3);
    }

    .ab-msg-system {
        background: var(--ab-gradient-gold);
        color: var(--ab-primary);
        align-self: center;
        text-align: center;
        font-weight: 500;
        font-size: 13px;
        padding: 10px 16px;
        border-radius: 12px;
    }

    .ab-quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
    }

    .ab-quick-btn {
        background: var(--ab-bg);
        border: 1.5px solid #e2e8f0;
        padding: 10px 16px;
        border-radius: 22px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.25s;
        color: var(--ab-primary);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .ab-quick-btn:hover {
        background: var(--ab-primary);
        color: var(--ab-white);
        border-color: var(--ab-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.25);
    }

    .ab-estimate-card {
        background: var(--ab-gradient);
        color: white;
        padding: 18px;
        border-radius: 16px;
        margin-top: 12px;
        box-shadow: 0 4px 20px rgba(15, 23, 42, 0.3);
    }

    .ab-estimate-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 14px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .ab-estimate-title { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 8px; }
    .ab-estimate-price { font-size: 26px; font-weight: bold; color: var(--ab-secondary); text-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    .ab-estimate-details { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; }
    .ab-estimate-item { display: flex; align-items: center; gap: 8px; opacity: 0.95; }

    .ab-book-btn {
        width: 100%;
        margin-top: 14px;
        padding: 14px;
        background: var(--ab-gradient-gold);
        color: var(--ab-primary);
        border: none;
        border-radius: 10px;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.25s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .ab-book-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(234, 179, 8, 0.5);
    }

    .ab-tarif-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 12px;
    }

    .ab-tarif-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.25s;
    }

    .ab-tarif-card:hover {
        border-color: var(--ab-secondary);
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .ab-tarif-card.selected {
        border-color: var(--ab-success);
        background: #f0fdf4;
    }

    .ab-tarif-icon { font-size: 28px; margin-bottom: 6px; }
    .ab-tarif-name { font-weight: 600; font-size: 13px; color: var(--ab-primary); }
    .ab-tarif-vehicle { font-size: 11px; color: #64748b; margin: 2px 0; }
    .ab-tarif-price { font-weight: 700; font-size: 12px; color: var(--ab-success); }

    .ab-form-card {
        background: var(--ab-white);
        border: 1.5px solid #e2e8f0;
        border-radius: 14px;
        padding: 18px;
        margin-top: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }

    .ab-form-title {
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 14px;
        color: var(--ab-primary);
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--ab-secondary);
    }

    .ab-form-group { margin-bottom: 14px; }
    .ab-form-group label { display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500; }

    .ab-form-group input, .ab-form-group select {
        width: 100%;
        padding: 12px 14px;
        border: 1.5px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        outline: none;
        box-sizing: border-box;
        transition: all 0.2s;
        font-family: inherit;
    }

    .ab-form-group input:focus, .ab-form-group select:focus {
        border-color: var(--ab-primary);
        box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1);
    }

    .ab-location-btn {
        background: var(--ab-accent);
        color: white;
        border: none;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .ab-location-btn:hover { background: #1d4ed8; }
    .ab-location-btn.loading { opacity: 0.7; pointer-events: none; }

    .ab-confirmation {
        text-align: center;
        padding: 10px 0;
    }

    .ab-confirmation-icon {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 35px;
        color: white;
        box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        animation: ab-bounce 0.5s ease;
    }

    @keyframes ab-bounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .ab-confirmation h3 { color: var(--ab-success); margin: 0 0 8px 0; font-size: 18px; }
    .ab-confirmation-ref { background: #f1f5f9; padding: 10px 15px; border-radius: 8px; font-family: monospace; font-size: 14px; margin: 10px 0; }

    .ab-trip-summary {
        background: #f1f5f9;
        padding: 14px;
        border-radius: 10px;
        margin: 15px 0;
        text-align: left;
        font-size: 13px;
    }

    .ab-trip-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
    .ab-trip-row:last-child { margin-bottom: 0; }
    .ab-trip-icon { font-size: 16px; }
    .ab-trip-text { flex: 1; }

    .ab-input-area {
        padding: 12px 14px;
        border-top: 1px solid #e2e8f0;
        background-color: var(--ab-white);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
    }

    #ab-input {
        flex: 1;
        min-width: 0;
        padding: 12px 16px;
        border: 1.5px solid #e2e8f0;
        border-radius: 25px;
        outline: none;
        font-size: 14px;
        background: var(--ab-bg);
        transition: all 0.2s;
        font-family: inherit;
    }

    #ab-input:focus {
        border-color: var(--ab-primary);
        background: var(--ab-white);
        box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);
    }

    .ab-icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--ab-primary);
        padding: 10px;
        border-radius: 50%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        min-width: 44px;
        min-height: 44px;
    }

    .ab-icon-btn:hover { background-color: var(--ab-bg); }
    .ab-icon-btn.send-btn { background: var(--ab-gradient); color: var(--ab-secondary); }
    .ab-icon-btn.send-btn:hover { box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); }
    .ab-icon-btn.listening { color: var(--ab-danger); animation: ab-pulse 1s infinite; background: rgba(239, 68, 68, 0.1); }
    
    #ab-mic-btn {
        background: rgba(37, 99, 235, 0.1);
        color: var(--ab-accent);
    }
    
    #ab-mic-btn:hover {
        background: rgba(37, 99, 235, 0.2);
    }
    
    #ab-location-btn {
        background: rgba(34, 197, 94, 0.1);
        color: var(--ab-success);
    }
    
    #ab-location-btn:hover {
        background: rgba(34, 197, 94, 0.2);
    }

    @keyframes ab-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

    .ab-typing {
        display: flex;
        gap: 5px;
        padding: 14px 18px;
        background: var(--ab-white);
        border-radius: 18px;
        align-self: flex-start;
        border: 1px solid #e2e8f0;
    }

    .ab-typing-dot {
        width: 9px;
        height: 9px;
        background: #94a3b8;
        border-radius: 50%;
        animation: ab-typing 1.4s infinite;
    }

    .ab-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .ab-typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes ab-typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }

    .ab-contact-card {
        background: white;
        border: 1.5px solid #e2e8f0;
        border-radius: 12px;
        padding: 14px;
        margin-top: 10px;
    }

    .ab-contact-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .ab-contact-item:last-child { border-bottom: none; }

    .ab-contact-item a {
        color: var(--ab-accent);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
    }

    .ab-contact-item a:hover { color: #1d4ed8; }

    .ab-toast {
        position: fixed;
        bottom: 100px;
        right: 30px;
        background: var(--ab-primary);
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 13px;
        z-index: 10001;
        animation: ab-toastAnim 2.5s forwards;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        font-weight: 500;
    }

    @keyframes ab-toastAnim {
        0% { opacity: 0; transform: translateY(15px); }
        15% { opacity: 1; transform: translateY(0); }
        85% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-15px); }
    }

    @media (max-width: 480px) {
        #ab-widget-container {
            bottom: 10px;
            right: 10px;
            left: 10px;
        }
        
        #ab-chat-window {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100% !important;
            height: 100% !important;
            max-width: 100%;
            max-height: 100%;
            border-radius: 0;
            margin-bottom: 0;
            z-index: 10000;
            display: flex;
            flex-direction: column;
        }
        
        #ab-chat-window.open {
            display: flex !important;
        }
        
        #ab-chat-btn {
            width: 60px;
            height: 60px;
            bottom: 10px;
            right: 10px;
        }
        
        .ab-header {
            padding: 12px 15px;
            border-radius: 0;
        }
        
        .ab-header-info h3 {
            font-size: 14px;
        }
        
        .ab-logo {
            width: 40px;
            height: 40px;
            font-size: 13px;
        }
        
        #ab-messages {
            padding: 12px;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }
        
        .ab-msg {
            max-width: 92%;
            padding: 12px 14px;
            font-size: 13px;
        }
        
        .ab-quick-actions {
            gap: 6px;
        }
        
        .ab-quick-btn {
            padding: 8px 12px;
            font-size: 11px;
        }
        
        .ab-form-card {
            padding: 14px;
            margin-top: 8px;
        }
        
        .ab-form-title {
            font-size: 14px;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        
        .ab-form-group {
            margin-bottom: 12px;
        }
        
        .ab-form-group label {
            font-size: 11px;
        }
        
        .ab-form-group input, 
        .ab-form-group select {
            padding: 10px 12px;
            font-size: 14px;
        }
        
        .ab-location-btn {
            padding: 8px 12px;
            font-size: 11px;
        }
        
        .ab-book-btn {
            padding: 12px;
            font-size: 13px;
        }
        
        .ab-estimate-card {
            padding: 14px;
        }
        
        .ab-estimate-price {
            font-size: 22px;
        }
        
        .ab-estimate-details {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .ab-tarif-grid {
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .ab-tarif-card {
            padding: 10px 8px;
        }
        
        .ab-tarif-icon {
            font-size: 24px;
        }
        
        .ab-tarif-name {
            font-size: 12px;
        }
        
        .ab-tarif-vehicle {
            font-size: 10px;
        }
        
        .ab-tarif-price {
            font-size: 11px;
        }
        
        .ab-input-area {
            padding: 10px 8px;
            gap: 6px;
            flex-wrap: nowrap;
            align-items: center;
        }
        
        #ab-input {
            padding: 10px 14px;
            font-size: 14px;
            min-width: 0;
            flex: 1;
            border-radius: 20px;
        }
        
        .ab-icon-btn {
            padding: 10px;
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            flex-shrink: 0;
            border-radius: 50%;
        }
        
        .ab-icon-btn svg {
            width: 20px;
            height: 20px;
        }
        
        #ab-location-btn {
            background: #22c55e !important;
            color: white !important;
        }
        
        #ab-mic-btn {
            background: #3b82f6 !important;
            color: white !important;
        }
        
        .ab-icon-btn.send-btn {
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
        }
        
        #ab-location-btn,
        #ab-mic-btn,
        .ab-icon-btn.send-btn {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .ab-confirmation-icon {
            width: 60px;
            height: 60px;
            font-size: 28px;
        }
        
        .ab-confirmation h3 {
            font-size: 16px;
        }
        
        .ab-confirmation-ref {
            font-size: 12px;
            padding: 8px 12px;
        }
        
        .ab-trip-summary {
            padding: 12px;
            font-size: 12px;
        }
        
        .ab-audio-panel {
            padding: 12px 14px;
        }
        
        .ab-audio-row {
            gap: 8px;
        }
        
        .ab-audio-label {
            font-size: 11px;
            min-width: 55px;
        }
        
        .ab-preset-btn {
            padding: 6px 10px;
            font-size: 10px;
        }
        
        .ab-contact-card {
            padding: 12px;
        }
        
        .ab-contact-item {
            padding: 8px 0;
            font-size: 13px;
        }
        
        .ab-toast {
            bottom: 80px;
            right: 15px;
            left: 15px;
            font-size: 12px;
            padding: 10px 16px;
        }
    }
    
    @media (min-width: 481px) and (max-width: 768px) {
        #ab-chat-window {
            width: 380px;
            height: 580px;
            right: 15px;
            bottom: 80px;
        }
        
        .ab-tarif-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    @supports (-webkit-touch-callout: none) {
        #ab-chat-window {
            height: -webkit-fill-available;
        }
    }
</style>

<div id="ab-widget-container">
    <div id="ab-chat-window">
        <div class="ab-header">
            <div class="ab-header-left">
                <div class="ab-logo">AB</div>
                <div class="ab-header-info">
                    <h3>Assistant Al Bourakh</h3>
                    <span><div class="ab-status-dot"></div> En ligne 24h/7</span>
                </div>
            </div>
            <div class="ab-header-actions">
                <button class="ab-header-btn" id="ab-settings-btn" onclick="abToggleAudioPanel()" title="Param√®tres audio">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
                <button class="ab-header-btn" id="ab-mute-btn" onclick="abToggleMute()" title="Activer/D√©sactiver la voix">
                    <svg id="ab-sound-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    </svg>
                    <svg id="ab-sound-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <line x1="23" y1="9" x2="17" y2="15"/>
                        <line x1="17" y1="9" x2="23" y2="15"/>
                    </svg>
                </button>
                <button class="ab-header-btn" onclick="abToggleChat()" title="Fermer">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="ab-audio-panel" id="ab-audio-panel">
            <div class="ab-audio-row">
                <span class="ab-audio-label">üîä Volume</span>
                <input type="range" class="ab-audio-slider" id="ab-volume" min="0" max="100" value="80" oninput="abUpdateVolume(this.value)">
                <span class="ab-audio-value" id="ab-volume-value">80%</span>
            </div>
            <div class="ab-audio-row">
                <span class="ab-audio-label">‚ö° Vitesse</span>
                <input type="range" class="ab-audio-slider" id="ab-speed" min="50" max="150" value="100" oninput="abUpdateSpeed(this.value)">
                <span class="ab-audio-value" id="ab-speed-value">1.0x</span>
            </div>
            <div class="ab-audio-presets">
                <button class="ab-preset-btn" onclick="abSetAudioPreset('slow')">üê¢ Lent</button>
                <button class="ab-preset-btn active" onclick="abSetAudioPreset('normal')">üë§ Normal</button>
                <button class="ab-preset-btn" onclick="abSetAudioPreset('fast')">üöÄ Rapide</button>
            </div>
        </div>
        
        <div id="ab-messages"></div>
        
        <div class="ab-input-area">
            <button class="ab-icon-btn" id="ab-location-btn" onclick="abGetMyLocation()" title="Ma position">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>
                    <line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/>
                    <line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/>
                </svg>
            </button>
            <input type="text" id="ab-input" placeholder="Posez votre question..." onkeypress="abHandleKeyPress(event)">
            <button class="ab-icon-btn" id="ab-mic-btn" onclick="abToggleVoice()" title="Commande vocale">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
            </button>
            <button class="ab-icon-btn send-btn" onclick="abSendMessage()" title="Envoyer">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>
    </div>

    <button id="ab-chat-btn" onclick="abToggleChat()">
        <span class="ab-notification-badge" id="ab-badge" style="display:none;">1</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
    </button>
</div>

<script>
/* =============================================== */
/* CHATBOT AL BOURAKH v3.3 - G√âOCODAGE AUTO       */
/* G√©ocodage automatique des adresses             */
/* =============================================== */

// ========== ‚úÖ FIREBASE - R√©utiliser l'instance principale ==========
let abDb;
if (typeof db !== 'undefined') {
    abDb = db;
    console.log('üîó Chatbot connect√© √† Firebase (via app principale)');
} else {
    const abFirebaseConfig = {
        apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
        authDomain: "albourakh-sn-ok.firebaseapp.com",
        projectId: "albourakh-sn-ok",
        storageBucket: "albourakh-sn-ok.firebasestorage.app",
        messagingSenderId: "297875396274",
        appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
    };
    if (!firebase.apps.length) {
        firebase.initializeApp(abFirebaseConfig);
    }
    abDb = firebase.firestore();
    console.log('üîó Chatbot: Firebase initialis√© de mani√®re autonome');
}

console.log('ü§ñ Chatbot Al Bourakh v3.3 - G√âOCODAGE AUTO');

// ========== ‚úÖ FONCTION DE G√âOCODAGE AUTOMATIQUE ==========
async function abGeocodeAddress(address) {
    return new Promise((resolve) => {
        // V√©rifier si Google Maps est disponible
        if (typeof google === 'undefined' || !google.maps) {
            console.warn('‚ö†Ô∏è Google Maps non disponible, utilisation API Nominatim');
            abGeocodeWithNominatim(address).then(resolve);
            return;
        }
        
        const geocoder = new google.maps.Geocoder();
        
        // Ajouter contexte S√©n√©gal pour am√©liorer pr√©cision
        let searchAddress = address;
        if (!address.toLowerCase().includes('s√©n√©gal') && 
            !address.toLowerCase().includes('senegal') && 
            !address.toLowerCase().includes('dakar')) {
            searchAddress = address + ', Dakar, S√©n√©gal';
        }
        
        console.log('üîç G√©ocodage Google Maps:', searchAddress);
        
        geocoder.geocode({ address: searchAddress }, (results, status) => {
            if (status === 'OK' && results[0]) {
                const location = results[0].geometry.location;
                const coords = {
                    lat: location.lat(),
                    lng: location.lng()
                };
                console.log('‚úÖ Coordonn√©es trouv√©es (Google):', coords);
                resolve(coords);
            } else {
                console.warn('‚ö†Ô∏è G√©ocodage Google √©chou√©:', status, '- fallback Nominatim');
                abGeocodeWithNominatim(address).then(resolve);
            }
        });
    });
}

async function abGeocodeWithNominatim(address) {
    try {
        let searchAddress = address;
        if (!address.toLowerCase().includes('s√©n√©gal') && 
            !address.toLowerCase().includes('senegal')) {
            searchAddress = address + ', Dakar, S√©n√©gal';
        }
        
        console.log('üîç G√©ocodage Nominatim:', searchAddress);
        
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchAddress)}&limit=1`,
            { headers: { 'Accept-Language': 'fr' } }
        );
        
        const data = await response.json();
        
        if (data && data.length > 0) {
            const coords = {
                lat: parseFloat(data[0].lat),
                lng: parseFloat(data[0].lon)
            };
            console.log('‚úÖ Coordonn√©es trouv√©es (Nominatim):', coords);
            return coords;
        }
    } catch (error) {
        console.error('‚ùå Erreur g√©ocodage Nominatim:', error);
    }
    
    // Fallback: coordonn√©es par d√©faut Dakar
    console.warn('‚ö†Ô∏è G√©ocodage √©chou√©, utilisation coordonn√©es Dakar par d√©faut');
    return { lat: 14.6937, lng: -17.4441 };
}

// ========== CONFIGURATION TARIFS ==========
const AB_TARIFS = {
    standard: { nom: "Standard", vehicule: "Kia Rio / Hyundai i10", priseEnCharge: 1000, parKm: 200, icon: "üöó", price: 1500 },
    confort: { nom: "Confort", vehicule: "VW Polo / Toyota Yaris", priseEnCharge: 1500, parKm: 300, icon: "üöô", price: 2000 },
    premium: { nom: "Premium", vehicule: "Hyundai Tucson / Toyota RAV4", priseEnCharge: 2500, parKm: 400, icon: "üöò", price: 3500 },
    van: { nom: "Van", vehicule: "Renault Trafic / VW Transporter", priseEnCharge: 2000, parKm: 350, icon: "üöê", price: 2500 }
};

const AB_TARIFS_FIXES = {
    "dakar-aibd": { depart: "Dakar Centre", destination: "A√©roport AIBD", prix: 15000, distance: 47 },
    "almadies-aibd": { depart: "Almadies/Ngor", destination: "A√©roport AIBD", prix: 18000, distance: 52 },
    "plateau-aibd": { depart: "Plateau", destination: "A√©roport AIBD", prix: 15000, distance: 45 },
    "parcelles-aibd": { depart: "Parcelles Assainies", destination: "A√©roport AIBD", prix: 12000, distance: 38 },
    "pikine-aibd": { depart: "Pikine/Gu√©diawaye", destination: "A√©roport AIBD", prix: 10000, distance: 32 },
    "rufisque-aibd": { depart: "Rufisque", destination: "A√©roport AIBD", prix: 8000, distance: 25 },
    "thies-aibd": { depart: "Thi√®s", destination: "A√©roport AIBD", prix: 20000, distance: 60 },
    "saly-aibd": { depart: "Saly/Mbour", destination: "A√©roport AIBD", prix: 35000, distance: 95 }
};

// ========== VARIABLES GLOBALES ==========
let abState = {
    isChatOpen: false,
    isListening: false,
    userLocation: null,
    currentEstimate: null,
    reservationData: {},
    conversationContext: { lastIntent: null, awaitingInput: null },
    isMuted: false,
    audioVolume: 0.8,
    audioSpeed: 1.0
};

const abChatWindow = document.getElementById('ab-chat-window');
const abMessagesContainer = document.getElementById('ab-messages');
const abInputField = document.getElementById('ab-input');
const abMicBtn = document.getElementById('ab-mic-btn');
const abMuteBtn = document.getElementById('ab-mute-btn');
const abBadge = document.getElementById('ab-badge');
const abAudioPanel = document.getElementById('ab-audio-panel');
const abSynth = window.speechSynthesis;

// Reconnaissance vocale
const AbSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let abRecognition;

if (AbSpeechRecognition) {
    abRecognition = new AbSpeechRecognition();
    abRecognition.lang = 'fr-FR';
    abRecognition.continuous = false;
    abRecognition.interimResults = false;
    
    abRecognition.onstart = () => {
        abState.isListening = true;
        if (abMicBtn) abMicBtn.classList.add('listening');
        if (abInputField) abInputField.placeholder = "üé§ Je vous √©coute...";
    };

    abRecognition.onend = () => {
        abState.isListening = false;
        if (abMicBtn) abMicBtn.classList.remove('listening');
        if (abInputField) abInputField.placeholder = "Posez votre question...";
    };

    abRecognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        if (abInputField) abInputField.value = transcript;
        abSendMessage();
    };

    abRecognition.onerror = (event) => {
        console.error('Erreur reconnaissance vocale:', event.error);
        abShowToast('‚ùå Erreur micro: ' + event.error);
        abState.isListening = false;
        if (abMicBtn) abMicBtn.classList.remove('listening');
        if (abInputField) abInputField.placeholder = "Posez votre question...";
    };
}

// ========== FONCTION HELPER ==========
function abGetLastElement(selector) {
    const elements = document.querySelectorAll(selector);
    return elements.length > 0 ? elements[elements.length - 1] : null;
}

// ========== ‚úÖ SYNCHRONISATION AVEC PAGE PRINCIPALE ==========
function abSyncWithMainApp(reservationData, reservationId) {
    console.log('üîÑ Synchronisation avec la page principale...');
    console.log('üì¶ Donn√©es √† synchroniser:', reservationData);
    
    // 1. Remplir les champs du formulaire principal
    const bookingFrom = document.getElementById('bookingFrom');
    const bookingTo = document.getElementById('bookingTo');
    const bookingDate = document.getElementById('bookingDate');
    const bookingTime = document.getElementById('bookingTime');
    const bookingPhone = document.getElementById('bookingPhone');
    const bookingName = document.getElementById('bookingName');
    
    if (bookingFrom) bookingFrom.value = reservationData.depart || '';
    if (bookingTo) bookingTo.value = reservationData.destination || '';
    if (bookingDate) bookingDate.value = reservationData.dateReservation || '';
    if (bookingTime) bookingTime.value = reservationData.heureReservation || '';
    if (bookingPhone) bookingPhone.value = reservationData.clientTelephone || '';
    if (bookingName) bookingName.value = reservationData.clientNom || '';
    
    // 2. S√©lectionner le v√©hicule
    if (reservationData.vehiculeType) {
        const vehiclePrice = AB_TARIFS[reservationData.vehiculeType]?.price || 1500;
        window.selectedVehicle = reservationData.vehiculeType;
        window.selectedVehiclePrice = vehiclePrice;
    }
    
    // 3. Mettre √† jour les coordonn√©es
    if (reservationData.departCoords) {
        window.departureCoords = reservationData.departCoords;
    }
    if (reservationData.destinationCoords) {
        window.destinationCoords = reservationData.destinationCoords;
    }
    
    // 4. Mettre √† jour currentBooking pour le tracking
    window.currentBooking = {
        id: reservationId,
        depart: reservationData.depart,
        destination: reservationData.destination,
        departCoords: reservationData.departCoords,
        destinationCoords: reservationData.destinationCoords,
        prixEstime: reservationData.prixEstime,
        distanceEstimee: reservationData.distanceEstimee,
        vehiculeType: reservationData.vehiculeType,
        modePaiement: reservationData.modePaiement,
        clientNom: reservationData.clientNom,
        clientTelephone: reservationData.clientTelephone,
        dateReservation: reservationData.dateReservation,
        heureReservation: reservationData.heureReservation,
        statut: 'en_attente'
    };
    
    console.log('üìç currentBooking mis √† jour:', window.currentBooking);
    
    // 5. Ouvrir le modal de suivi
    setTimeout(() => {
        if (typeof openTracking === 'function') {
            openTracking();
            console.log('‚úÖ Modal de suivi ouvert');
        }
        
        setTimeout(() => {
            const tripFrom = document.getElementById('tripFrom');
            const tripTo = document.getElementById('tripTo');
            const tripPrice = document.getElementById('tripPrice');
            
            if (tripFrom) tripFrom.textContent = reservationData.depart || '-';
            if (tripTo) tripTo.textContent = reservationData.destination || '-';
            if (tripPrice) tripPrice.textContent = (reservationData.prixEstime || 0).toLocaleString() + ' FCFA';
            
            console.log('‚úÖ D√©tails du trajet mis √† jour');
        }, 200);
        
        if (typeof startReservationListener === 'function') {
            startReservationListener(reservationId);
            console.log('‚úÖ Listener de r√©servation d√©marr√©');
        }
    }, 500);
    
    if (typeof showNotification === 'function') {
        showNotification('‚úÖ R√©servation synchronis√©e!', 'success');
    }
    
    console.log('‚úÖ Synchronisation termin√©e');
}

// ========== FONCTIONS AUDIO ==========
function abToggleMute() {
    abState.isMuted = !abState.isMuted;
    const soundOn = document.getElementById('ab-sound-on');
    const soundOff = document.getElementById('ab-sound-off');
    
    if (abState.isMuted) {
        if (soundOn) soundOn.style.display = 'none';
        if (soundOff) soundOff.style.display = 'block';
        if (abMuteBtn) abMuteBtn.classList.add('muted');
        if (abSynth.speaking) abSynth.cancel();
        abShowToast('üîá Voix d√©sactiv√©e');
    } else {
        if (soundOn) soundOn.style.display = 'block';
        if (soundOff) soundOff.style.display = 'none';
        if (abMuteBtn) abMuteBtn.classList.remove('muted');
        abShowToast('üîä Voix activ√©e');
    }
    localStorage.setItem('ab-muted', abState.isMuted);
}

function abToggleAudioPanel() {
    if (abAudioPanel) abAudioPanel.classList.toggle('visible');
}

function abUpdateVolume(value) {
    abState.audioVolume = value / 100;
    const el = document.getElementById('ab-volume-value');
    if (el) el.textContent = value + '%';
    localStorage.setItem('ab-volume', value);
}

function abUpdateSpeed(value) {
    abState.audioSpeed = value / 100;
    const el = document.getElementById('ab-speed-value');
    if (el) el.textContent = abState.audioSpeed.toFixed(1) + 'x';
    localStorage.setItem('ab-speed', value);
}

function abSetAudioPreset(preset) {
    document.querySelectorAll('.ab-preset-btn').forEach(btn => btn.classList.remove('active'));
    const presets = { slow: 70, normal: 100, fast: 130 };
    const value = presets[preset] || 100;
    abState.audioSpeed = value / 100;
    const speedEl = document.getElementById('ab-speed');
    const speedValEl = document.getElementById('ab-speed-value');
    if (speedEl) speedEl.value = value;
    if (speedValEl) speedValEl.textContent = abState.audioSpeed.toFixed(1) + 'x';
    const index = preset === 'slow' ? 0 : preset === 'normal' ? 1 : 2;
    document.querySelectorAll('.ab-preset-btn')[index]?.classList.add('active');
    localStorage.setItem('ab-speed', value);
}

function abLoadAudioSettings() {
    const savedVolume = localStorage.getItem('ab-volume');
    const savedSpeed = localStorage.getItem('ab-speed');
    const savedMuted = localStorage.getItem('ab-muted');
    
    if (savedVolume) {
        abState.audioVolume = savedVolume / 100;
        const volEl = document.getElementById('ab-volume');
        const volValEl = document.getElementById('ab-volume-value');
        if (volEl) volEl.value = savedVolume;
        if (volValEl) volValEl.textContent = savedVolume + '%';
    }
    
    if (savedSpeed) {
        abState.audioSpeed = savedSpeed / 100;
        const speedEl = document.getElementById('ab-speed');
        const speedValEl = document.getElementById('ab-speed-value');
        if (speedEl) speedEl.value = savedSpeed;
        if (speedValEl) speedValEl.textContent = abState.audioSpeed.toFixed(1) + 'x';
    }
    
    if (savedMuted === 'true') {
        abState.isMuted = true;
        const soundOn = document.getElementById('ab-sound-on');
        const soundOff = document.getElementById('ab-sound-off');
        if (soundOn) soundOn.style.display = 'none';
        if (soundOff) soundOff.style.display = 'block';
        if (abMuteBtn) abMuteBtn.classList.add('muted');
    }
}

// ========== CONVERSION NOMBRES EN FRAN√áAIS ==========
function abConvertNumbersToFrench(text) {
    text = text.replace(/(\d)\s+(\d)/g, '$1$2');
    const numberWords = {
        '500000': 'cinq cent mille', '400000': 'quatre cent mille',
        '50000': 'cinquante mille', '35000': 'trente-cinq mille',
        '25000': 'vingt-cinq mille', '20000': 'vingt mille',
        '18000': 'dix-huit mille', '15000': 'quinze mille',
        '12000': 'douze mille', '10000': 'dix mille',
        '8000': 'huit mille', '5000': 'cinq mille',
        '2500': 'deux mille cinq cents', '2000': 'deux mille',
        '1500': 'mille cinq cents', '1000': 'mille'
    };
    const sortedNumbers = Object.keys(numberWords).sort((a, b) => b.length - a.length);
    for (const num of sortedNumbers) {
        const regex = new RegExp('\\b' + num + '\\b', 'g');
        text = text.replace(regex, numberWords[num]);
    }
    text = text.replace(/FCFA/gi, 'francs CFA');
    return text;
}

// ========== SYNTH√àSE VOCALE ==========
function abSpeakText(text) {
    if (abState.isMuted) return;
    if (abSynth.speaking) abSynth.cancel();
    
    let cleanText = text
        .replace(/<[^>]*>/g, ' ')
        .replace(/\*\*/g, '').replace(/\*/g, '')
        .replace(/[^\p{L}\p{N}\s\.,!?;:'-]/gu, '')
        .replace(/\n+/g, '. ')
        .replace(/\s+/g, ' ')
        .trim();
    
    cleanText = abConvertNumbersToFrench(cleanText);
    
    if (cleanText.length < 3) return;
    if (cleanText.length > 600) cleanText = cleanText.substring(0, 600) + '...';
    
    const utterance = new SpeechSynthesisUtterance(cleanText);
    utterance.lang = 'fr-FR';
    utterance.rate = abState.audioSpeed;
    utterance.volume = abState.audioVolume;
    utterance.pitch = 1;
    
    const voices = abSynth.getVoices();
    const frenchVoice = voices.find(v => v.lang === 'fr-FR') || voices.find(v => v.lang.startsWith('fr'));
    if (frenchVoice) utterance.voice = frenchVoice;
    
    abSynth.speak(utterance);
}

function abShowToast(message) {
    const toast = document.createElement('div');
    toast.className = 'ab-toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
}

// ========== INITIALISATION ==========
document.addEventListener('DOMContentLoaded', () => {
    abLoadAudioSettings();
    if (abSynth.onvoiceschanged !== undefined) {
        abSynth.onvoiceschanged = () => abSynth.getVoices();
    }
    abSynth.getVoices();
    abShowWelcomeMessage();
    setTimeout(() => {
        if (!abState.isChatOpen && abBadge) abBadge.style.display = 'flex';
    }, 3000);
});

function abShowWelcomeMessage() {
    const hour = new Date().getHours();
    let greeting = hour < 12 ? 'Bonjour' : hour < 18 ? 'Bon apr√®s-midi' : 'Bonsoir';
    
    const welcomeHtml = `
        <div>${greeting} ! üëã <strong>Dalal ak diam</strong> chez Al Bourakh !<br><br>
            Je suis votre assistant virtuel. Comment puis-je vous aider ?</div>
        <div class="ab-quick-actions">
            <button class="ab-quick-btn" onclick="abHandleQuickAction('tarifs')">üí∞ Nos tarifs</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('estimer')">üìç Estimer un trajet</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('reserver')">üöó R√©server</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('aeroport')">‚úàÔ∏è A√©roport AIBD</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('chauffeur')">üë§ Devenir chauffeur</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('contact')">üìû Contact</button>
        </div>
    `;
    abAddMessage('bot', welcomeHtml, true);
}

// ========== GESTION DU CHAT ==========
function abToggleChat() {
    abState.isChatOpen = !abState.isChatOpen;
    const chatBtn = document.getElementById('ab-chat-btn');
    
    if (abChatWindow) {
        abChatWindow.style.display = abState.isChatOpen ? 'flex' : 'none';
    }
    
    if (abBadge) abBadge.style.display = 'none';
    
    if (chatBtn && window.innerWidth <= 480) {
        chatBtn.style.display = abState.isChatOpen ? 'none' : 'flex';
    }
    
    if (window.innerWidth <= 480) {
        document.body.style.overflow = abState.isChatOpen ? 'hidden' : '';
    }
    
    if (abState.isChatOpen && abInputField) {
        setTimeout(() => abInputField.focus(), 300);
    }
}

function abToggleVoice() {
    if (!abRecognition) { 
        abShowToast('‚ùå Micro non support√© sur ce navigateur'); 
        return; 
    }
    
    try {
        if (abState.isListening) {
            abRecognition.stop();
        } else {
            abRecognition.start();
        }
    } catch (error) {
        abShowToast('‚ùå Erreur: ' + error.message);
    }
}

function abHandleKeyPress(e) {
    if (e.key === 'Enter') abSendMessage();
}

function abAddMessage(sender, text, isHtml = false) {
    const div = document.createElement('div');
    div.classList.add('ab-msg');
    div.classList.add(sender === 'user' ? 'ab-msg-user' : sender === 'system' ? 'ab-msg-system' : 'ab-msg-bot');
    
    if (isHtml) div.innerHTML = text;
    else div.innerText = text;
    
    if (abMessagesContainer) {
        abMessagesContainer.appendChild(div);
        abMessagesContainer.scrollTop = abMessagesContainer.scrollHeight;
    }
    
    if (sender === 'bot') {
        setTimeout(() => abSpeakText(text), 100);
    }
}

function abShowTyping() {
    const existing = document.getElementById('ab-typing');
    if (existing) return;
    
    const typing = document.createElement('div');
    typing.className = 'ab-typing';
    typing.id = 'ab-typing';
    typing.innerHTML = '<div class="ab-typing-dot"></div><div class="ab-typing-dot"></div><div class="ab-typing-dot"></div>';
    if (abMessagesContainer) {
        abMessagesContainer.appendChild(typing);
        abMessagesContainer.scrollTop = abMessagesContainer.scrollHeight;
    }
}

function abHideTyping() {
    const typing = document.getElementById('ab-typing');
    if (typing) typing.remove();
}

// ========== G√âOLOCALISATION ==========
function abGetMyLocation() {
    if (!navigator.geolocation) {
        abAddMessage('system', '‚ùå G√©olocalisation non support√©e');
        return;
    }
    
    abAddMessage('system', 'üìç Recherche de votre position...');
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            abState.userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${abState.userLocation.lat}&lon=${abState.userLocation.lng}&zoom=18&addressdetails=1`,
                    { headers: { 'Accept-Language': 'fr' } }
                );
                const data = await response.json();
                
                let address = '';
                if (data.address) {
                    const a = data.address;
                    address = [a.road, a.neighbourhood, a.suburb, a.city || a.town || a.village]
                        .filter(Boolean).slice(0, 3).join(', ');
                }
                if (!address) address = data.display_name?.split(',').slice(0, 3).join(',') || `${abState.userLocation.lat.toFixed(4)}, ${abState.userLocation.lng.toFixed(4)}`;
                
                abState.userLocation.address = address;
                window.abDetectedAddress = address;
                
                const html = `
                    <div style="background:#ecfdf5;padding:14px;border-radius:12px;border:2px solid #22c55e;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                            <span style="font-size:20px;">‚úÖ</span>
                            <strong style="color:#166534;">Position trouv√©e !</strong>
                        </div>
                        <div style="background:white;padding:12px;border-radius:8px;margin-bottom:12px;">
                            <div style="display:flex;align-items:flex-start;gap:8px;">
                                <span style="color:#ef4444;font-size:18px;">üìç</span>
                                <span style="color:#333;font-weight:500;" id="ab-detected-address">${address}</span>
                            </div>
                        </div>
                        <button onclick="abConfirmDetectedLocation()" 
                            style="width:100%;padding:12px;background:linear-gradient(135deg,#22c55e,#16a34a);color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                            <span>‚úì</span> Confirmer comme point de d√©part
                        </button>
                    </div>
                    <p style="font-size:12px;color:#64748b;margin-top:8px;text-align:center;">Ou tapez une autre adresse ci-dessous</p>
                `;
                abAddMessage('bot', html, true);
                
            } catch (error) {
                abAddMessage('bot', `‚úÖ Position GPS d√©tect√©e. O√π souhaitez-vous aller ?`, true);
            }
        },
        (error) => {
            let errorMsg = 'Erreur de g√©olocalisation';
            if (error.code === 1) errorMsg = 'Acc√®s √† la position refus√©';
            abAddMessage('system', `‚ùå ${errorMsg}. Entrez votre adresse manuellement.`);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
    );
}

function abConfirmDetectedLocation() {
    const address = window.abDetectedAddress || (abState.userLocation && abState.userLocation.address) || '';
    
    if (!address) {
        abShowToast('‚ùå Adresse non disponible');
        return;
    }
    
    console.log('üìç Confirmation de la position:', address);
    
    abState.reservationData.depart = address;
    abState.reservationData.departCoords = abState.userLocation ? { lat: abState.userLocation.lat, lng: abState.userLocation.lng } : null;
    
    const bookingFrom = document.getElementById('bookingFrom');
    if (bookingFrom) {
        bookingFrom.value = address;
        window.departureCoords = abState.reservationData.departCoords;
    }
    
    const html = `
        <div style="background:#f0fdf4;padding:12px;border-radius:10px;border-left:4px solid #22c55e;margin-bottom:12px;">
            <strong style="color:#166534;">üìç D√©part confirm√©:</strong><br>
            <span style="color:#333;">${address}</span>
        </div>
        <div style="font-weight:500;color:#333;">O√π souhaitez-vous aller ?</div>
        <div class="ab-quick-actions" style="margin-top:10px;">
            <button class="ab-quick-btn" onclick="abHandleQuickAction('aeroport')">‚úàÔ∏è A√©roport AIBD</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('reserver')">üöó Formulaire complet</button>
        </div>
    `;
    abAddMessage('bot', html, true);
    
    abState.conversationContext.awaitingInput = 'destination';
    abShowToast('‚úÖ Position confirm√©e comme d√©part');
}

function abConfirmLocation(address) {
    window.abDetectedAddress = address;
    abConfirmDetectedLocation();
}

// ========== ACTIONS RAPIDES ==========
function abHandleQuickAction(action) {
    switch(action) {
        case 'tarifs': abShowTarifs(); break;
        case 'estimer': abShowEstimationForm(); break;
        case 'reserver': abShowReservationForm(); break;
        case 'aeroport': abShowAeroportTarifs(); break;
        case 'chauffeur': abShowChauffeurInfo(); break;
        case 'contact': abShowContact(); break;
    }
}

// ========== TARIFS ==========
function abShowTarifs() {
    let html = `<div><strong>üí∞ Grille Tarifaire Al Bourakh</strong></div>`;
    html += `<div class="ab-tarif-grid">`;
    for (const [key, tarif] of Object.entries(AB_TARIFS)) {
        html += `
            <div class="ab-tarif-card" onclick="abSelectTarifForEstimate('${key}')">
                <div class="ab-tarif-icon">${tarif.icon}</div>
                <div class="ab-tarif-name">${tarif.nom}</div>
                <div class="ab-tarif-vehicle">${tarif.vehicule}</div>
                <div class="ab-tarif-price">${tarif.priseEnCharge.toLocaleString()} F + ${tarif.parKm} F/km</div>
            </div>
        `;
    }
    html += `</div>
        <div style="background:#fef3c7;padding:12px;border-radius:10px;font-size:12px;margin-top:12px;">
            ‚úàÔ∏è <strong>Tarifs A√©roport AIBD</strong> : Prix fixes selon votre zone de d√©part
        </div>
        <div class="ab-quick-actions">
            <button class="ab-quick-btn" onclick="abHandleQuickAction('aeroport')">‚úàÔ∏è Tarifs A√©roport</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('estimer')">üìç Estimer mon trajet</button>
        </div>
    `;
    abAddMessage('bot', html, true);
}

function abSelectTarifForEstimate(type) {
    abState.reservationData.vehicule = type;
    abShowEstimationForm();
}

function abShowAeroportTarifs() {
    let html = `
        <div><strong>‚úàÔ∏è Tarifs Fixes A√©roport AIBD</strong></div>
        <p style="font-size:12px;color:#64748b;margin:8px 0;">Prix garantis !</p>
        <div style="background:#f1f5f9;border-radius:10px;padding:12px;margin-top:10px;">
    `;
    for (const [key, tarif] of Object.entries(AB_TARIFS_FIXES)) {
        html += `
            <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #e2e8f0;">
                <span>üìç ${tarif.depart}</span>
                <strong style="color:#22c55e;">${tarif.prix.toLocaleString()} F</strong>
            </div>
        `;
    }
    html += `</div>
        <div class="ab-quick-actions">
            <button class="ab-quick-btn" onclick="abHandleQuickAction('reserver')">üöó R√©server maintenant</button>
        </div>
    `;
    abAddMessage('bot', html, true);
}

// ========== ESTIMATION ==========
function abShowEstimationForm() {
    const selectedVehicule = abState.reservationData.vehicule || 'standard';
    
    const html = `
        <div class="ab-form-card">
            <div class="ab-form-title">üìç Estimation de votre trajet</div>
            <div class="ab-form-group">
                <label>Point de d√©part</label>
                <input type="text" class="ab-est-depart" placeholder="Ex: Plateau, Dakar" value="${abState.reservationData.depart || ''}">
                <button class="ab-location-btn" onclick="abUseMyLocationForEstimate()">üìç Ma position GPS</button>
            </div>
            <div class="ab-form-group">
                <label>Destination</label>
                <input type="text" class="ab-est-destination" placeholder="Ex: A√©roport AIBD, Almadies...">
            </div>
            <div class="ab-form-group">
                <label>Type de v√©hicule</label>
                <select class="ab-est-vehicule">
                    ${Object.entries(AB_TARIFS).map(([k, v]) => 
                        `<option value="${k}" ${selectedVehicule === k ? 'selected' : ''}>${v.icon} ${v.nom}</option>`
                    ).join('')}
                </select>
            </div>
            <button class="ab-book-btn" onclick="abCalculateEstimate()">üìä Calculer le prix</button>
        </div>
    `;
    abAddMessage('bot', html, true);
}

function abUseMyLocationForEstimate() {
    if (abState.userLocation && abState.userLocation.address) {
        const el = abGetLastElement('.ab-est-depart');
        if (el) el.value = abState.userLocation.address;
        abShowToast('‚úÖ Position utilis√©e');
    } else {
        abGetMyLocation();
    }
}

async function abCalculateEstimate() {
    const departEl = abGetLastElement('.ab-est-depart');
    const destEl = abGetLastElement('.ab-est-destination');
    const vehiculeEl = abGetLastElement('.ab-est-vehicule');
    
    const depart = departEl?.value?.trim();
    const destination = destEl?.value?.trim();
    const vehicule = vehiculeEl?.value || 'standard';
    
    if (!depart || !destination) {
        abAddMessage('system', '‚ö†Ô∏è Veuillez remplir le d√©part et la destination');
        return;
    }
    
    abShowTyping();
    await new Promise(r => setTimeout(r, 800));
    
    const fixedKey = abCheckFixedTarif(depart, destination);
    let distance, duration, prix;
    
    if (fixedKey) {
        const fixed = AB_TARIFS_FIXES[fixedKey];
        distance = fixed.distance;
        duration = Math.round(distance * 1.2);
        prix = fixed.prix;
    } else {
        distance = await abEstimateDistance(depart, destination);
        duration = Math.round(distance * 2.5);
        const tarif = AB_TARIFS[vehicule];
        prix = tarif.priseEnCharge + (distance * tarif.parKm);
    }
    
    abHideTyping();
    
    abState.currentEstimate = { depart, destination, vehicule, distance, duration, prix: Math.round(prix) };
    abState.reservationData = { ...abState.currentEstimate };
    
    abShowEstimateResult(fixedKey !== null);
}

function abCheckFixedTarif(depart, destination) {
    const d = depart.toLowerCase();
    const dest = destination.toLowerCase();
    
    if (dest.includes('aibd') || dest.includes('a√©roport') || dest.includes('aeroport') || dest.includes('blaise diagne')) {
        if (d.includes('almadies') || d.includes('ngor')) return 'almadies-aibd';
        if (d.includes('plateau') || d.includes('centre')) return 'plateau-aibd';
        if (d.includes('parcelles')) return 'parcelles-aibd';
        if (d.includes('pikine') || d.includes('gu√©diawaye')) return 'pikine-aibd';
        if (d.includes('rufisque')) return 'rufisque-aibd';
        if (d.includes('thi√®s') || d.includes('thies')) return 'thies-aibd';
        if (d.includes('saly') || d.includes('mbour')) return 'saly-aibd';
        return 'dakar-aibd';
    }
    return null;
}

async function abEstimateDistance(depart, destination) {
    const d = depart.toLowerCase();
    const dest = destination.toLowerCase();
    
    if (dest.includes('aibd') || dest.includes('aeroport')) return 45;
    if (dest.includes('thies') || dest.includes('thi√®s')) return 70;
    if (dest.includes('saly') || dest.includes('mbour')) return 85;
    if ((d.includes('plateau') && dest.includes('almadies')) || (d.includes('almadies') && dest.includes('plateau'))) return 9;
    
    return 8 + Math.random() * 10;
}

function abShowEstimateResult(isFixedPrice = false) {
    const tarif = AB_TARIFS[abState.currentEstimate.vehicule];
    
    const html = `
        <div class="ab-estimate-card">
            <div class="ab-estimate-header">
                <span class="ab-estimate-title">${tarif.icon} ${tarif.nom}</span>
                <span class="ab-estimate-price">${abState.currentEstimate.prix.toLocaleString()} F</span>
            </div>
            <div class="ab-estimate-details">
                <div class="ab-estimate-item">üìç ${abState.currentEstimate.depart}</div>
                <div class="ab-estimate-item">üéØ ${abState.currentEstimate.destination}</div>
                <div class="ab-estimate-item">üìè ~${abState.currentEstimate.distance.toFixed(1)} km</div>
                <div class="ab-estimate-item">‚è±Ô∏è ~${abState.currentEstimate.duration} min</div>
            </div>
            ${isFixedPrice ? '<div style="background:rgba(34,197,94,0.2);padding:8px;border-radius:6px;margin-top:10px;font-size:12px;text-align:center;">‚úÖ Tarif fixe garanti</div>' : ''}
            <button class="ab-book-btn" onclick="abShowReservationForm()">üöó R√©server ce trajet</button>
        </div>
        <div class="ab-quick-actions">
            <button class="ab-quick-btn" onclick="abHandleQuickAction('estimer')">üîÑ Nouvelle estimation</button>
        </div>
    `;
    abAddMessage('bot', html, true);
}

// ========== FORMULAIRE DE R√âSERVATION ==========
function abShowReservationForm() {
    const now = new Date();
    now.setMinutes(now.getMinutes() + 30);
    const defaultDate = now.toISOString().split('T')[0];
    const defaultTime = now.toTimeString().slice(0, 5);
    
    let nomDefaut = document.getElementById('bookingName')?.value || localStorage.getItem('albourakh_name') || '';
    let telDefaut = document.getElementById('bookingPhone')?.value || localStorage.getItem('albourakh_phone') || '';
    
    const html = `
        <div class="ab-form-card">
            <div class="ab-form-title">üöó R√©server votre course</div>
            <div class="ab-form-group">
                <label>Votre nom complet *</label>
                <input type="text" class="ab-res-nom" placeholder="Pr√©nom et Nom" value="${nomDefaut}">
            </div>
            <div class="ab-form-group">
                <label>T√©l√©phone *</label>
                <input type="tel" class="ab-res-tel" placeholder="+221 77 XXX XX XX" value="${telDefaut}">
            </div>
            <div class="ab-form-group">
                <label>Point de d√©part *</label>
                <input type="text" class="ab-res-depart" placeholder="Adresse de d√©part" value="${abState.reservationData.depart || ''}">
                <button class="ab-location-btn" onclick="abUseMyLocationForReservation()">üìç Ma position actuelle</button>
            </div>
            <div class="ab-form-group">
                <label>Destination *</label>
                <input type="text" class="ab-res-dest" placeholder="Adresse de destination" value="${abState.reservationData.destination || ''}">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div class="ab-form-group">
                    <label>Date *</label>
                    <input type="date" class="ab-res-date" value="${defaultDate}" min="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="ab-form-group">
                    <label>Heure *</label>
                    <input type="time" class="ab-res-time" value="${defaultTime}">
                </div>
            </div>
            <div class="ab-form-group">
                <label>Type de v√©hicule</label>
                <select class="ab-res-vehicule">
                    ${Object.entries(AB_TARIFS).map(([k, v]) => 
                        `<option value="${k}" ${abState.reservationData.vehicule === k ? 'selected' : ''}>${v.icon} ${v.nom}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="ab-form-group">
                <label>Mode de paiement</label>
                <select class="ab-res-paiement">
                    <option value="cash">üíµ Esp√®ces</option>
                    <option value="orange">üì± Orange Money</option>
                    <option value="wave">üí≥ Wave</option>
                    <option value="wallet">üëõ Portefeuille Al Bourakh</option>
                </select>
            </div>
            ${abState.reservationData.prix ? `
            <div style="background:#ecfdf5;padding:12px;border-radius:10px;margin-bottom:14px;text-align:center;border:2px solid #22c55e;">
                <span style="color:#166534;">Prix estim√©:</span>
                <strong style="font-size:18px;color:#15803d;"> ${abState.reservationData.prix.toLocaleString()} FCFA</strong>
            </div>
            ` : ''}
            <button class="ab-book-btn" onclick="abSubmitReservation()">‚úÖ Confirmer la r√©servation</button>
            <p style="font-size:11px;color:#64748b;text-align:center;margin-top:10px;">* Champs obligatoires</p>
        </div>
    `;
    abAddMessage('bot', html, true);
}

function abUseMyLocationForReservation() {
    if (abState.userLocation && abState.userLocation.address) {
        const el = abGetLastElement('.ab-res-depart');
        if (el) {
            el.value = abState.userLocation.address;
            abState.reservationData.depart = abState.userLocation.address;
            abState.reservationData.departCoords = { lat: abState.userLocation.lat, lng: abState.userLocation.lng };
        }
        
        const bookingFrom = document.getElementById('bookingFrom');
        if (bookingFrom) {
            bookingFrom.value = abState.userLocation.address;
            window.departureCoords = { lat: abState.userLocation.lat, lng: abState.userLocation.lng };
        }
        
        abShowToast('‚úÖ Position utilis√©e');
    } else {
        abGetMyLocation();
    }
}

// ========== ‚úÖ SOUMISSION R√âSERVATION AVEC G√âOCODAGE AUTO ==========
async function abSubmitReservation() {
    const nomEl = abGetLastElement('.ab-res-nom');
    const telEl = abGetLastElement('.ab-res-tel');
    const departEl = abGetLastElement('.ab-res-depart');
    const destEl = abGetLastElement('.ab-res-dest');
    const dateEl = abGetLastElement('.ab-res-date');
    const timeEl = abGetLastElement('.ab-res-time');
    const vehiculeEl = abGetLastElement('.ab-res-vehicule');
    const paiementEl = abGetLastElement('.ab-res-paiement');
    
    const nom = nomEl?.value?.trim();
    const tel = telEl?.value?.trim();
    const depart = departEl?.value?.trim();
    const dest = destEl?.value?.trim();
    const date = dateEl?.value;
    const time = timeEl?.value;
    const vehicule = vehiculeEl?.value;
    const paiement = paiementEl?.value;
    
    // Validation
    if (!nom) { abAddMessage('system', '‚ö†Ô∏è Veuillez entrer votre nom'); return; }
    if (!tel) { abAddMessage('system', '‚ö†Ô∏è Veuillez entrer votre t√©l√©phone'); return; }
    if (!depart) { abAddMessage('system', '‚ö†Ô∏è Veuillez entrer le point de d√©part'); return; }
    if (!dest) { abAddMessage('system', '‚ö†Ô∏è Veuillez entrer la destination'); return; }
    
    abShowTyping();
    abAddMessage('system', 'üìç G√©ocodage des adresses en cours...');
    
    // Formater le t√©l√©phone
    let telFormatted = tel.replace(/\s/g, '');
    if (!telFormatted.startsWith('+221') && !telFormatted.startsWith('221')) {
        telFormatted = '+221' + telFormatted.replace(/^0/, '');
    }
    
    const paiementNames = { cash: 'Esp√®ces', orange: 'Orange Money', wave: 'Wave', wallet: 'Portefeuille Al Bourakh' };
    
    // ‚úÖ G√âOCODAGE AUTOMATIQUE DES ADRESSES
    let departCoords = abState.reservationData.departCoords || null;
    let destinationCoords = abState.reservationData.destinationCoords || null;
    
    // G√©ocoder le d√©part si pas de coordonn√©es
    if (!departCoords) {
        console.log('üìç G√©ocodage du d√©part:', depart);
        try {
            departCoords = await abGeocodeAddress(depart);
            console.log('‚úÖ Coordonn√©es d√©part:', departCoords);
        } catch (error) {
            console.error('‚ùå Erreur g√©ocodage d√©part:', error);
        }
    }
    
    // G√©ocoder la destination si pas de coordonn√©es
    if (!destinationCoords) {
        console.log('üìç G√©ocodage de la destination:', dest);
        try {
            destinationCoords = await abGeocodeAddress(dest);
            console.log('‚úÖ Coordonn√©es destination:', destinationCoords);
        } catch (error) {
            console.error('‚ùå Erreur g√©ocodage destination:', error);
        }
    }
    
    // Calculer un prix estim√© si pas d√©j√† fait
    let prixEstime = abState.reservationData.prix || 0;
    let distanceEstimee = abState.reservationData.distance || 0;
    
    if (prixEstime === 0) {
        distanceEstimee = await abEstimateDistance(depart, dest);
        const tarif = AB_TARIFS[vehicule];
        prixEstime = Math.round(tarif.priseEnCharge + (distanceEstimee * tarif.parKm));
    }
    
    const reservationData = {
        clientNom: nom,
        clientTelephone: telFormatted,
        depart: depart,
        destination: dest,
        departCoords: departCoords,         // ‚úÖ COORDONN√âES G√âOCOD√âES
        destinationCoords: destinationCoords, // ‚úÖ COORDONN√âES G√âOCOD√âES
        dateReservation: date,
        heureReservation: time,
        vehiculeType: vehicule,
        modePaiement: paiementNames[paiement] || 'Esp√®ces',
        prixEstime: prixEstime,
        distanceEstimee: distanceEstimee,
        statut: 'en_attente',
        source: 'chatbot_v3.3_geocode',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        paiementValide: false,
        chauffeurAssigne: null
    };
    
    console.log('üì¶ Donn√©es de r√©servation compl√®tes:', reservationData);
    
    try {
        const docRef = await abDb.collection('reservations').add(reservationData);
        
        abHideTyping();
        
        const refCode = docRef.id.slice(-8).toUpperCase();
        const dateFormatted = new Date(`${date}T${time}`).toLocaleString('fr-FR', {
            weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit'
        });
        
        const html = `
            <div class="ab-confirmation">
                <div class="ab-confirmation-icon">‚úì</div>
                <h3>R√©servation confirm√©e !</h3>
                <div class="ab-confirmation-ref">R√©f: ${refCode}</div>
                <div class="ab-trip-summary">
                    <div class="ab-trip-row"><span class="ab-trip-icon">üìç</span><span class="ab-trip-text"><strong>D√©part:</strong> ${depart}</span></div>
                    <div class="ab-trip-row"><span class="ab-trip-icon">üéØ</span><span class="ab-trip-text"><strong>Arriv√©e:</strong> ${dest}</span></div>
                    <div class="ab-trip-row"><span class="ab-trip-icon">üìÖ</span><span class="ab-trip-text">${dateFormatted}</span></div>
                    <div class="ab-trip-row"><span class="ab-trip-icon">üöó</span><span class="ab-trip-text">${AB_TARIFS[vehicule].icon} ${AB_TARIFS[vehicule].nom}</span></div>
                    <div class="ab-trip-row"><span class="ab-trip-icon">üí∞</span><span class="ab-trip-text"><strong>${prixEstime.toLocaleString()} FCFA</strong></span></div>
                </div>
                <p style="font-size:12px;color:#22c55e;">üìç Coordonn√©es GPS enregistr√©es ‚úì</p>
                <p style="font-size:12px;color:#64748b;">üîÑ Ouverture du suivi en cours...</p>
            </div>
        `;
        
        abAddMessage('bot', html, true);
        
        // Sauvegarder les infos utilisateur
        localStorage.setItem('albourakh_name', nom);
        localStorage.setItem('albourakh_phone', telFormatted);
        
        // ‚úÖ SYNCHRONISATION AVEC LA PAGE PRINCIPALE
        abSyncWithMainApp(reservationData, docRef.id);
        
        // Fermer le chatbot apr√®s un d√©lai
        setTimeout(() => {
            abToggleChat();
        }, 2000);
        
        // Reset donn√©es
        abState.reservationData = {};
        abState.currentEstimate = null;
        
    } catch (error) {
        abHideTyping();
        console.error('Erreur r√©servation:', error);
        abAddMessage('system', `‚ùå Erreur: ${error.message}`);
    }
}

// ========== AUTRES INFOS ==========
function abShowChauffeurInfo() {
    const html = `
        <div><strong>üë§ Devenir Chauffeur Al Bourakh</strong></div>
        <div style="background:#ecfdf5;padding:14px;border-radius:10px;margin:12px 0;">
            <strong>üí∞ Revenus potentiels:</strong>
            <div style="font-size:20px;font-weight:bold;color:#15803d;margin:8px 0;">300 000 - 500 000 FCFA/mois</div>
        </div>
        <div style="background:#f1f5f9;padding:14px;border-radius:10px;">
            <strong>üìã Conditions:</strong>
            <ul style="margin:8px 0;padding-left:18px;font-size:13px;">
                <li>√Çge minimum: 23 ans</li>
                <li>Permis: 3 ans minimum</li>
                <li>Casier judiciaire vierge</li>
                <li>Smartphone Android/iOS</li>
            </ul>
        </div>
        <div class="ab-quick-actions">
            <button class="ab-quick-btn" onclick="abHandleQuickAction('contact')">üìû Plus d'infos</button>
        </div>
    `;
    abAddMessage('bot', html, true);
}

function abShowContact() {
    const html = `
        <div><strong>üìû Contactez Al Bourakh</strong></div>
        <div class="ab-contact-card">
            <div class="ab-contact-item"><span>üì±</span><div><strong>T√©l√©phone</strong><br><a href="tel:+221787850101">+221 78 785 01 01</a></div></div>
            <div class="ab-contact-item"><span>üí¨</span><div><strong>WhatsApp</strong><br><a href="https://wa.me/221787850101" target="_blank">+221 78 785 01 01</a></div></div>
            <div class="ab-contact-item"><span>üïê</span><div><strong>Horaires</strong><br><span style="color:#22c55e;font-weight:600;">24h/24 - 7j/7</span></div></div>
        </div>
        <div class="ab-quick-actions">
            <button class="ab-quick-btn" onclick="window.open('https://wa.me/221787850101', '_blank')">üí¨ WhatsApp</button>
            <button class="ab-quick-btn" onclick="window.open('tel:+221787850101')">üìû Appeler</button>
        </div>
    `;
    abAddMessage('bot', html, true);
}

// ========== TRAITEMENT IA ==========
async function abSendMessage() {
    const text = abInputField?.value?.trim();
    if (!text) return;

    abAddMessage('user', text);
    if (abInputField) abInputField.value = '';

    abShowTyping();
    await new Promise(r => setTimeout(r, 500 + Math.random() * 500));
    
    const response = await abProcessMessage(text);
    abHideTyping();
    
    if (response.text) {
        abAddMessage('bot', response.text, response.isHtml || false);
    }
}

async function abProcessMessage(text) {
    const q = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    
    if (q.match(/^(bonjour|salam|salut|hello|bonsoir|hey|coucou)/)) {
        const hour = new Date().getHours();
        let greeting = hour < 12 ? 'Bonjour' : hour < 18 ? 'Bon apr√®s-midi' : 'Bonsoir';
        return { 
            text: `${greeting} ! üëã Comment puis-je vous aider ?<br><br>
            <div class="ab-quick-actions">
                <button class="ab-quick-btn" onclick="abHandleQuickAction('estimer')">üìç Estimer</button>
                <button class="ab-quick-btn" onclick="abHandleQuickAction('reserver')">üöó R√©server</button>
                <button class="ab-quick-btn" onclick="abHandleQuickAction('tarifs')">üí∞ Tarifs</button>
            </div>`,
            isHtml: true
        };
    }
    
    if (q.match(/(merci|thank)/)) return { text: `Je vous en prie ! üòä N'h√©sitez pas si vous avez d'autres questions !` };
    if (q.match(/(bye|au revoir)/)) return { text: `Au revoir et √† bient√¥t ! üëã Bonne route !` };
    
    if (q.match(/(prix|tarif|combien|cher)/)) {
        if (q.match(/(aeroport|aibd)/)) { abShowAeroportTarifs(); return { text: '' }; }
        abShowTarifs(); return { text: '' };
    }
    
    if (q.match(/(estim|calculer|trajet|distance|aller)/)) { abShowEstimationForm(); return { text: '' }; }
    if (q.match(/(reserv|book|commander|course|taxi|vtc)/)) { abShowReservationForm(); return { text: '' }; }
    if (q.match(/(aeroport|aibd|avion)/)) { abShowAeroportTarifs(); return { text: '' }; }
    if (q.match(/(chauffeur|devenir|travail|emploi)/)) { abShowChauffeurInfo(); return { text: '' }; }
    if (q.match(/(contact|telephone|whatsapp)/)) { abShowContact(); return { text: '' }; }
    if (q.match(/(position|localisation|gps)/)) { abGetMyLocation(); return { text: '' }; }
    
    if (abState.conversationContext.awaitingInput === 'destination' && text.length > 2) {
        abState.reservationData.destination = text;
        abState.conversationContext.awaitingInput = null;
        if (abState.reservationData.depart) {
            abState.reservationData.vehicule = 'standard';
            const distance = await abEstimateDistance(abState.reservationData.depart, text);
            const tarif = AB_TARIFS['standard'];
            const prix = tarif.priseEnCharge + (distance * tarif.parKm);
            abState.reservationData.distance = distance;
            abState.reservationData.prix = Math.round(prix);
            abState.currentEstimate = { ...abState.reservationData, duration: Math.round(distance * 2.5) };
            setTimeout(() => abShowEstimateResult(false), 100);
            return { text: '' };
        }
    }
    
    return {
        text: `Je n'ai pas bien compris. Voici ce que je peux faire :<br><br>
        <div class="ab-quick-actions">
            <button class="ab-quick-btn" onclick="abHandleQuickAction('estimer')">üìç Estimer</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('reserver')">üöó R√©server</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('tarifs')">üí∞ Tarifs</button>
            <button class="ab-quick-btn" onclick="abHandleQuickAction('contact')">üìû Contact</button>
        </div>`,
        isHtml: true
    };
}

// ========== EXPORTS ==========
window.abToggleChat = abToggleChat;
window.abToggleMute = abToggleMute;
window.abToggleAudioPanel = abToggleAudioPanel;
window.abUpdateVolume = abUpdateVolume;
window.abUpdateSpeed = abUpdateSpeed;
window.abSetAudioPreset = abSetAudioPreset;
window.abHandleQuickAction = abHandleQuickAction;
window.abSendMessage = abSendMessage;
window.abHandleKeyPress = abHandleKeyPress;
window.abToggleVoice = abToggleVoice;
window.abGetMyLocation = abGetMyLocation;
window.abConfirmLocation = abConfirmLocation;
window.abConfirmDetectedLocation = abConfirmDetectedLocation;
window.abUseMyLocationForEstimate = abUseMyLocationForEstimate;
window.abUseMyLocationForReservation = abUseMyLocationForReservation;
window.abCalculateEstimate = abCalculateEstimate;
window.abShowEstimationForm = abShowEstimationForm;
window.abShowReservationForm = abShowReservationForm;
window.abSubmitReservation = abSubmitReservation;
window.abSelectTarifForEstimate = abSelectTarifForEstimate;
window.abSyncWithMainApp = abSyncWithMainApp;
window.abGeocodeAddress = abGeocodeAddress;

console.log('%c‚úÖ Chatbot Al Bourakh v3.3 - G√âOCODAGE AUTO', 'color: #22c55e; font-size: 14px; font-weight: bold');
console.log('%cüîÑ Synchronisation avec page principale activ√©e', 'color: #2563eb; font-size: 12px');
console.log('%cüìç G√©ocodage automatique des adresses activ√©', 'color: #f59e0b; font-size: 12px');
</script>
<!-- FIN WIDGET CHATBOT AL BOURAKH v3.3 -->
</body>
</html>

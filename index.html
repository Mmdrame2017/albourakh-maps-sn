<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Al Bourakh - VTC & Paiement v3.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; overflow-x: hidden; }
        
        .hero-section { background: linear-gradient(135deg, #00A854, #FECB00, #E30613); padding: 40px 15px; text-align: center; color: white; }
        .hero-logo { width: 100px; height: 75px; margin-bottom: 12px; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3)); }
        .hero-title { font-size: 2em; margin-bottom: 8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .hero-subtitle { font-size: 1em; opacity: 0.95; }
        .hero-cta { display: inline-block; margin-top: 20px; padding: 12px 28px; font-size: 1em; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; background: white; color: #00A854; box-shadow: 0 8px 25px rgba(0,0,0,0.2); transition: all 0.3s; margin-right: 10px; }
        .hero-cta:hover { transform: scale(1.05); }
        .hero-cta.wallet-btn { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; }

        /* WALLET STYLES */
        .wallet-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; overflow-y: auto; }
        .wallet-modal.active { display: block; }
        .wallet-container { max-width: 500px; margin: 10px auto; background: #f9fafb; border-radius: 15px; overflow: hidden; min-height: calc(100vh - 20px); }
        .wallet-header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .wallet-header h2 { font-size: 1.2em; display: flex; align-items: center; gap: 8px; }
        .wallet-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        .wallet-content { padding: 15px; }
        
        .wallet-card { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .wallet-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .wallet-amount { font-size: 2.25rem; font-weight: 700; margin-top: 0.25rem; }
        .wallet-label { color: #bfdbfe; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .wallet-actions { display: flex; gap: 0.5rem; margin-top: 1.5rem; }
        .btn-wallet { flex: 1; padding: 0.75rem; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-wallet.primary { background: white; color: #2563eb; }
        .btn-wallet.primary:hover { background: #eff6ff; }
        .btn-wallet.secondary { background: #3b82f6; color: white; }
        .btn-wallet.secondary:hover { background: #60a5fa; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-content { display: flex; align-items: center; gap: 0.75rem; }
        .stat-icon { padding: 0.5rem; border-radius: 0.5rem; font-size: 1.2em; }
        .stat-icon.green { background: #dcfce7; color: #16a34a; }
        .stat-icon.purple { background: #f3e8ff; color: #9333ea; }
        .stat-label { color: #6b7280; font-size: 0.75rem; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #111827; }

        .loyalty-card { background: linear-gradient(to right, #fbbf24 0%, #f97316 100%); border-radius: 0.75rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .loyalty-points { font-size: 1.875rem; font-weight: 700; color: white; margin-top: 0.25rem; }
        .loyalty-label { color: white; font-size: 0.875rem; font-weight: 500; }
        .loyalty-badge { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border-radius: 0.5rem; padding: 0.5rem 1rem; color: white; font-size: 0.75rem; }

        .card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .section-header h3 { font-size: 1.125rem; font-weight: 700; color: #111827; }
        .btn-link { color: #2563eb; font-size: 0.875rem; font-weight: 500; text-decoration: none; cursor: pointer; }

        .transaction-list { border-top: 1px solid #f3f4f6; }
        .transaction-item { padding: 1rem; border-bottom: 1px solid #f3f4f6; transition: background 0.2s; cursor: pointer; }
        .transaction-item:hover { background: #f9fafb; }
        .transaction-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .transaction-route { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #111827; margin-bottom: 0.25rem; }
        .transaction-driver { font-size: 0.75rem; color: #6b7280; }
        .transaction-amount { font-size: 1.125rem; font-weight: 700; color: #111827; text-align: right; }
        .transaction-tip { font-size: 0.75rem; color: #16a34a; }
        .transaction-footer { display: flex; justify-content: space-between; align-items: center; }
        .transaction-date { font-size: 0.75rem; color: #6b7280; }
        .transaction-badge { font-size: 0.75rem; background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 9999px; }

        .amount-input-container { position: relative; margin-bottom: 1rem; }
        .amount-input { width: 100%; padding: 1rem; font-size: 1.5rem; font-weight: 700; text-align: center; border: 2px solid #e5e7eb; border-radius: 0.75rem; }
        .amount-input:focus { outline: none; border-color: #2563eb; }
        .amount-currency { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.25rem; color: #9ca3af; font-weight: 500; }
        .quick-amounts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .quick-amount-btn { padding: 0.75rem; border: none; border-radius: 0.5rem; background: #f3f4f6; color: #374151; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .quick-amount-btn:hover { background: #eff6ff; color: #2563eb; }

        .payment-method-wallet { width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; background: white; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .payment-method-wallet:hover:not(:disabled) { border-color: #d1d5db; }
        .payment-method-wallet.active { border-color: #2563eb; background: #eff6ff; }
        .payment-method-wallet:disabled { opacity: 0.5; cursor: not-allowed; }
        .payment-method-content { display: flex; align-items: center; gap: 0.75rem; }
        .payment-method-icon { font-size: 1.5rem; }
        .payment-method-name { font-weight: 500; color: #111827; }

        .btn-primary-wallet { width: 100%; padding: 0.75rem; border: none; border-radius: 0.5rem; color: white; font-weight: 500; font-size: 1rem; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transition: all 0.2s; background: #2563eb; }
        .btn-primary-wallet:hover { background: #1d4ed8; }

        .success-screen { min-height: 60vh; display: flex; align-items: center; justify-content: center; text-align: center; }
        .success-icon { background: #dcfce7; width: 6rem; height: 6rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 3rem; color: #16a34a; }
        .success-title { font-size: 1.5rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem; }
        .success-message { color: #6b7280; }

        .wallet-screen { display: none; }
        .wallet-screen.active { display: block; }

        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; margin-right: 10px; }

        /* MAP & BOOKING STYLES */
        .map-container { max-width: 1200px; margin: 20px auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        .map-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .map-logo { font-size: 1.1em; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; }
        .search-container { position: relative; flex: 1; min-width: 200px; max-width: 100%; }
        .search-input { width: 100%; padding: 10px 35px 10px 12px; border: none; border-radius: 8px; font-size: 0.95em; }
        .search-input:focus { outline: none; box-shadow: 0 0 8px rgba(0,0,0,0.2); }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #00A854; }
        .map-controls { display: flex; gap: 6px; flex-wrap: wrap; }
        .map-btn { padding: 8px 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.85em; transition: all 0.3s; white-space: nowrap; }
        .map-btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #00A854; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-outline { background: white; color: #333; }
        #map { height: 400px; width: 100%; }

        .booking-section { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
        .booking-container { background: white; border-radius: 15px; padding: 25px 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .booking-header { text-align: center; margin-bottom: 25px; }
        .booking-header h2 { font-size: 1.6em; color: #00A854; margin-bottom: 8px; }
        .booking-header p { color: #666; font-size: 0.95em; }
        .booking-form { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #333; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; font-size: 0.95em; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95em; transition: all 0.3s; width: 100%; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #00A854; }
        .input-with-button { display: flex; gap: 6px; width: 100%; }
        .input-with-button input { flex: 1; min-width: 0; }
        .btn-map-select { padding: 12px 10px; background: linear-gradient(135deg, #00A854, #FECB00); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 4px; font-size: 0.85em; flex-shrink: 0; }
        .btn-map-select:hover { transform: scale(1.02); }
        .btn-gps { background: linear-gradient(135deg, #2196F3, #00BCD4); }
        .btn-gps.loading i { animation: spin 1s linear infinite; }
        .btn-gps.success { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        .btn-gps.error { background: linear-gradient(135deg, #E30613, #F44336); }
        .datetime-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .vehicle-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 8px; }
        .vehicle-option { border: 2px solid #ddd; border-radius: 10px; padding: 12px 8px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f9f9f9; }
        .vehicle-option:hover { border-color: #FECB00; }
        .vehicle-option.selected { border-color: #00A854; background: #e8f5e9; }
        .vehicle-option-icon { font-size: 1.8em; margin-bottom: 6px; }
        .vehicle-option-name { font-weight: bold; font-size: 0.85em; }
        .vehicle-option-price { color: #00A854; font-weight: bold; font-size: 0.8em; margin-top: 4px; }

        .payment-methods { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; }
        .payment-method { padding: 10px 6px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f9f9f9; }
        .payment-method:hover { border-color: #FECB00; }
        .payment-method.selected { border-color: #00A854; background: #e8f5e9; }
        .payment-method-icon { font-size: 1.3em; margin-bottom: 4px; }
        .payment-method-name { font-size: 0.75em; font-weight: 600; }
        .payment-method.wallet-option { background: linear-gradient(135deg, #eff6ff, #e0e7ff); border-color: #2563eb; }
        .payment-method.wallet-option .payment-method-icon { color: #2563eb; }
        .wallet-balance-mini { font-size: 0.65em; color: #16a34a; font-weight: bold; }

        .booking-summary { background: linear-gradient(135deg, #00A854, #FECB00); padding: 20px 15px; border-radius: 12px; color: white; margin-top: 20px; display: none; }
        .summary-title { font-size: 1.2em; font-weight: bold; margin-bottom: 12px; text-align: center; }
        .summary-items { background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; gap: 10px; }
        .summary-item span:last-child { text-align: right; }
        .summary-total { background: rgba(255,255,255,0.3); padding: 10px 12px; border-radius: 8px; display: flex; justify-content: space-between; font-size: 1.1em; font-weight: bold; }
        .booking-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-book { padding: 14px 10px; font-size: 1em; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.3s; }
        .btn-book:hover { transform: scale(1.02); }
        .btn-book-primary { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-book-secondary { background: white; color: #00A854; border: 2px solid #00A854; }

        /* TRACKING MODAL */
        .tracking-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; overflow-y: auto; }
        .tracking-modal.active { display: block; }
        .tracking-container { max-width: 500px; margin: 10px auto; background: white; border-radius: 15px; overflow: hidden; min-height: calc(100vh - 20px); }
        .tracking-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .tracking-header h2 { font-size: 1.2em; display: flex; align-items: center; gap: 8px; }
        .tracking-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        
        #trackingMap { height: 280px; width: 100%; }
        .tracking-info { padding: 15px; }
        
        .route-mode-badge { background: linear-gradient(135deg, #2196F3, #00BCD4); padding: 10px 15px; border-radius: 12px; color: white; margin-bottom: 15px; text-align: center; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .route-mode-badge.course-mode { background: linear-gradient(135deg, #00A854, #FECB00); }
        
        .driver-approaching-box { background: linear-gradient(135deg, #2196F3, #00BCD4); padding: 18px; border-radius: 12px; color: white; margin-bottom: 15px; text-align: center; }
        .driver-approaching-title { font-size: 0.95em; opacity: 0.9; margin-bottom: 8px; }
        .driver-eta { font-size: 2.2em; font-weight: bold; margin-bottom: 4px; }
        .driver-eta-label { font-size: 0.85em; opacity: 0.9; }
        .driver-details-row { display: flex; justify-content: space-around; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.3); }
        .driver-detail { text-align: center; }
        .driver-detail-value { font-size: 1.2em; font-weight: bold; }
        .driver-detail-label { font-size: 0.7em; opacity: 0.8; }

        .status-timeline { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .status-step { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
        .status-step:last-child { border-bottom: none; }
        .status-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1em; background: #e0e0e0; color: #999; flex-shrink: 0; }
        .status-icon.active { background: #00A854; color: white; }
        .status-icon.current { background: #2196F3; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .status-text { flex: 1; min-width: 0; }
        .status-text h4 { font-size: 0.9em; color: #333; margin-bottom: 2px; }
        .status-text p { font-size: 0.75em; color: #666; }
        .status-time { font-size: 0.75em; color: #999; flex-shrink: 0; }

        .driver-card { background: white; border: 2px solid #e0e0e0; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .driver-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .driver-avatar { width: 55px; height: 55px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.6em; color: white; flex-shrink: 0; overflow: hidden; }
        .driver-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .driver-info { flex: 1; min-width: 0; }
        .driver-info h3 { font-size: 1em; color: #333; margin-bottom: 4px; }
        .driver-info p { font-size: 0.85em; color: #666; }
        .driver-rating { color: #FFC107; }
        .driver-vehicle { background: #f5f5f5; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .vehicle-info { display: flex; align-items: center; gap: 8px; }
        .vehicle-icon { font-size: 1.4em; }
        
        .driver-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .driver-action-btn { padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85em; }
        .btn-call { background: #00A854; color: white; }
        .btn-message { background: #2196F3; color: white; }

        .trip-details { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .trip-details h3 { font-size: 0.95em; color: #333; margin-bottom: 12px; }
        .trip-route { display: flex; flex-direction: column; gap: 12px; }
        .trip-point { display: flex; align-items: flex-start; gap: 10px; }
        .trip-point-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85em; color: white; flex-shrink: 0; }
        .trip-point-icon.start { background: #4CAF50; }
        .trip-point-icon.end { background: #E30613; }
        .trip-point-text { flex: 1; min-width: 0; }
        .trip-point-label { font-size: 0.7em; color: #666; text-transform: uppercase; }
        .trip-point-address { font-size: 0.9em; color: #333; font-weight: 500; word-wrap: break-word; }
        .trip-connector { width: 2px; height: 20px; background: #ddd; margin-left: 13px; }
        .trip-price { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 2px dashed #ddd; }
        .trip-price-label { font-size: 0.85em; color: #666; }
        .trip-price-value { font-size: 1.3em; font-weight: bold; color: #00A854; }

        /* BOUTON VALIDER PAIEMENT */
        .validate-payment-btn { 
            width: 100%; 
            padding: 16px; 
            background: linear-gradient(135deg, #9333ea, #7c3aed); 
            border: none; 
            color: white; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 12px; 
            font-size: 1.1em; 
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
            animation: pulseGlow 2s infinite;
        }
        .validate-payment-btn:hover { 
            transform: scale(1.02); 
            box-shadow: 0 12px 30px rgba(124, 58, 237, 0.5);
        }
        .validate-payment-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            animation: none;
        }
        .validate-payment-btn.processing {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            animation: none;
        }
        .validate-payment-btn.success {
            background: linear-gradient(135deg, #10b981, #059669);
            animation: none;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4); }
            50% { box-shadow: 0 8px 35px rgba(124, 58, 237, 0.6); }
        }

        .payment-info-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }
        .payment-info-box.show { display: block; }
        .payment-info-title { font-weight: bold; color: #92400e; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .payment-info-text { font-size: 0.85em; color: #78350f; }
        .payment-info-amount { font-size: 1.3em; font-weight: bold; color: #b45309; margin-top: 8px; }

        .cancel-booking-btn { width: 100%; padding: 14px; background: #f5f5f5; border: 2px solid #E30613; color: #E30613; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 8px; font-size: 0.95em; }
        .cancel-booking-btn:hover { background: #E30613; color: white; }

        /* EVALUATION MODAL */
        .evaluation-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10005; display: none; align-items: center; justify-content: center; padding: 15px; overflow-y: auto; }
        .evaluation-modal.active { display: flex; }
        .evaluation-container { background: white; border-radius: 15px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .evaluation-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 20px 15px; color: white; text-align: center; border-radius: 15px 15px 0 0; }
        .evaluation-header h2 { font-size: 1.4em; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .evaluation-header p { font-size: 0.9em; opacity: 0.95; }
        .evaluation-content { padding: 20px 15px; }
        
        .evaluation-driver-summary { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .evaluation-driver-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; color: white; flex-shrink: 0; overflow: hidden; }
        .evaluation-driver-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .evaluation-driver-info h3 { font-size: 1em; color: #333; margin-bottom: 4px; }
        .evaluation-driver-info p { font-size: 0.85em; color: #666; }
        
        .rating-section { margin-bottom: 25px; }
        .rating-section h3 { font-size: 1em; color: #333; margin-bottom: 12px; text-align: center; }
        .star-rating { display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .star { font-size: 2.5em; color: #ddd; cursor: pointer; transition: all 0.2s; }
        .star:hover, .star.active { color: #FFC107; transform: scale(1.1); }
        .rating-label { text-align: center; font-size: 0.9em; color: #666; font-weight: 600; min-height: 24px; }
        
        .criteria-section { margin-bottom: 25px; }
        .criteria-section h3 { font-size: 1em; color: #333; margin-bottom: 15px; }
        .criteria-item { margin-bottom: 15px; }
        .criteria-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .criteria-label { font-size: 0.9em; color: #333; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .criteria-value { font-size: 0.85em; color: #00A854; font-weight: bold; }
        .criteria-stars { display: flex; gap: 4px; }
        .criteria-star { font-size: 1.2em; color: #ddd; cursor: pointer; transition: all 0.2s; }
        .criteria-star:hover, .criteria-star.active { color: #FFC107; }
        
        .comment-section { margin-bottom: 20px; }
        .comment-section h3 { font-size: 1em; color: #333; margin-bottom: 10px; }
        .comment-textarea { width: 100%; min-height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 0.9em; resize: vertical; }
        .comment-textarea:focus { outline: none; border-color: #00A854; }
        .comment-counter { text-align: right; font-size: 0.8em; color: #999; margin-top: 4px; }
        
        .evaluation-actions { display: flex; gap: 10px; padding-top: 15px; border-top: 1px solid #e0e0e0; }
        .evaluation-btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-weight: bold; font-size: 1em; cursor: pointer; transition: all 0.3s; }
        .btn-skip { background: #f5f5f5; color: #666; }
        .btn-submit-evaluation { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-submit-evaluation:disabled { opacity: 0.5; cursor: not-allowed; }

        /* PERMISSION MODAL */
        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10002; display: none; align-items: center; justify-content: center; padding: 20px; }
        .permission-modal.active { display: flex; }
        .permission-content { background: white; border-radius: 15px; padding: 25px 20px; max-width: 400px; width: 100%; text-align: center; }
        .permission-icon { font-size: 3em; margin-bottom: 15px; }
        .permission-title { font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 12px; }
        .permission-text { color: #666; line-height: 1.5; margin-bottom: 20px; font-size: 0.95em; }
        .permission-steps { background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
        .permission-steps h4 { font-size: 0.9em; color: #333; margin-bottom: 10px; }
        .permission-steps ol { margin-left: 20px; color: #666; font-size: 0.85em; }
        .permission-steps li { margin-bottom: 6px; }
        .permission-actions { display: flex; gap: 10px; }
        .permission-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.95em; }
        .btn-allow { background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; }
        .btn-cancel { background: #f5f5f5; color: #666; }

        /* NOTIFICATIONS */
        .notification { position: fixed; top: 15px; right: 15px; left: 15px; max-width: 400px; margin: 0 auto; padding: 12px 20px; border-radius: 10px; color: white; font-weight: 600; z-index: 10001; animation: slideIn 0.3s; box-shadow: 0 8px 25px rgba(0,0,0,0.3); font-size: 0.9em; }
        @keyframes slideIn { from { transform: translateY(-100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #E30613; }
        .notification.info { background: #2196F3; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.2); border-top-color: #FECB00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 1.1em; margin-top: 18px; }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            body { font-size: 14px; }
            .hero-section { padding: 30px 12px; }
            .hero-cta { margin-bottom: 10px; }
            .payment-methods { grid-template-columns: repeat(2, 1fr); }
            #map { height: 320px; }
            .wallet-container { margin: 5px; }
        }
        
        @media (max-width: 380px) {
            .hero-title { font-size: 1.4em; }
            .payment-methods { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Chargement...</div>
    </div>

    <section class="hero-section">
        <img src="https://i.imgur.com/VtgG6pR.png" alt="Al Bourakh" class="hero-logo" onerror="this.style.display='none'">
        <h1 class="hero-title"><i class="fas fa-route"></i> Al Bourakh</h1>
        <p class="hero-subtitle">üöï Transport VTC ‚Ä¢ Paiement Int√©gr√© ‚Ä¢ 24/7</p>
        <div>
            <button class="hero-cta" onclick="scrollToBooking()">
                <i class="fas fa-car"></i> R√©server
            </button>
            <button class="hero-cta wallet-btn" onclick="openWallet()">
                <i class="fas fa-wallet"></i> Mon Portefeuille
            </button>
        </div>
    </section>

    <!-- WALLET MODAL -->
    <div class="wallet-modal" id="walletModal">
        <div class="wallet-container">
            <div class="wallet-header">
                <div style="display: flex; align-items: center;">
                    <button class="back-btn hidden" id="walletBackBtn" onclick="showWalletScreen('dashboard')">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2><i class="fas fa-wallet"></i> <span id="walletTitle">Mon Portefeuille</span></h2>
                </div>
                <button class="wallet-close" onclick="closeWallet()">√ó</button>
            </div>
            <div class="wallet-content" id="walletContent">
                <div class="wallet-screen active" id="walletDashboard"></div>
                <div class="wallet-screen" id="walletRecharge"></div>
                <div class="wallet-screen" id="walletHistory"></div>
                <div class="wallet-screen" id="walletSuccess"></div>
            </div>
        </div>
    </div>

    <div class="map-container">
        <div class="map-header">
            <div class="map-logo">üöï Al Bourakh GPS</div>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Rechercher une adresse...">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="map-controls">
                <button class="map-btn btn-secondary" onclick="findMyLocation()">
                    <i class="fas fa-location-arrow"></i> Position
                </button>
                <button class="map-btn btn-outline" onclick="toggleTraffic()">
                    <i class="fas fa-traffic-light"></i> Trafic
                </button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <section class="booking-section">
        <div class="booking-container">
            <div class="booking-header">
                <h2>üöï R√©servez votre trajet</h2>
                <p>R√©servation simple et rapide</p>
            </div>

            <form class="booking-form" id="bookingForm" onsubmit="return false;">
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> Point de d√©part</label>
                    <div class="input-with-button">
                        <input type="text" id="bookingFrom" required placeholder="Votre position...">
                        <button type="button" class="btn-map-select btn-gps" onclick="getCurrentPosition()" title="Utiliser ma position actuelle">
                            <i class="fas fa-crosshairs" id="gpsIcon"></i> GPS
                        </button>
                        <button type="button" class="btn-map-select" onclick="selectOnMap('from')">
                            <i class="fas fa-map"></i> Carte
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-flag-checkered"></i> Destination</label>
                    <div class="input-with-button">
                        <input type="text" id="bookingTo" required placeholder="O√π allez-vous?">
                        <button type="button" class="btn-map-select" onclick="selectOnMap('to')">
                            <i class="fas fa-map"></i> Carte
                        </button>
                    </div>
                </div>
                
                <div class="datetime-group">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="bookingDate" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Heure</label>
                        <input type="time" id="bookingTime" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-phone"></i> T√©l√©phone</label>
                    <input type="tel" id="bookingPhone" required placeholder="+221 77 XXX XX XX">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Nom (optionnel)</label>
                    <input type="text" id="bookingName" placeholder="Votre nom">
                </div>
            </form>

            <div style="margin-top: 25px;">
                <h3 style="text-align: center; color: #00A854; margin-bottom: 12px; font-size: 1.1em;">
                    <i class="fas fa-car"></i> Type de v√©hicule
                </h3>
                <div class="vehicle-options">
                    <div class="vehicle-option" onclick="selectVehicle('standard', 1500)">
                        <div class="vehicle-option-icon">üöó</div>
                        <div class="vehicle-option-name">Standard</div>
                        <div class="vehicle-option-price">1 500 FCFA+</div>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('confort', 2000)">
                        <div class="vehicle-option-icon">‚ú®</div>
                        <div class="vehicle-option-name">Confort</div>
                        <div class="vehicle-option-price">2 000 FCFA+</div>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('van', 2500)">
                        <div class="vehicle-option-icon">üöê</div>
                        <div class="vehicle-option-name">Van</div>
                        <div class="vehicle-option-price">2 500 FCFA+</div>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('premium', 3500)">
                        <div class="vehicle-option-icon">üëë</div>
                        <div class="vehicle-option-name">Premium</div>
                        <div class="vehicle-option-price">3 500 FCFA+</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <h3 style="text-align: center; color: #00A854; margin-bottom: 12px; font-size: 1.1em;">
                    <i class="fas fa-credit-card"></i> Paiement
                </h3>
                <div class="payment-methods" id="paymentMethods">
                    <div class="payment-method" onclick="selectPayment('cash')">
                        <div class="payment-method-icon">üíµ</div>
                        <div class="payment-method-name">Esp√®ces</div>
                    </div>
                    <div class="payment-method" onclick="selectPayment('orange')">
                        <div class="payment-method-icon">üì±</div>
                        <div class="payment-method-name">Orange Money</div>
                    </div>
                    <div class="payment-method" onclick="selectPayment('wave')">
                        <div class="payment-method-icon">üí≥</div>
                        <div class="payment-method-name">Wave</div>
                    </div>
                    <div class="payment-method wallet-option" onclick="selectPayment('wallet')">
                        <div class="payment-method-icon">üëõ</div>
                        <div class="payment-method-name">Portefeuille</div>
                        <div class="wallet-balance-mini" id="walletBalanceMini">0 FCFA</div>
                    </div>
                </div>
            </div>

            <div class="booking-summary" id="bookingSummary">
                <div class="summary-title">üìã R√©capitulatif</div>
                <div class="summary-items">
                    <div class="summary-item"><span>Trajet:</span><span id="summaryRoute">-</span></div>
                    <div class="summary-item"><span>Date:</span><span id="summaryDateTime">-</span></div>
                    <div class="summary-item"><span>V√©hicule:</span><span id="summaryVehicle">-</span></div>
                    <div class="summary-item"><span>Paiement:</span><span id="summaryPayment">-</span></div>
                </div>
                <div class="summary-total">
                    <span>Total estim√©:</span>
                    <span id="summaryTotal">0 FCFA</span>
                </div>
            </div>

            <div class="booking-actions">
                <button type="button" class="btn-book btn-book-secondary" onclick="previewBooking()">
                    <i class="fas fa-eye"></i> Aper√ßu
                </button>
                <button type="button" class="btn-book btn-book-primary" onclick="confirmBooking()">
                    <i class="fas fa-check"></i> Confirmer
                </button>
            </div>
        </div>
    </section>

    <!-- TRACKING MODAL -->
    <div class="tracking-modal" id="trackingModal">
        <div class="tracking-container">
            <div class="tracking-header">
                <h2><i class="fas fa-route"></i> Suivi de course</h2>
                <button class="tracking-close" onclick="closeTracking()">√ó</button>
            </div>
            <div id="trackingMap"></div>
            <div class="tracking-info">
                <div class="route-mode-badge" id="routeModeBadge" style="display: none;">
                    <i class="fas fa-car-side"></i>
                    <span id="routeModeText">Chauffeur en approche</span>
                </div>
                <div class="driver-approaching-box" id="driverApproachingBox">
                    <div class="driver-approaching-title">üöó Votre chauffeur arrive</div>
                    <div class="driver-eta" id="driverETA">--</div>
                    <div class="driver-eta-label">minutes</div>
                    <div class="driver-details-row">
                        <div class="driver-detail">
                            <div class="driver-detail-value" id="driverDistance">--</div>
                            <div class="driver-detail-label">Distance</div>
                        </div>
                        <div class="driver-detail">
                            <div class="driver-detail-value" id="driverArrivalTime">--</div>
                            <div class="driver-detail-label">Arriv√©e pr√©vue</div>
                        </div>
                    </div>
                </div>
                
                <!-- INFO BOX PAIEMENT -->
                <div class="payment-info-box" id="paymentInfoBox">
                    <div class="payment-info-title">
                        <i class="fas fa-info-circle"></i> Paiement en attente
                    </div>
                    <div class="payment-info-text" id="paymentInfoText">
                        Votre paiement sera d√©bit√© √† la fin de la course.
                    </div>
                    <div class="payment-info-amount" id="paymentInfoAmount">0 FCFA</div>
                </div>
                
                <div class="status-timeline">
                    <div class="status-step" id="step1">
                        <div class="status-icon active"><i class="fas fa-check"></i></div>
                        <div class="status-text"><h4>R√©servation confirm√©e</h4><p>Votre course a √©t√© enregistr√©e</p></div>
                        <div class="status-time" id="step1Time">--:--</div>
                    </div>
                    <div class="status-step" id="step2">
                        <div class="status-icon" id="step2Icon"><i class="fas fa-user-check"></i></div>
                        <div class="status-text"><h4>Chauffeur assign√©</h4><p id="step2Text">En attente d'un chauffeur...</p></div>
                        <div class="status-time" id="step2Time">--:--</div>
                    </div>
                    <div class="status-step" id="step3">
                        <div class="status-icon" id="step3Icon"><i class="fas fa-car"></i></div>
                        <div class="status-text"><h4>Chauffeur en route</h4><p id="step3Text">Le chauffeur se dirige vers vous</p></div>
                        <div class="status-time" id="step3Time">--:--</div>
                    </div>
                    <div class="status-step" id="step4">
                        <div class="status-icon" id="step4Icon"><i class="fas fa-map-pin"></i></div>
                        <div class="status-text"><h4>Chauffeur arriv√©</h4><p>Le chauffeur est au point de prise en charge</p></div>
                        <div class="status-time" id="step4Time">--:--</div>
                    </div>
                    <div class="status-step" id="step5">
                        <div class="status-icon" id="step5Icon"><i class="fas fa-flag-checkered"></i></div>
                        <div class="status-text"><h4>Course en cours</h4><p>Direction votre destination</p></div>
                        <div class="status-time" id="step5Time">--:--</div>
                    </div>
                    <div class="status-step" id="step6">
                        <div class="status-icon" id="step6Icon"><i class="fas fa-credit-card"></i></div>
                        <div class="status-text"><h4>Paiement</h4><p id="step6Text">En attente de validation</p></div>
                        <div class="status-time" id="step6Time">--:--</div>
                    </div>
                </div>
                
                <div class="driver-card" id="driverCard" style="display: none;">
                    <div class="driver-card-header">
                        <div class="driver-avatar" id="driverAvatar">üë§</div>
                        <div class="driver-info">
                            <h3 id="driverName">Chauffeur</h3>
                            <p><span class="driver-rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span> <span id="driverRating">4.9</span></p>
                        </div>
                    </div>
                    <div class="driver-vehicle">
                        <div class="vehicle-info">
                            <span class="vehicle-icon">üöó</span>
                            <div>
                                <div id="vehicleModel" style="font-weight: bold; font-size: 0.9em;">Toyota Corolla</div>
                                <div id="vehiclePlate" style="font-size: 0.75em; color: #666;">DK-1234-AB</div>
                            </div>
                        </div>
                    </div>
                    <div class="driver-actions">
                        <button class="driver-action-btn btn-call" onclick="callDriver()"><i class="fas fa-phone"></i> Appeler</button>
                        <button class="driver-action-btn btn-message" onclick="messageDriver()"><i class="fas fa-comment"></i> Message</button>
                    </div>
                </div>
                
                <div class="trip-details">
                    <h3>üó∫Ô∏è D√©tails du trajet</h3>
                    <div class="trip-route">
                        <div class="trip-point">
                            <div class="trip-point-icon start"><i class="fas fa-circle"></i></div>
                            <div class="trip-point-text"><div class="trip-point-label">D√©part</div><div class="trip-point-address" id="tripFrom">-</div></div>
                        </div>
                        <div class="trip-connector"></div>
                        <div class="trip-point">
                            <div class="trip-point-icon end"><i class="fas fa-flag"></i></div>
                            <div class="trip-point-text"><div class="trip-point-label">Destination</div><div class="trip-point-address" id="tripTo">-</div></div>
                        </div>
                    </div>
                    <div class="trip-price">
                        <span class="trip-price-label">Prix estim√©</span>
                        <span class="trip-price-value" id="tripPrice">0 FCFA</span>
                    </div>
                </div>
                
                <!-- BOUTON VALIDER PAIEMENT -->
                <button class="validate-payment-btn" id="validatePaymentBtn" onclick="validatePayment()">
                    <i class="fas fa-check-circle"></i>
                    <span id="validatePaymentText">Valider le paiement</span>
                </button>
                
                <button class="cancel-booking-btn" id="cancelBookingBtn" onclick="cancelBooking()">
                    <i class="fas fa-times"></i> Annuler la r√©servation
                </button>
            </div>
        </div>
    </div>

    <!-- EVALUATION MODAL -->
    <div class="evaluation-modal" id="evaluationModal">
        <div class="evaluation-container">
            <div class="evaluation-header">
                <h2><i class="fas fa-star"></i> √âvaluez votre course</h2>
                <p>Votre avis nous aide √† am√©liorer notre service</p>
            </div>
            <div class="evaluation-content">
                <div class="evaluation-driver-summary">
                    <div class="evaluation-driver-avatar" id="evalDriverAvatar">üë§</div>
                    <div class="evaluation-driver-info">
                        <h3 id="evalDriverName">Chauffeur</h3>
                        <p id="evalVehicle">Toyota Corolla ‚Ä¢ DK-1234-AB</p>
                    </div>
                </div>
                <div class="rating-section">
                    <h3>Note globale</h3>
                    <div class="star-rating" id="overallRating">
                        <span class="star" data-rating="1">‚òÖ</span>
                        <span class="star" data-rating="2">‚òÖ</span>
                        <span class="star" data-rating="3">‚òÖ</span>
                        <span class="star" data-rating="4">‚òÖ</span>
                        <span class="star" data-rating="5">‚òÖ</span>
                    </div>
                    <div class="rating-label" id="overallRatingLabel">S√©lectionnez une note</div>
                </div>
                <div class="criteria-section">
                    <h3>Crit√®res d'√©valuation</h3>
                    <div class="criteria-item">
                        <div class="criteria-header"><span class="criteria-label"><i class="fas fa-car" style="color: #2196F3;"></i> Conduite</span><span class="criteria-value" id="conduiteValue">-</span></div>
                        <div class="criteria-stars" id="conduiteRating">
                            <span class="criteria-star" data-criteria="conduite" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-header"><span class="criteria-label"><i class="fas fa-clock" style="color: #FF9800;"></i> Ponctualit√©</span><span class="criteria-value" id="ponctualiteValue">-</span></div>
                        <div class="criteria-stars" id="ponctualiteRating">
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-header"><span class="criteria-label"><i class="fas fa-spray-can" style="color: #00BCD4;"></i> Propret√©</span><span class="criteria-value" id="propreteValue">-</span></div>
                        <div class="criteria-stars" id="propreteRating">
                            <span class="criteria-star" data-criteria="proprete" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-header"><span class="criteria-label"><i class="fas fa-smile" style="color: #4CAF50;"></i> Amabilit√©</span><span class="criteria-value" id="amabiliteValue">-</span></div>
                        <div class="criteria-stars" id="amabiliteRating">
                            <span class="criteria-star" data-criteria="amabilite" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                </div>
                <div class="comment-section">
                    <h3><i class="fas fa-comment-dots"></i> Commentaire (optionnel)</h3>
                    <textarea id="evaluationComment" class="comment-textarea" placeholder="Partagez votre exp√©rience..." maxlength="500"></textarea>
                    <div class="comment-counter"><span id="commentLength">0</span>/500</div>
                </div>
                <div class="evaluation-actions">
                    <button class="evaluation-btn btn-skip" id="skipEvaluationBtn">Plus tard</button>
                    <button class="evaluation-btn btn-submit-evaluation" id="submitEvaluationBtn" disabled><i class="fas fa-paper-plane"></i> Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PERMISSION MODAL -->
    <div class="permission-modal" id="permissionModal">
        <div class="permission-content">
            <div class="permission-icon">üìç</div>
            <div class="permission-title">Activer la g√©olocalisation</div>
            <div class="permission-text">Al Bourakh a besoin d'acc√©der √† votre position pour vous offrir le meilleur service.</div>
            <div class="permission-steps">
                <h4>üí° Comment activer :</h4>
                <ol>
                    <li>Appuyez sur l'ic√¥ne üîí ou ‚ìò dans la barre d'adresse</li>
                    <li>Trouvez "Position" ou "Localisation"</li>
                    <li>S√©lectionnez "Autoriser"</li>
                    <li>Rechargez la page</li>
                </ol>
            </div>
            <div class="permission-actions">
                <button class="permission-btn btn-cancel" onclick="closePermissionModal()">Plus tard</button>
                <button class="permission-btn btn-allow" onclick="requestLocationPermission()">Autoriser</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
            authDomain: "albourakh-sn-ok.firebaseapp.com",
            projectId: "albourakh-sn-ok",
            storageBucket: "albourakh-sn-ok.firebasestorage.app",
            messagingSenderId: "297875396274",
            appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log('üöï Al Bourakh Client v3.2 - Permissions Firebase Corrig√©es');

        // ========== WALLET STATE ==========
        let walletState = {
            balance: 45000,
            loyaltyPoints: 350,
            transactions: [
                { id: 'TR001', date: new Date().toISOString(), from: 'Plateau', to: 'Almadies', amount: 3500, driver: 'Ibrahima Sarr', vehicle: 'Toyota Corolla', payment: 'Orange Money', tip: 500, status: 'completed', type: 'ride' },
                { id: 'TR002', date: new Date(Date.now() - 86400000).toISOString(), from: 'Mermoz', to: 'HLM', amount: 2500, driver: 'Cheikh Fall', vehicle: 'Renault Clio', payment: 'Wave', tip: 0, status: 'completed', type: 'ride' },
                { id: 'RCH001', date: new Date(Date.now() - 172800000).toISOString(), amount: 20000, method: 'Orange Money', status: 'completed', type: 'recharge' }
            ],
            rechargeAmount: '',
            rechargeMethod: 'Orange Money',
            currentScreen: 'dashboard'
        };

        // ========== GLOBAL VARIABLES ==========
        let map, trackingMap, trafficLayer, autocomplete, geocoder;
        let directionsService, directionsRenderer, trackingDirectionsRenderer;
        let userMarker, departureMarker, destinationMarker, driverMarker, clientPickupMarker;
        let selectedVehicle = null, selectedVehiclePrice = 0, selectedPayment = null;
        let mapSelectionMode = null;
        let departureCoords = null, destinationCoords = null;
        let currentBooking = null;
        let reservationListener = null, driverListener = null;
        let lastDriverPosition = null, trackingUpdateInterval = null;
        let currentTrackingMode = 'approche';
        let simulationMode = false, simulatedDriverPosition = null;
        let evaluationData = { noteGlobale: 0, conduite: 0, ponctualite: 0, proprete: 0, amabilite: 0, commentaire: '' };
        let driverPhotoUrl = null;
        
        // √âtat de paiement
        let paymentValidated = false;
        let paymentProcessing = false;

        // ========== COMMISSION RATES ==========
        const COMMISSION_RATE = 0.30; // 30% pour Al Bourakh
        const DRIVER_RATE = 0.70;     // 70% pour le chauffeur

        // ========== DRIVER PHOTO FUNCTIONS ==========
        function normalizePhoneForComparison(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, '');
        }

        function getPhoneVariants(phone) {
            const digits = normalizePhoneForComparison(phone);
            const variants = new Set();
            variants.add(digits);
            const localNumber = digits.slice(-9);
            variants.add(localNumber);
            variants.add('+221' + localNumber);
            variants.add('221' + localNumber);
            variants.add('00221' + localNumber);
            if (digits.startsWith('221')) {
                variants.add('+' + digits);
                const local = digits.substring(3);
                variants.add(local);
                variants.add('+221' + local);
            }
            if (digits.startsWith('+221')) {
                variants.add(digits.substring(1));
                variants.add(digits.substring(4));
            }
            return [...variants].filter(v => {
                const cleaned = v.replace(/\D/g, '');
                return cleaned.length >= 9;
            });
        }

        async function fetchDriverPhoto(driverId, driverPhone, driverNom, driverPrenom) {
            console.log('üì∏ Recherche photo chauffeur:', { driverId, driverPhone, driverNom, driverPrenom });
            
            try {
                console.log('üì° Recherche dans drivers...');
                const driverDoc = await db.collection('drivers').doc(driverId).get();
                if (driverDoc.exists) {
                    const driverData = driverDoc.data();
                    const photoUrl = driverData.photoProfil || 
                                   driverData.photoIdentite || 
                                   driverData.photoUrl || 
                                   driverData.photo ||
                                   driverData.profilePhoto ||
                                   driverData.avatar ||
                                   driverData.image ||
                                   driverData.photos?.photoProfil || 
                                   driverData.photos?.photoIdentite;
                    
                    if (photoUrl) {
                        console.log('‚úÖ Photo trouv√©e dans drivers:', photoUrl);
                        return photoUrl;
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur recherche dans drivers:', error);
            }
            
            try {
                console.log('üì° Recherche dans candidatures par ID...');
                const candidatureDoc = await db.collection('candidatures').doc(driverId).get();
                if (candidatureDoc.exists) {
                    const candidature = candidatureDoc.data();
                    const photoUrl = candidature.photoProfil || 
                                   candidature.photoIdentite ||
                                   candidature.photo ||
                                   candidature.photoUrl ||
                                   candidature.photos?.photoProfil ||
                                   candidature.photos?.photoIdentite;
                    
                    if (photoUrl) {
                        console.log('‚úÖ Photo trouv√©e dans candidatures:', photoUrl);
                        return photoUrl;
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur recherche candidature:', error);
            }
            
            if (driverPhone) {
                try {
                    const phoneVariants = getPhoneVariants(driverPhone);
                    const candidaturesSnapshot = await db.collection('candidatures').where('statut', '==', 'acceptee').get();
                    
                    for (const doc of candidaturesSnapshot.docs) {
                        const candidature = doc.data();
                        const candidaturePhone = candidature.telephone || candidature.phone || '';
                        const candidatureDigits = normalizePhoneForComparison(candidaturePhone);
                        
                        for (const variant of phoneVariants) {
                            const variantDigits = normalizePhoneForComparison(variant);
                            if (candidatureDigits === variantDigits || 
                                candidatureDigits.endsWith(variantDigits.slice(-9)) ||
                                variantDigits.endsWith(candidatureDigits.slice(-9))) {
                                
                                const photoUrl = candidature.photoProfil || 
                                               candidature.photoIdentite ||
                                               candidature.photo ||
                                               candidature.photos?.photoProfil ||
                                               candidature.photos?.photoIdentite;
                                
                                if (photoUrl) {
                                    console.log('‚úÖ Photo trouv√©e par t√©l√©phone:', photoUrl);
                                    return photoUrl;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur recherche par t√©l√©phone:', error);
                }
            }
            
            console.log('‚ùå Aucune photo trouv√©e');
            return null;
        }

        // ========== PAYMENT VALIDATION FUNCTIONS ==========
        
        function isDigitalPayment(paymentMethod) {
            const digitalMethods = ['orange', 'wave', 'wallet', 'Orange Money', 'Wave', 'Portefeuille Al Bourakh'];
            return digitalMethods.includes(paymentMethod);
        }

        function showPaymentButton() {
            const btn = document.getElementById('validatePaymentBtn');
            const infoBox = document.getElementById('paymentInfoBox');
            
            if (currentBooking && isDigitalPayment(currentBooking.modePaiement || selectedPayment)) {
                btn.style.display = 'flex';
                infoBox.classList.add('show');
                
                const methodNames = {
                    'orange': 'Orange Money',
                    'wave': 'Wave',
                    'wallet': 'Portefeuille Al Bourakh',
                    'Orange Money': 'Orange Money',
                    'Wave': 'Wave',
                    'Portefeuille Al Bourakh': 'Portefeuille Al Bourakh'
                };
                
                const methodName = methodNames[currentBooking.modePaiement || selectedPayment] || 'Mobile Money';
                document.getElementById('paymentInfoText').textContent = 
                    `Paiement via ${methodName}. Validez pour finaliser.`;
                document.getElementById('paymentInfoAmount').textContent = 
                    `${(currentBooking.prixEstime || 0).toLocaleString()} FCFA`;
            } else {
                btn.style.display = 'none';
                infoBox.classList.remove('show');
            }
        }

        function hidePaymentButton() {
            document.getElementById('validatePaymentBtn').style.display = 'none';
            document.getElementById('paymentInfoBox').classList.remove('show');
        }

async function validatePayment() {
    if (!currentBooking || paymentProcessing || paymentValidated) return;
    
    const paymentMethod = currentBooking.modePaiement || selectedPayment;
    
    if (!isDigitalPayment(paymentMethod)) {
        showNotification('‚ÑπÔ∏è Paiement en esp√®ces - Aucune validation n√©cessaire', 'info');
        return;
    }

    const amount = currentBooking.prixEstime || 0;
    const driverShare = Math.round(amount * DRIVER_RATE);
    const commission = Math.round(amount * COMMISSION_RATE);

    // V√©rifier le solde pour le portefeuille
    if ((paymentMethod === 'wallet' || paymentMethod === 'Portefeuille Al Bourakh') && walletState.balance < amount) {
        showNotification(`‚ùå Solde insuffisant. Vous avez ${walletState.balance.toLocaleString()} FCFA`, 'error');
        return;
    }

    if (!confirm(`Confirmer le paiement de ${amount.toLocaleString()} FCFA via ${paymentMethod}?\n\nR√©partition:\n- Chauffeur (70%): ${driverShare.toLocaleString()} FCFA\n- Commission Al Bourakh (30%): ${commission.toLocaleString()} FCFA`)) {
        return;
    }

    paymentProcessing = true;
    const btn = document.getElementById('validatePaymentBtn');
    const btnText = document.getElementById('validatePaymentText');
    
    btn.classList.add('processing');
    btn.disabled = true;
    btnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement en cours...';

    showLoading('Validation du paiement...');

    // Variables pour rollback en cas d'erreur
    let clientDebited = false;
    let reservationUpdated = false;
    let driverCredited = false;

    try {
        // ========== √âTAPE 1 : D√âBITER LE CLIENT ==========
        if (paymentMethod === 'wallet' || paymentMethod === 'Portefeuille Al Bourakh') {
            walletState.balance -= amount;
            updateWalletBalanceDisplay();
            clientDebited = true;
            console.log('‚úÖ Client d√©bit√©:', amount, 'FCFA');
        }

        // ========== √âTAPE 2 : METTRE √Ä JOUR LA R√âSERVATION ==========
        const reservationRef = db.collection('reservations').doc(currentBooking.id);
        await reservationRef.update({
            paiementValide: true,
            datePaiement: firebase.firestore.FieldValue.serverTimestamp(),
            modePaiementUtilise: paymentMethod,
            montantPaye: amount,
            partChauffeur: driverShare,
            commissionAlBourakh: commission,
            paiementEnAttente: false,
            paiementStatut: 'completed'
        });
        reservationUpdated = true;
        console.log('‚úÖ R√©servation mise √† jour');

        // ========== √âTAPE 3 : CR√âDITER LE CHAUFFEUR üí∞ ==========
        if (currentBooking.chauffeurAssigne) {
            const driverRef = db.collection('drivers').doc(currentBooking.chauffeurAssigne);
            
            // R√©cup√©rer le document du chauffeur
            const driverDoc = await driverRef.get();
            
            if (driverDoc.exists) {
                const today = new Date().toISOString().split('T')[0];
                
                // ‚úÖ CORRECTION : Utiliser les bons noms de champs
                await driverRef.update({
                    soldeDisponible: firebase.firestore.FieldValue.increment(driverShare),
                    revenusTotal: firebase.firestore.FieldValue.increment(driverShare),
                    revenusJour: firebase.firestore.FieldValue.increment(driverShare),
                    revenusSemaine: firebase.firestore.FieldValue.increment(driverShare),
                    revenusMois: firebase.firestore.FieldValue.increment(driverShare),
                    dernierPaiement: firebase.firestore.FieldValue.serverTimestamp(),
                    lastPaymentDate: today
                });
                driverCredited = true;
                console.log(`‚úÖ Chauffeur cr√©dit√©: ${driverShare} FCFA (Nouveau solde calcul√©)`);
            } else {
                throw new Error('Chauffeur introuvable dans la base de donn√©es');
            }
        } else {
            throw new Error('Aucun chauffeur assign√© √† cette r√©servation');
        }

        // ========== √âTAPE 4 : ENREGISTRER LA TRANSACTION CLIENT ==========
        await db.collection('transactions').add({
            type: 'paiement_course',
            reservationId: currentBooking.id,
            clientTelephone: currentBooking.clientTelephone || '',
            clientNom: currentBooking.clientNom || '',
            chauffeurId: currentBooking.chauffeurAssigne,
            nomChauffeur: currentBooking.nomChauffeur || '',
            montantTotal: amount,
            partChauffeur: driverShare,
            commissionAlBourakh: commission,
            modePaiement: paymentMethod,
            statut: 'completed',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            depart: currentBooking.depart,
            destination: currentBooking.destination
        });
        console.log('‚úÖ Transaction client enregistr√©e');

        // ========== √âTAPE 5 : ENREGISTRER LA TRANSACTION CHAUFFEUR ==========
        await db.collection('driver_transactions').add({
            driverId: currentBooking.chauffeurAssigne,
            type: 'credit_course',
            montant: driverShare,
            reservationId: currentBooking.id,
            description: `Course: ${currentBooking.depart?.substring(0, 30)} ‚Üí ${currentBooking.destination?.substring(0, 30)}`,
            modePaiement: paymentMethod,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            statut: 'completed'
        });
        console.log('‚úÖ Transaction chauffeur enregistr√©e');

        // ========== √âTAPE 6 : ENREGISTRER LA COMMISSION ==========
        await db.collection('commissions').add({
            reservationId: currentBooking.id,
            montantCourse: amount,
            tauxCommission: COMMISSION_RATE * 100,
            montantCommission: commission,
            chauffeurId: currentBooking.chauffeurAssigne,
            nomChauffeur: currentBooking.nomChauffeur || '',
            modePaiement: paymentMethod,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('‚úÖ Commission enregistr√©e');

        // ========== √âTAPE 7 : AJOUTER √Ä L'HISTORIQUE LOCAL ==========
        walletState.transactions.unshift({
            id: `PAY${Date.now()}`,
            date: new Date().toISOString(),
            from: currentBooking.depart?.substring(0, 20) || 'D√©part',
            to: currentBooking.destination?.substring(0, 20) || 'Destination',
            amount: amount,
            driver: currentBooking.nomChauffeur || 'Chauffeur',
            vehicle: selectedVehicle,
            payment: paymentMethod,
            tip: 0,
            status: 'completed',
            type: 'ride'
        });

        hideLoading();
        
        paymentValidated = true;
        btn.classList.remove('processing');
        btn.classList.add('success');
        btnText.innerHTML = '<i class="fas fa-check"></i> Paiement valid√© !';

        // Mettre √† jour l'√©tape 6
        document.getElementById('step6Icon').classList.add('active');
        document.getElementById('step6Text').textContent = 'Paiement effectu√© ‚úì';
        document.getElementById('step6Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

        showNotification(`‚úÖ Paiement valid√©!\nüí∞ Client: -${amount.toLocaleString()} FCFA\nüë®‚Äç‚úàÔ∏è Chauffeur: +${driverShare.toLocaleString()} FCFA\nüè¢ Commission: ${commission.toLocaleString()} FCFA`, 'success');

        // Cacher le bouton annuler
        document.getElementById('cancelBookingBtn').style.display = 'none';

        // Ouvrir l'√©valuation apr√®s 2 secondes
        setTimeout(() => {
            openEvaluationModal();
        }, 2000);

    } catch (error) {
        console.error('‚ùå Erreur paiement:', error);
        hideLoading();
        
        // ========== ROLLBACK EN CAS D'ERREUR ==========
        
        // Rembourser le client si d√©bit√©
        if (clientDebited && (paymentMethod === 'wallet' || paymentMethod === 'Portefeuille Al Bourakh')) {
            walletState.balance += amount;
            updateWalletBalanceDisplay();
            console.log('‚Ü©Ô∏è Client rembours√© apr√®s erreur');
        }

        // Annuler le cr√©dit du chauffeur si n√©cessaire
        if (driverCredited && currentBooking.chauffeurAssigne) {
            try {
                await db.collection('drivers').doc(currentBooking.chauffeurAssigne).update({
                    soldeDisponible: firebase.firestore.FieldValue.increment(-driverShare),
                    revenusTotal: firebase.firestore.FieldValue.increment(-driverShare),
                    revenusJour: firebase.firestore.FieldValue.increment(-driverShare),
                    revenusSemaine: firebase.firestore.FieldValue.increment(-driverShare),
                    revenusMois: firebase.firestore.FieldValue.increment(-driverShare)
                });
                console.log('‚Ü©Ô∏è Chauffeur rembours√© apr√®s erreur');
            } catch (rollbackError) {
                console.error('‚ùå Erreur rollback chauffeur:', rollbackError);
            }
        }

        // Annuler la r√©servation si mise √† jour
        if (reservationUpdated) {
            try {
                await db.collection('reservations').doc(currentBooking.id).update({
                    paiementValide: false,
                    paiementEnAttente: true,
                    paiementStatut: 'failed',
                    paiementErreur: error.message
                });
                console.log('‚Ü©Ô∏è R√©servation r√©initialis√©e apr√®s erreur');
            } catch (rollbackError) {
                console.error('‚ùå Erreur rollback r√©servation:', rollbackError);
            }
        }

        btn.classList.remove('processing');
        btn.disabled = false;
        btnText.innerHTML = '<i class="fas fa-check-circle"></i> Valider le paiement';
        
        let errorMessage = '‚ùå Erreur lors du paiement: ';
        if (error.message.includes('Missing or insufficient permissions')) {
            errorMessage += 'Permissions Firebase insuffisantes. V√©rifiez les r√®gles Firestore.';
        } else if (error.message.includes('Chauffeur introuvable')) {
            errorMessage += 'Le chauffeur n\'a pas √©t√© trouv√© dans la base de donn√©es.';
        } else {
            errorMessage += error.message;
        }
        
        showNotification(errorMessage, 'error');
    } finally {
        paymentProcessing = false;
    }
}
        // ========== DATE/TIME VALIDATION ==========
        function isBookingDateTimeValid(dateStr, timeStr) {
            const bookingDateTime = new Date(`${dateStr}T${timeStr}`);
            const now = new Date();
            const minAllowedTime = new Date(now.getTime() + 5 * 60000);
            
            if (bookingDateTime < minAllowedTime) {
                return {
                    valid: false,
                    message: '‚ö†Ô∏è Impossible de r√©server dans le pass√©. Veuillez choisir une date/heure future.'
                };
            }
            return { valid: true };
        }

        function formatDateTimeForDisplay(dateStr, timeStr) {
            const date = new Date(`${dateStr}T${timeStr}`);
            return date.toLocaleString('fr-FR', { 
                weekday: 'short', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' 
            });
        }

        // ========== WALLET FUNCTIONS ==========
        function openWallet() {
            document.getElementById('walletModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            showWalletScreen('dashboard');
        }

        function closeWallet() {
            document.getElementById('walletModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function showWalletScreen(screen) {
            walletState.currentScreen = screen;
            document.querySelectorAll('.wallet-screen').forEach(s => s.classList.remove('active'));
            
            const backBtn = document.getElementById('walletBackBtn');
            const title = document.getElementById('walletTitle');
            
            if (screen === 'dashboard') {
                backBtn.classList.add('hidden');
                title.textContent = 'Mon Portefeuille';
                renderWalletDashboard();
            } else if (screen === 'recharge') {
                backBtn.classList.remove('hidden');
                title.textContent = 'Recharger';
                renderWalletRecharge();
            } else if (screen === 'history') {
                backBtn.classList.remove('hidden');
                title.textContent = 'Historique';
                renderWalletHistory();
            } else if (screen === 'success') {
                backBtn.classList.add('hidden');
            }
            
            document.getElementById(`wallet${screen.charAt(0).toUpperCase() + screen.slice(1)}`).classList.add('active');
        }

        function renderWalletDashboard() {
            const totalSpent = walletState.transactions.filter(t => t.type === 'ride').reduce((sum, t) => sum + (t.amount || 0) + (t.tip || 0), 0);
            const rideCount = walletState.transactions.filter(t => t.type === 'ride').length;
            const recentTransactions = walletState.transactions.slice(0, 3);

            document.getElementById('walletDashboard').innerHTML = `
                <div class="wallet-card">
                    <div class="wallet-card-header">
                        <div>
                            <p class="wallet-label">Portefeuille Al Bourakh</p>
                            <h2 class="wallet-amount">${walletState.balance.toLocaleString()} FCFA</h2>
                        </div>
                        <div style="font-size: 2rem;">üí≥</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet primary" onclick="showWalletScreen('recharge')">
                            <i class="fas fa-plus"></i> Recharger
                        </button>
                        <button class="btn-wallet secondary" onclick="closeWallet(); scrollToBooking();">
                            <i class="fas fa-car"></i> R√©server
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-icon green">üìà</div>
                            <div><p class="stat-label">Courses ce mois</p><p class="stat-value">${rideCount}</p></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-icon purple">üí∞</div>
                            <div><p class="stat-label">D√©penses totales</p><p class="stat-value">${totalSpent.toLocaleString()}</p></div>
                        </div>
                    </div>
                </div>

                <div class="loyalty-card">
                    <div>
                        <p class="loyalty-label">Points de Fid√©lit√©</p>
                        <p class="loyalty-points">${walletState.loyaltyPoints} pts</p>
                    </div>
                    <div class="loyalty-badge">Niveau Or</div>
                </div>

                <div class="card" style="padding: 0;">
                    <div class="section-header">
                        <h3>Transactions R√©centes</h3>
                        <a class="btn-link" onclick="showWalletScreen('history')">Voir tout</a>
                    </div>
                    <div class="transaction-list">
                        ${recentTransactions.map(t => t.type === 'recharge' ? `
                            <div class="transaction-item">
                                <div class="transaction-header">
                                    <div><p style="font-weight: 500; color: #111827;">üí∞ Rechargement</p><p class="transaction-driver">${t.method}</p></div>
                                    <p style="font-size: 1.125rem; font-weight: 700; color: #16a34a;">+${t.amount.toLocaleString()} FCFA</p>
                                </div>
                                <p class="transaction-date">${new Date(t.date).toLocaleDateString('fr-FR')}</p>
                            </div>
                        ` : `
                            <div class="transaction-item">
                                <div class="transaction-header">
                                    <div style="flex: 1;">
                                        <div class="transaction-route"><span>üìç</span><span>${t.from} ‚Üí ${t.to}</span></div>
                                        <p class="transaction-driver">${t.driver}</p>
                                    </div>
                                    <div>
                                        <p class="transaction-amount">${(t.amount + (t.tip || 0)).toLocaleString()} FCFA</p>
                                        ${t.tip > 0 ? `<p class="transaction-tip">+${t.tip} pourboire</p>` : ''}
                                    </div>
                                </div>
                                <div class="transaction-footer">
                                    <span class="transaction-date">${new Date(t.date).toLocaleDateString('fr-FR')}</span>
                                    <span class="transaction-badge">${t.payment}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderWalletRecharge() {
            walletState.rechargeAmount = '';
            const quickAmounts = [5000, 10000, 20000, 50000];

            document.getElementById('walletRecharge').innerHTML = `
                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem;">Montant</h3>
                    <div class="amount-input-container">
                        <input type="number" id="rechargeAmountInput" class="amount-input" placeholder="0" oninput="walletState.rechargeAmount = this.value;">
                        <span class="amount-currency">FCFA</span>
                    </div>
                    <div class="quick-amounts">
                        ${quickAmounts.map(amt => `
                            <button class="quick-amount-btn" onclick="document.getElementById('rechargeAmountInput').value = ${amt}; walletState.rechargeAmount = '${amt}';">
                                ${amt.toLocaleString()} FCFA
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem;">Moyen de Paiement</h3>
                    ${['Orange Money', 'Wave', 'Free Money', 'Carte Bancaire'].map(m => `
                        <button class="payment-method-wallet ${walletState.rechargeMethod === m ? 'active' : ''}" onclick="walletState.rechargeMethod = '${m}'; renderWalletRecharge();">
                            <div class="payment-method-content">
                                <span class="payment-method-icon">${m === 'Orange Money' ? 'üì±' : m === 'Wave' ? 'üí≥' : m === 'Free Money' ? 'üì≤' : 'üí≥'}</span>
                                <span class="payment-method-name">${m}</span>
                            </div>
                            ${walletState.rechargeMethod === m ? '<span>‚úì</span>' : ''}
                        </button>
                    `).join('')}
                </div>

                <button class="btn-primary-wallet" onclick="processWalletRecharge()">
                    <i class="fas fa-plus"></i> Recharger
                </button>
            `;
        }

        function renderWalletHistory() {
            document.getElementById('walletHistory').innerHTML = `
                ${walletState.transactions.map(t => `
                    <div class="card" style="margin-bottom: 1rem;">
                        ${t.type === 'recharge' ? `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div><p style="font-weight: 500;">üí∞ Rechargement</p><p style="font-size: 0.875rem; color: #6b7280;">${t.method}</p></div>
                                <p style="font-size: 1.125rem; font-weight: 700; color: #16a34a;">+${t.amount.toLocaleString()} FCFA</p>
                            </div>
                            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">${new Date(t.date).toLocaleString('fr-FR')}</p>
                        ` : `
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <div class="transaction-route"><span>üìç</span><span>${t.from} ‚Üí ${t.to}</span></div>
                                    <p class="transaction-driver">${t.driver} ‚Ä¢ ${t.vehicle || 'V√©hicule'}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-size: 1.125rem; font-weight: 700;">${(t.amount + (t.tip || 0)).toLocaleString()} FCFA</p>
                                    ${t.tip > 0 ? `<p class="transaction-tip">+${t.tip} pourboire</p>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; border-top: 1px solid #f3f4f6;">
                                <span style="font-size: 0.75rem; color: #6b7280;">${new Date(t.date).toLocaleString('fr-FR')}</span>
                                <span class="transaction-badge">${t.payment}</span>
                            </div>
                        `}
                    </div>
                `).join('')}
            `;
        }

        function processWalletRecharge() {
            const amount = parseInt(walletState.rechargeAmount);
            if (!amount || amount <= 0) {
                showNotification('‚ö†Ô∏è Entrez un montant valide', 'error');
                return;
            }

            walletState.balance += amount;
            walletState.transactions.unshift({
                id: `RCH${Date.now()}`,
                date: new Date().toISOString(),
                type: 'recharge',
                amount: amount,
                method: walletState.rechargeMethod,
                status: 'completed'
            });

            updateWalletBalanceDisplay();
            showNotification(`‚úÖ ${amount.toLocaleString()} FCFA ajout√©s!`, 'success');
            
            document.getElementById('walletSuccess').innerHTML = `
                <div class="success-screen">
                    <div>
                        <div class="success-icon">‚úì</div>
                        <h2 class="success-title">Rechargement R√©ussi!</h2>
                        <p class="success-message">Votre portefeuille a √©t√© cr√©dit√© de ${amount.toLocaleString()} FCFA</p>
                    </div>
                </div>
            `;
            showWalletScreen('success');
            
            setTimeout(() => showWalletScreen('dashboard'), 2000);
        }

        function updateWalletBalanceDisplay() {
            document.getElementById('walletBalanceMini').textContent = walletState.balance.toLocaleString() + ' FCFA';
        }

        // ========== MAP FUNCTIONS ==========
        function initMap() {
            const dakar = { lat: 14.6937, lng: -17.4441 };
            map = new google.maps.Map(document.getElementById('map'), { center: dakar, zoom: 12, disableDefaultUI: true, zoomControl: true });
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#00A854', strokeWeight: 5 } });
            trafficLayer = new google.maps.TrafficLayer();
            
            const searchInput = document.getElementById('searchInput');
            autocomplete = new google.maps.places.Autocomplete(searchInput, { componentRestrictions: { country: 'sn' } });
            autocomplete.addListener('place_changed', onPlaceSelected);
            
            initBookingAutocomplete();
            map.addListener('click', handleMapClick);
            autoDetectLocation();
            initDateTime();
            initEvaluationListeners();
            updateWalletBalanceDisplay();
            
            console.log('‚úÖ Map initialized');
        }

        function initBookingAutocomplete() {
            const fromInput = document.getElementById('bookingFrom');
            const toInput = document.getElementById('bookingTo');
            
            const autocompleteFrom = new google.maps.places.Autocomplete(fromInput, { componentRestrictions: { country: 'sn' } });
            autocompleteFrom.addListener('place_changed', () => {
                const place = autocompleteFrom.getPlace();
                if (place.geometry) {
                    departureCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                    updateMarker('departure', departureCoords);
                    calculateRoute();
                }
            });
            
            const autocompleteTo = new google.maps.places.Autocomplete(toInput, { componentRestrictions: { country: 'sn' } });
            autocompleteTo.addListener('place_changed', () => {
                const place = autocompleteTo.getPlace();
                if (place.geometry) {
                    destinationCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                    updateMarker('destination', destinationCoords);
                    calculateRoute();
                }
            });
        }

        function onPlaceSelected() {
            const place = autocomplete.getPlace();
            if (place.geometry) { map.setCenter(place.geometry.location); map.setZoom(15); }
        }

        function autoDetectLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    departureCoords = userPos;
                    map.setCenter(userPos);
                    map.setZoom(14);
                    geocoder.geocode({ location: userPos }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            document.getElementById('bookingFrom').value = results[0].formatted_address;
                            updateMarker('departure', userPos);
                        }
                    });
                }, () => console.log('Geolocation denied'));
            }
        }

        async function getCurrentPosition() {
            const gpsBtn = event.currentTarget;
            const fromInput = document.getElementById('bookingFrom');
            
            if (!navigator.geolocation) {
                showNotification('‚ùå G√©olocalisation non disponible', 'error');
                return;
            }

            gpsBtn.classList.add('loading');
            gpsBtn.disabled = true;
            showNotification('üìç Localisation en cours...', 'info');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
                    departureCoords = userPos;
                    map.setCenter(userPos);
                    map.setZoom(16);
                    
                    geocoder.geocode({ location: userPos }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            fromInput.value = results[0].formatted_address;
                            updateMarker('departure', userPos);
                            if (destinationCoords) calculateRoute();
                            
                            gpsBtn.classList.remove('loading');
                            gpsBtn.classList.add('success');
                            gpsBtn.disabled = false;
                            showNotification(`‚úÖ Position d√©tect√©e`, 'success');
                            setTimeout(() => gpsBtn.classList.remove('success'), 2000);
                        }
                    });
                },
                (error) => {
                    gpsBtn.classList.remove('loading');
                    gpsBtn.classList.add('error');
                    gpsBtn.disabled = false;
                    showNotification('‚ùå Erreur de localisation', 'error');
                    setTimeout(() => gpsBtn.classList.remove('error'), 2000);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        function initDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            
            const dateInput = document.getElementById('bookingDate');
            const timeInput = document.getElementById('bookingTime');
            
            dateInput.min = new Date().toISOString().split('T')[0];
            dateInput.value = now.toISOString().split('T')[0];
            timeInput.value = now.toTimeString().slice(0, 5);
            
            dateInput.addEventListener('change', validateDateTime);
            timeInput.addEventListener('change', validateDateTime);
        }

        function validateDateTime() {
            const dateInput = document.getElementById('bookingDate');
            const timeInput = document.getElementById('bookingTime');
            
            const validation = isBookingDateTimeValid(dateInput.value, timeInput.value);
            
            if (!validation.valid) {
                dateInput.style.borderColor = '#E30613';
                timeInput.style.borderColor = '#E30613';
            } else {
                dateInput.style.borderColor = '#ddd';
                timeInput.style.borderColor = '#ddd';
            }
        }

        function findMyLocation() {
            if (navigator.geolocation) {
                showNotification('üìç Localisation...', 'info');
                navigator.geolocation.getCurrentPosition((pos) => {
                    const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.setCenter(userPos);
                    map.setZoom(16);
                    if (userMarker) userMarker.setMap(null);
                    userMarker = new google.maps.Marker({
                        position: userPos, map: map,
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 3 },
                        animation: google.maps.Animation.BOUNCE, title: 'Vous √™tes ici'
                    });
                    setTimeout(() => userMarker.setAnimation(null), 2000);
                    showNotification(`‚úÖ Position trouv√©e`, 'success');
                }, () => showNotification('‚ùå Localisation refus√©e', 'error'), { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
            }
        }

        function toggleTraffic() {
            if (trafficLayer.getMap()) { trafficLayer.setMap(null); showNotification('üö¶ Trafic d√©sactiv√©', 'info'); }
            else { trafficLayer.setMap(map); showNotification('üö¶ Trafic activ√©', 'success'); }
        }

        function selectOnMap(type) {
            mapSelectionMode = type;
            showNotification(`üó∫Ô∏è Cliquez sur la carte pour ${type === 'from' ? 'le d√©part' : 'la destination'}`, 'info');
            map.getDiv().style.cursor = 'crosshair';
            document.querySelector('.map-container').scrollIntoView({ behavior: 'smooth' });
        }

        function handleMapClick(event) {
            if (!mapSelectionMode) return;
            const location = event.latLng;
            geocoder.geocode({ location: location }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    if (mapSelectionMode === 'from') {
                        document.getElementById('bookingFrom').value = results[0].formatted_address;
                        departureCoords = { lat: location.lat(), lng: location.lng() };
                        updateMarker('departure', departureCoords);
                    } else {
                        document.getElementById('bookingTo').value = results[0].formatted_address;
                        destinationCoords = { lat: location.lat(), lng: location.lng() };
                        updateMarker('destination', destinationCoords);
                    }
                    calculateRoute();
                    showNotification(`‚úÖ ${mapSelectionMode === 'from' ? 'D√©part' : 'Destination'} s√©lectionn√©`, 'success');
                }
                mapSelectionMode = null;
                map.getDiv().style.cursor = '';
            });
        }

        function updateMarker(type, coords) {
            if (type === 'departure') {
                if (departureMarker) departureMarker.setMap(null);
                departureMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 12, fillColor: '#4CAF50', fillOpacity: 1, strokeColor: 'white', strokeWeight: 3 }, label: { text: 'A', color: 'white', fontWeight: 'bold' } });
            } else {
                if (destinationMarker) destinationMarker.setMap(null);
                destinationMarker = new google.maps.Marker({ position: coords, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 12, fillColor: '#E30613', fillOpacity: 1, strokeColor: 'white', strokeWeight: 3 }, label: { text: 'B', color: 'white', fontWeight: 'bold' } });
            }
        }

        function calculateRoute() {
            if (!departureCoords || !destinationCoords) return;
            directionsService.route({ origin: departureCoords, destination: destinationCoords, travelMode: google.maps.TravelMode.DRIVING }, (result, status) => {
                if (status === 'OK') directionsRenderer.setDirections(result);
            });
        }

        function selectVehicle(type, price) {
            selectedVehicle = type;
            selectedVehiclePrice = price;
            document.querySelectorAll('.vehicle-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            showNotification(`‚úÖ V√©hicule: ${type}`, 'success');
        }

        function selectPayment(method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            const methodNames = { cash: 'Esp√®ces', orange: 'Orange Money', wave: 'Wave', wallet: 'Portefeuille Al Bourakh' };
            showNotification(`‚úÖ Paiement: ${methodNames[method]}`, 'success');
        }

        function calculateDistance(p1, p2) {
            const R = 6371;
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLon = (p2.lng - p1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function previewBooking() {
            const from = document.getElementById('bookingFrom').value.trim();
            const to = document.getElementById('bookingTo').value.trim();
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            const phone = document.getElementById('bookingPhone').value.trim();

            if (!from || !to || !date || !time || !phone) { 
                showNotification('‚ö†Ô∏è Remplissez tous les champs', 'error'); 
                return; 
            }
            
            const validation = isBookingDateTimeValid(date, time);
            if (!validation.valid) {
                showNotification(validation.message, 'error');
                return;
            }

            if (!selectedVehicle) { showNotification('‚ö†Ô∏è S√©lectionnez un v√©hicule', 'error'); return; }
            if (!selectedPayment) { showNotification('‚ö†Ô∏è S√©lectionnez un paiement', 'error'); return; }

            let distance = 10;
            if (departureCoords && destinationCoords) distance = calculateDistance(departureCoords, destinationCoords);
            const pricePerKm = { standard: 200, confort: 250, van: 300, premium: 400 };
            const totalPrice = Math.round(selectedVehiclePrice + (distance * pricePerKm[selectedVehicle]));

            if (selectedPayment === 'wallet' && walletState.balance < totalPrice) {
                showNotification(`‚ö†Ô∏è Solde insuffisant (${walletState.balance.toLocaleString()} FCFA). Rechargez votre portefeuille.`, 'error');
                return;
            }

            const vehicleNames = { standard: 'üöó Standard', confort: '‚ú® Confort', van: 'üöê Van', premium: 'üëë Premium' };
            const paymentNames = { cash: 'üíµ Esp√®ces', orange: 'üì± Orange Money', wave: 'üí≥ Wave', wallet: 'üëõ Portefeuille' };

            document.getElementById('summaryRoute').textContent = `${from.substring(0, 15)}... ‚Üí ${to.substring(0, 15)}...`;
            document.getElementById('summaryDateTime').textContent = formatDateTimeForDisplay(date, time);
            document.getElementById('summaryVehicle').textContent = vehicleNames[selectedVehicle];
            document.getElementById('summaryPayment').textContent = paymentNames[selectedPayment];
            document.getElementById('summaryTotal').textContent = `${totalPrice.toLocaleString()} FCFA`;

            document.getElementById('bookingSummary').style.display = 'block';
            document.getElementById('bookingSummary').scrollIntoView({ behavior: 'smooth' });
        }

        async function confirmBooking() {
            const summary = document.getElementById('bookingSummary');
            if (summary.style.display === 'none') { 
                showNotification('‚ö†Ô∏è Cliquez d\'abord sur Aper√ßu', 'error'); 
                return; 
            }

            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;

            const validation = isBookingDateTimeValid(date, time);
            if (!validation.valid) {
                showNotification(validation.message, 'error');
                return;
            }

            const totalPrice = parseInt(document.getElementById('summaryTotal').textContent.replace(/\D/g, ''));

            showLoading('Enregistrement...');

            const paymentMethodNames = {
                'cash': 'Esp√®ces',
                'orange': 'Orange Money',
                'wave': 'Wave',
                'wallet': 'Portefeuille Al Bourakh'
            };

            const bookingData = {
                clientNom: document.getElementById('bookingName').value.trim() || 'Client',
                clientTelephone: document.getElementById('bookingPhone').value.trim(),
                depart: document.getElementById('bookingFrom').value.trim(),
                destination: document.getElementById('bookingTo').value.trim(),
                departCoords: departureCoords,
                destinationCoords: destinationCoords,
                dateReservation: date,
                heureReservation: time,
                vehiculeType: selectedVehicle,
                modePaiement: paymentMethodNames[selectedPayment],
                prixEstime: totalPrice,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                statut: 'en_attente',
                paiementValide: false,
                paiementEnAttente: true,
                chauffeurAssigne: null,
                nomChauffeur: null,
                telephoneChauffeur: null
            };

            try {
                const docRef = await db.collection('reservations').add(bookingData);
                currentBooking = { id: docRef.id, ...bookingData };

                // R√©initialiser l'√©tat du paiement
                paymentValidated = false;
                paymentProcessing = false;
                driverPhotoUrl = null;

                hideLoading();
                showNotification('‚úÖ R√©servation confirm√©e!', 'success');
                openTracking();
                startReservationListener(docRef.id);
            } catch (error) {
                hideLoading();
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // ========== TRACKING FUNCTIONS ==========
        function openTracking() {
            document.getElementById('trackingModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            document.getElementById('tripFrom').textContent = currentBooking.depart;
            document.getElementById('tripTo').textContent = currentBooking.destination;
            document.getElementById('tripPrice').textContent = currentBooking.prixEstime.toLocaleString() + ' FCFA';
            document.getElementById('step1Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            // R√©initialiser le bouton de paiement
            const btn = document.getElementById('validatePaymentBtn');
            btn.classList.remove('processing', 'success');
            btn.disabled = false;
            document.getElementById('validatePaymentText').innerHTML = '<i class="fas fa-check-circle"></i> Valider le paiement';
            
            // Afficher le bouton annuler
            document.getElementById('cancelBookingBtn').style.display = 'block';
            
            // Masquer le bouton de paiement au d√©part
            hidePaymentButton();
            
            currentTrackingMode = 'approche';
            updateTrackingModeDisplay();
            setTimeout(() => initTrackingMap(), 300);
        }

        function closeTracking() {
            document.getElementById('trackingModal').classList.remove('active');
            document.body.style.overflow = '';
            if (reservationListener) { reservationListener(); reservationListener = null; }
            if (driverListener) { driverListener(); driverListener = null; }
            if (trackingUpdateInterval) { clearInterval(trackingUpdateInterval); trackingUpdateInterval = null; }
        }

        function initTrackingMap() {
    if (!currentBooking || !currentBooking.departCoords) return;
    
    trackingMap = new google.maps.Map(document.getElementById('trackingMap'), { 
        center: currentBooking.departCoords, 
        zoom: 14, 
        disableDefaultUI: true, 
        zoomControl: true 
    });
    
    trackingDirectionsRenderer = new google.maps.DirectionsRenderer({ 
        map: trackingMap, 
        suppressMarkers: true, 
        polylineOptions: { 
            strokeColor: '#2196F3', 
            strokeWeight: 5, 
            strokeOpacity: 0.8 
        } 
    });
    
    // ‚úÖ CORRECTION - departCoords sur une seule ligne
    clientPickupMarker = new google.maps.Marker({ 
        position: currentBooking.departCoords, 
        map: trackingMap, 
        icon: { 
            path: google.maps.SymbolPath.CIRCLE, 
            scale: 12, 
            fillColor: '#4CAF50', 
            fillOpacity: 1, 
            strokeColor: 'white', 
            strokeWeight: 3 
        }, 
        label: { 
            text: '', 
            fontSize: '16px' 
        } 
    });
    
    if (currentBooking.destinationCoords) { 
        new google.maps.Marker({ 
            position: currentBooking.destinationCoords, 
            map: trackingMap, 
            icon: { 
                path: google.maps.SymbolPath.CIRCLE, 
                scale: 10, 
                fillColor: '#E30613', 
                fillOpacity: 0.7, 
                strokeColor: 'white', 
                strokeWeight: 2 
            } 
        }); 
    }
}
function startReservationListener(reservationId) {
        console.log('üëÇ √âcoute r√©servation:', reservationId);
        reservationListener = db.collection('reservations').doc(reservationId).onSnapshot(async (doc) => {
            if (!doc.exists) return;
            const data = doc.data();
            console.log('üì¶ Mise √† jour:', data.statut);
            currentBooking = { id: doc.id, ...data };
            
            if (data.statut === 'en_cours' && currentTrackingMode === 'approche') {
                currentTrackingMode = 'course';
                updateTrackingModeDisplay();
                calculateCourseRoute();
            }
            
            updateStatusTimeline(data.statut);
            
            if (data.chauffeurAssigne && !driverListener) {
                updateStep2(data);
                startDriverTracking(data.chauffeurAssigne);
            }
            if (data.nomChauffeur) await showDriverCard(data);
        });
    }

    function updateTrackingModeDisplay() {
        const badge = document.getElementById('routeModeBadge');
        const text = document.getElementById('routeModeText');
        if (currentTrackingMode === 'approche') {
            badge.classList.remove('course-mode');
            badge.style.display = 'flex';
            text.innerHTML = '<i class="fas fa-car-side"></i> Chauffeur en approche';
        } else if (currentTrackingMode === 'course') {
            badge.classList.add('course-mode');
            badge.style.display = 'flex';
            text.innerHTML = '<i class="fas fa-route"></i> Course en cours';
        }
    }

    function calculateCourseRoute() {
        if (!currentBooking.departCoords || !currentBooking.destinationCoords || !directionsService) return;
        directionsService.route({ origin: currentBooking.departCoords, destination: currentBooking.destinationCoords, travelMode: google.maps.TravelMode.DRIVING }, (result, status) => {
            if (status === 'OK') {
                trackingDirectionsRenderer.setDirections(result);
                trackingDirectionsRenderer.setOptions({ polylineOptions: { strokeColor: '#00A854', strokeWeight: 5, strokeOpacity: 0.8 } });
                const leg = result.routes[0].legs[0];
                document.getElementById('driverApproachingBox').innerHTML = `
                    <div class="driver-approaching-title">üöó Course en cours</div>
                    <div class="driver-eta" style="font-size: 1.5em;">${leg.distance.text}</div>
                    <div class="driver-eta-label">Distance restante</div>
                    <div class="driver-details-row">
                        <div class="driver-detail"><div class="driver-detail-value">${leg.duration.text}</div><div class="driver-detail-label">Temps estim√©</div></div>
                        <div class="driver-detail"><div class="driver-detail-value">${new Date(Date.now() + leg.duration.value * 1000).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div><div class="driver-detail-label">Arriv√©e pr√©vue</div></div>
                    </div>
                `;
                document.getElementById('driverApproachingBox').style.background = 'linear-gradient(135deg, #00A854, #FECB00)';
                if (trackingMap) {
                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(currentBooking.departCoords);
                    bounds.extend(currentBooking.destinationCoords);
                    trackingMap.fitBounds(bounds, { padding: 50 });
                }
            }
        });
    }

function updateStep2(data) {
    document.getElementById('step2Icon').classList.add('active');
    document.getElementById('step2Text').textContent = `${data.nomChauffeur || 'Chauffeur'} assign√©`;
    document.getElementById('step2Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    
    // ‚úÖ NOUVEAU : Appeler showDriverCard UNE SEULE fois
    if (data.nomChauffeur && !document.getElementById('driverCard').classList.contains('driver-loaded')) {
        showDriverCard(data);
        document.getElementById('driverCard').classList.add('driver-loaded');
    }
}
    function startDriverTracking(driverId) {
        console.log('üöó Suivi chauffeur:', driverId);
        if (driverListener) { driverListener(); driverListener = null; }
        driverListener = db.collection('drivers').doc(driverId).onSnapshot((doc) => {
            if (!doc.exists) return;
            const driverData = doc.data();
            if (driverData.position && driverData.position.latitude && driverData.position.longitude) {
                const driverPos = { lat: driverData.position.latitude, lng: driverData.position.longitude };
                lastDriverPosition = driverPos;
                updateDriverMarker(driverPos);
                if (currentTrackingMode === 'approche') calculateApproachRoute(driverPos);
                updateStep3();
            }
        });
        setTimeout(() => { if (!lastDriverPosition && currentBooking) startSimulationMode(); }, 5000);
    }

    function startSimulationMode() {
        if (simulationMode) return;
        simulationMode = true;
        console.log('üß™ Mode simulation');
        showNotification('üìç Mode d√©mo', 'info');
        if (currentBooking && currentBooking.departCoords) {
            simulatedDriverPosition = { lat: currentBooking.departCoords.lat + 0.015, lng: currentBooking.departCoords.lng + 0.015 };
            updateDriverMarker(simulatedDriverPosition);
            calculateApproachRoute(simulatedDriverPosition);
            updateStep3();
            trackingUpdateInterval = setInterval(() => {
                if (!currentBooking || !simulatedDriverPosition) { clearInterval(trackingUpdateInterval); return; }
                if (currentTrackingMode === 'approche') {
                    const target = currentBooking.departCoords;
                    const speed = 0.002;
                    const dLat = target.lat - simulatedDriverPosition.lat;
                    const dLng = target.lng - simulatedDriverPosition.lng;
                    const distance = Math.sqrt(dLat * dLat + dLng * dLng);
                    if (distance < 0.001) { clearInterval(trackingUpdateInterval); updateStatusTimeline('arrive'); return; }
                    simulatedDriverPosition = { lat: simulatedDriverPosition.lat + (dLat / distance) * speed, lng: simulatedDriverPosition.lng + (dLng / distance) * speed };
                    updateDriverMarker(simulatedDriverPosition);
                    calculateApproachRoute(simulatedDriverPosition);
                }
            }, 3000);
        }
    }

    function updateDriverMarker(position) {
        if (!trackingMap) return;
        if (driverMarker) { driverMarker.setPosition(position); }
        else { driverMarker = new google.maps.Marker({ position: position, map: trackingMap, icon: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale: 8, fillColor: '#2196F3', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 }, zIndex: 100 }); }
        if (currentTrackingMode === 'approche') {
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(position);
            if (currentBooking.departCoords) bounds.extend(currentBooking.departCoords);
            trackingMap.fitBounds(bounds, { padding: 50 });
        }
    }

    function calculateApproachRoute(driverPos) {
        if (!currentBooking.departCoords || !directionsService) return;
        directionsService.route({ origin: driverPos, destination: currentBooking.departCoords, travelMode: google.maps.TravelMode.DRIVING }, (result, status) => {
            if (status === 'OK') {
                trackingDirectionsRenderer.setDirections(result);
                trackingDirectionsRenderer.setOptions({ polylineOptions: { strokeColor: '#2196F3', strokeWeight: 5, strokeOpacity: 0.8 } });
                const leg = result.routes[0].legs[0];
                document.getElementById('driverETA').textContent = Math.ceil(leg.duration.value / 60);
                document.getElementById('driverDistance').textContent = leg.distance.text;
                document.getElementById('driverArrivalTime').textContent = new Date(Date.now() + leg.duration.value * 1000).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('driverApproachingBox').style.display = 'block';
            }
        });
    }

    function updateStep3() {
        const step3Icon = document.getElementById('step3Icon');
        step3Icon.classList.remove('active');
        step3Icon.classList.add('current');
        document.getElementById('step3Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    function updateStatusTimeline(statut) {
        const step4Icon = document.getElementById('step4Icon');
        const step5Icon = document.getElementById('step5Icon');
        const step6Icon = document.getElementById('step6Icon');
        
        switch(statut) {
            case 'arrive':
                step4Icon.classList.add('active');
                document.getElementById('step3Icon').classList.remove('current');
                document.getElementById('step3Icon').classList.add('active');
                document.getElementById('step4Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('driverApproachingBox').innerHTML = `<div class="driver-approaching-title">‚úÖ Chauffeur arriv√©!</div><div class="driver-eta" style="font-size: 1.5em;">Rejoignez votre chauffeur</div>`;
                document.getElementById('driverApproachingBox').style.background = 'linear-gradient(135deg, #4CAF50, #8BC34A)';
                break;
            case 'en_cours':
                step4Icon.classList.add('active');
                step5Icon.classList.add('current');
                document.getElementById('step5Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                break;
            case 'terminee':
                step5Icon.classList.remove('current');
                step5Icon.classList.add('active');
                document.getElementById('driverApproachingBox').innerHTML = `<div class="driver-approaching-title">üéâ Course termin√©e!</div><div class="driver-eta" style="font-size: 1.2em;">Validez votre paiement</div>`;
                document.getElementById('driverApproachingBox').style.background = 'linear-gradient(135deg, #9C27B0, #E91E63)';
                if (trackingUpdateInterval) { clearInterval(trackingUpdateInterval); trackingUpdateInterval = null; }
                
                // Afficher le bouton de validation de paiement pour les paiements digitaux
                showPaymentButton();
                
                // Si paiement en esp√®ces, ouvrir directement l'√©valuation
                if (!isDigitalPayment(currentBooking.modePaiement || selectedPayment)) {
                    step6Icon.classList.add('active');
                    document.getElementById('step6Text').textContent = 'Paiement en esp√®ces';
                    document.getElementById('step6Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    setTimeout(() => openEvaluationModal(), 2000);
                }
                break;
            case 'annulee':
                closeTracking();
                showNotification('‚ùå R√©servation annul√©e', 'error');
                break;
        }
    }

// Remplacer la fonction showDriverCard() (lignes ~1054-1094)
async function showDriverCard(data) {
    const driverCard = document.getElementById('driverCard');
    driverCard.style.display = 'block';

    const driverName = data.nomChauffeur || 'Chauffeur';
    document.getElementById('driverName').textContent = driverName;
    
    let rating = 4.9;
    let marque = '';
    let modele = '';
    let immatriculation = 'DK-XXXX-XX';
    
    if (data.chauffeurAssigne) {
        try {
            // R√©cup√©rer la photo
            driverPhotoUrl = await fetchDriverPhoto(
                data.chauffeurAssigne, 
                data.telephoneChauffeur,
                data.prenomChauffeur,
                data.nomChauffeur
            );
            
            // Afficher la photo si trouv√©e
            const driverAvatar = document.getElementById('driverAvatar');
            if (driverPhotoUrl) {
                driverAvatar.innerHTML = `<img src="${driverPhotoUrl}" alt="${driverName}" onerror="this.parentElement.innerHTML='üë§'">`;
            }
            
            // ‚úÖ CORRECTION : Acc√©der √† l'objet vehicule imbriqu√©
            const driverDoc = await db.collection('drivers').doc(data.chauffeurAssigne).get();
            if (driverDoc.exists) {
                const driverData = driverDoc.data();
                rating = driverData.rating || driverData.noteGlobale || 3.7;
                
                // ‚úÖ R√©cup√©rer depuis l'objet vehicule
                if (driverData.vehicule) {
                    marque = driverData.vehicule.marque || '';
                    modele = driverData.vehicule.modele || '';
                    immatriculation = driverData.vehicule.immatriculation || 'DK-XXXX-XX';
                }
                
                console.log('‚úÖ Infos v√©hicule r√©cup√©r√©es:', { marque, modele, immatriculation });
            }
        } catch (error) {
            console.error('‚ùå Erreur r√©cup√©ration infos chauffeur:', error);
        }
    }
    
    // ‚úÖ Construire le texte du v√©hicule
    const vehiculeComplet = marque && modele ? `${marque} ${modele}` : (marque || modele || 'V√©hicule');
    
    // ‚úÖ Afficher dans la card chauffeur principale
    document.getElementById('driverRating').textContent = rating;
    document.getElementById('vehicleModel').textContent = vehiculeComplet;
    document.getElementById('vehiclePlate').textContent = immatriculation;
    
    // ‚úÖ Sauvegarder dans currentBooking pour utilisation ult√©rieure
    if (currentBooking) {
        currentBooking.vehiculeMarque = marque;
        currentBooking.vehiculeModele = modele;
        currentBooking.immatriculation = immatriculation;
        currentBooking.vehiculeComplet = vehiculeComplet;
        currentBooking.noteGlobaleChauffeur = rating;
    }
    
    driverCard.dataset.phone = data.telephoneChauffeur || '';
}    
function callDriver() {
        const phone = document.getElementById('driverCard').dataset.phone;
        if (phone) window.location.href = `tel:${phone}`;
        else showNotification('Num√©ro non disponible', 'error');
    }

    function messageDriver() {
        const phone = document.getElementById('driverCard').dataset.phone;
        if (phone) window.location.href = `sms:${phone}`;
        else showNotification('Num√©ro non disponible', 'error');
    }

    async function cancelBooking() {
        if (paymentValidated) {
            showNotification('‚ùå Impossible d\'annuler - Paiement d√©j√† valid√©', 'error');
            return;
        }
        
        if (!confirm('Annuler cette r√©servation?')) return;
        
        if (currentBooking && currentBooking.id) {
            try {
                await db.collection('reservations').doc(currentBooking.id).update({ 
                    statut: 'annulee', 
                    dateAnnulation: firebase.firestore.FieldValue.serverTimestamp() 
                });
            } catch (error) { 
                console.error('Erreur:', error); 
            }
        }
        closeTracking();
        currentBooking = null;
        showNotification('R√©servation annul√©e', 'info');
    }

    // ========== EVALUATION FUNCTIONS ==========
    function initEvaluationListeners() {
        document.querySelectorAll('#overallRating .star').forEach(star => {
            star.addEventListener('click', () => {
                evaluationData.noteGlobale = parseInt(star.dataset.rating);
                updateOverallStars(evaluationData.noteGlobale);
                updateSubmitButton();
            });
        });
        document.querySelectorAll('.criteria-star').forEach(star => {
            star.addEventListener('click', () => {
                const criteria = star.dataset.criteria;
                evaluationData[criteria] = parseInt(star.dataset.rating);
                updateCriteriaStars(criteria, evaluationData[criteria]);
                updateSubmitButton();
            });
        });
        document.getElementById('evaluationComment').addEventListener('input', (e) => {
            document.getElementById('commentLength').textContent = e.target.value.length;
            evaluationData.commentaire = e.target.value;
        });
        document.getElementById('submitEvaluationBtn').addEventListener('click', submitEvaluation);
        document.getElementById('skipEvaluationBtn').addEventListener('click', skipEvaluation);
    }

    function updateOverallStars(rating) {
        const stars = document.querySelectorAll('#overallRating .star');
        const labels = ['Tr√®s mauvais', 'Mauvais', 'Moyen', 'Bon', 'Excellent'];
        stars.forEach(star => { star.classList.toggle('active', parseInt(star.dataset.rating) <= rating); });
        document.getElementById('overallRatingLabel').textContent = labels[rating - 1];
    }

    function updateCriteriaStars(criteria, rating) {
        document.querySelectorAll(`#${criteria}Rating .criteria-star`).forEach(star => { 
            star.classList.toggle('active', parseInt(star.dataset.rating) <= rating); 
        });
        document.getElementById(`${criteria}Value`).textContent = `${rating}/5`;
    }

    function updateSubmitButton() {
        document.getElementById('submitEvaluationBtn').disabled = evaluationData.noteGlobale === 0;
    }

    function openEvaluationModal() {
        if (!currentBooking) return;
        
        document.getElementById('evalDriverName').textContent = currentBooking.nomChauffeur || 'Votre chauffeur';
        
        // Afficher la photo du chauffeur dans l'√©valuation si disponible
        const evalDriverAvatar = document.getElementById('evalDriverAvatar');
        if (driverPhotoUrl) {
            evalDriverAvatar.innerHTML = `<img src="${driverPhotoUrl}" alt="Chauffeur" onerror="this.parentElement.innerHTML='üë§'">`;
        }
        
        let vehiculeText = '';
        const marque = currentBooking.vehiculeMarque;
        const modele = currentBooking.vehiculeModele;
        const immat = currentBooking.immatriculation;
        
        if (marque && marque !== 'V√©hicule') {
            vehiculeText = modele ? `${marque} ${modele}` : marque;
            if (immat && immat !== 'DK-XXXX-XX') vehiculeText += ` ‚Ä¢ ${immat}`;
        } else {
            const typeVehicule = currentBooking.vehiculeType || 'standard';
            const typeNames = { standard: 'üöó Standard', confort: '‚ú® Confort', van: 'üöê Van', premium: 'üëë Premium' };
            vehiculeText = typeNames[typeVehicule] || 'V√©hicule';
        }
        document.getElementById('evalVehicle').textContent = vehiculeText;
        
        evaluationData = { noteGlobale: 0, conduite: 0, ponctualite: 0, proprete: 0, amabilite: 0, commentaire: '' };
        document.querySelectorAll('.star, .criteria-star').forEach(s => s.classList.remove('active'));
        document.getElementById('overallRatingLabel').textContent = 'S√©lectionnez une note';
        document.querySelectorAll('.criteria-value').forEach(v => v.textContent = '-');
        document.getElementById('evaluationComment').value = '';
        document.getElementById('commentLength').textContent = '0';
        document.getElementById('submitEvaluationBtn').disabled = true;
        
        document.getElementById('evaluationModal').classList.add('active');
    }

    function closeEvaluationModal() {
        document.getElementById('evaluationModal').classList.remove('active');
    }

    function skipEvaluation() {
        closeEvaluationModal();
        closeTracking();
        showNotification('√âvaluation ignor√©e', 'info');
        currentBooking = null;
    }

    async function submitEvaluation() {
        if (evaluationData.noteGlobale === 0) { 
            showNotification('‚ö†Ô∏è Veuillez noter la course', 'error'); 
            return; 
        }
        const submitBtn = document.getElementById('submitEvaluationBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi...';
        try {
            await db.collection('evaluations').add({
                reservationId: currentBooking.id,
                chauffeurId: currentBooking.chauffeurAssigne,
                nomChauffeur: currentBooking.nomChauffeur || 'Chauffeur',
                noteGlobale: evaluationData.noteGlobale,
                conduite: evaluationData.conduite || 0,
                ponctualite: evaluationData.ponctualite || 0,
                proprete: evaluationData.proprete || 0,
                amabilite: evaluationData.amabilite || 0,
                commentaire: evaluationData.commentaire.trim(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            submitBtn.innerHTML = '<i class="fas fa-check"></i> Envoy√© !';
            showNotification('‚úÖ Merci pour votre √©valuation!', 'success');
            setTimeout(() => { closeEvaluationModal(); closeTracking(); currentBooking = null; }, 1500);
        } catch (error) {
            console.error('Erreur:', error);
            showNotification('‚ùå Erreur: ' + error.message, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Envoyer';
        }
    }

    // ========== UTILITY FUNCTIONS ==========
    function scrollToBooking() { 
        document.querySelector('.booking-section').scrollIntoView({ behavior: 'smooth' }); 
    }
    
    function showNotification(message, type = 'info') {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        document.body.appendChild(notif);
        setTimeout(() => { notif.style.opacity = '0'; setTimeout(() => notif.remove(), 300); }, 3000);
    }

    function showLoading(text = 'Chargement...') {
        const overlay = document.getElementById('loadingOverlay');
        overlay.querySelector('.loading-text').textContent = text;
        overlay.style.display = 'flex';
    }

    function hideLoading() { 
        document.getElementById('loadingOverlay').style.display = 'none'; 
    }
    
    function closePermissionModal() { 
        document.getElementById('permissionModal').classList.remove('active'); 
        document.body.style.overflow = ''; 
    }
    
    function requestLocationPermission() { 
        closePermissionModal(); 
        showNotification('üí° Appuyez sur "Autoriser"', 'info'); 
        setTimeout(() => getCurrentPosition(), 500); 
    }

    window.initMap = initMap;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBI1svukv3Ts7fN97ke5OGfwo2V-vRUGHI&callback=initMap&libraries=places"></script>
</body> </html>

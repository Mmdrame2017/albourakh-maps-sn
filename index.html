<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Al Bourakh - R√©servation & Suivi en Temps R√©el v2.4</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; overflow-x: hidden; }
        
        .hero-section { background: linear-gradient(135deg, #00A854, #FECB00, #E30613); padding: 40px 15px; text-align: center; color: white; }
        .hero-logo { width: 100px; height: 75px; margin-bottom: 12px; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3)); }
        .hero-title { font-size: 2em; margin-bottom: 8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .hero-subtitle { font-size: 1em; opacity: 0.95; }
        .hero-cta { display: inline-block; margin-top: 20px; padding: 12px 28px; font-size: 1em; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; background: white; color: #00A854; box-shadow: 0 8px 25px rgba(0,0,0,0.2); transition: all 0.3s; }
        .hero-cta:hover { transform: scale(1.05); }

        .map-container { max-width: 1200px; margin: 20px auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        .map-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .map-logo { font-size: 1.1em; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; }
        .search-container { position: relative; flex: 1; min-width: 200px; max-width: 100%; }
        .search-input { width: 100%; padding: 10px 35px 10px 12px; border: none; border-radius: 8px; font-size: 0.95em; }
        .search-input:focus { outline: none; box-shadow: 0 0 8px rgba(0,0,0,0.2); }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #00A854; }
        .map-controls { display: flex; gap: 6px; flex-wrap: wrap; }
        .map-btn { padding: 8px 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.85em; transition: all 0.3s; white-space: nowrap; }
        .map-btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #00A854; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-outline { background: white; color: #333; }
        #map { height: 400px; width: 100%; }

        .booking-section { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
        .booking-container { background: white; border-radius: 15px; padding: 25px 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .booking-header { text-align: center; margin-bottom: 25px; }
        .booking-header h2 { font-size: 1.6em; color: #00A854; margin-bottom: 8px; }
        .booking-header p { color: #666; font-size: 0.95em; }
        .booking-form { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #333; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; font-size: 0.95em; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95em; transition: all 0.3s; width: 100%; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #00A854; }
        .input-with-button { display: flex; gap: 6px; width: 100%; }
        .input-with-button input { flex: 1; min-width: 0; }
        .btn-map-select { padding: 12px 10px; background: linear-gradient(135deg, #00A854, #FECB00); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 4px; font-size: 0.85em; flex-shrink: 0; }
        .btn-map-select:hover { transform: scale(1.02); }
        .btn-map-select i { font-size: 1em; }
        .btn-gps { background: linear-gradient(135deg, #2196F3, #00BCD4); }
        .btn-gps.loading i { animation: spin 1s linear infinite; }
        .btn-gps.success { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        .btn-gps.error { background: linear-gradient(135deg, #E30613, #F44336); }
        .datetime-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .vehicle-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 8px; }
        .vehicle-option { border: 2px solid #ddd; border-radius: 10px; padding: 12px 8px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f9f9f9; }
        .vehicle-option:hover { border-color: #FECB00; }
        .vehicle-option.selected { border-color: #00A854; background: #e8f5e9; }
        .vehicle-option-icon { font-size: 1.8em; margin-bottom: 6px; }
        .vehicle-option-name { font-weight: bold; font-size: 0.85em; }
        .vehicle-option-price { color: #00A854; font-weight: bold; font-size: 0.8em; margin-top: 4px; }

        .payment-methods { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
        .payment-method { padding: 10px 6px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f9f9f9; }
        .payment-method:hover { border-color: #FECB00; }
        .payment-method.selected { border-color: #00A854; background: #e8f5e9; }
        .payment-method-icon { font-size: 1.3em; margin-bottom: 4px; }
        .payment-method-name { font-size: 0.75em; font-weight: 600; }

        .booking-summary { background: linear-gradient(135deg, #00A854, #FECB00); padding: 20px 15px; border-radius: 12px; color: white; margin-top: 20px; display: none; }
        .summary-title { font-size: 1.2em; font-weight: bold; margin-bottom: 12px; text-align: center; }
        .summary-items { background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; gap: 10px; }
        .summary-item span:last-child { text-align: right; }
        .summary-total { background: rgba(255,255,255,0.3); padding: 10px 12px; border-radius: 8px; display: flex; justify-content: space-between; font-size: 1.1em; font-weight: bold; }
        .booking-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-book { padding: 14px 10px; font-size: 1em; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.3s; }
        .btn-book:hover { transform: scale(1.02); }
        .btn-book-primary { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-book-secondary { background: white; color: #00A854; border: 2px solid #00A854; }

        .tracking-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; overflow-y: auto; }
        .tracking-modal.active { display: block; }
        .tracking-container { max-width: 500px; margin: 10px auto; background: white; border-radius: 15px; overflow: hidden; min-height: calc(100vh - 20px); }
        .tracking-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .tracking-header h2 { font-size: 1.2em; display: flex; align-items: center; gap: 8px; }
        .tracking-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        
        #trackingMap { height: 280px; width: 100%; }
        
        .tracking-info { padding: 15px; }
        
        /* ‚úÖ NOUVEAU : Badge de mode trajet */
        .route-mode-badge { 
            background: linear-gradient(135deg, #2196F3, #00BCD4); 
            padding: 10px 15px; 
            border-radius: 12px; 
            color: white; 
            margin-bottom: 15px; 
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .route-mode-badge.course-mode { 
            background: linear-gradient(135deg, #00A854, #FECB00); 
        }
        
        .driver-approaching-box { background: linear-gradient(135deg, #2196F3, #00BCD4); padding: 18px; border-radius: 12px; color: white; margin-bottom: 15px; text-align: center; }
        .driver-approaching-title { font-size: 0.95em; opacity: 0.9; margin-bottom: 8px; }
        .driver-eta { font-size: 2.2em; font-weight: bold; margin-bottom: 4px; }
        .driver-eta-label { font-size: 0.85em; opacity: 0.9; }
        .driver-details-row { display: flex; justify-content: space-around; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.3); }
        .driver-detail { text-align: center; }
        .driver-detail-value { font-size: 1.2em; font-weight: bold; }
        .driver-detail-label { font-size: 0.7em; opacity: 0.8; }

        .status-timeline { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .status-step { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
        .status-step:last-child { border-bottom: none; }
        .status-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1em; background: #e0e0e0; color: #999; flex-shrink: 0; }
        .status-icon.active { background: #00A854; color: white; }
        .status-icon.current { background: #2196F3; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .status-text { flex: 1; min-width: 0; }
        .status-text h4 { font-size: 0.9em; color: #333; margin-bottom: 2px; }
        .status-text p { font-size: 0.75em; color: #666; }
        .status-time { font-size: 0.75em; color: #999; flex-shrink: 0; }

        .driver-card { background: white; border: 2px solid #e0e0e0; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .driver-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .driver-avatar { width: 55px; height: 55px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.6em; color: white; flex-shrink: 0; overflow: hidden; }
        .driver-info { flex: 1; min-width: 0; }
        .driver-info h3 { font-size: 1em; color: #333; margin-bottom: 4px; }
        .driver-info p { font-size: 0.85em; color: #666; }
        .driver-rating { color: #FFC107; }
        .driver-vehicle { background: #f5f5f5; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .vehicle-info { display: flex; align-items: center; gap: 8px; }
        .vehicle-icon { font-size: 1.4em; }
        
        .driver-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .driver-action-btn { padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85em; }
        .btn-call { background: #00A854; color: white; }
        .btn-message { background: #2196F3; color: white; }

        .trip-details { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .trip-details h3 { font-size: 0.95em; color: #333; margin-bottom: 12px; }
        .trip-route { display: flex; flex-direction: column; gap: 12px; }
        .trip-point { display: flex; align-items: flex-start; gap: 10px; }
        .trip-point-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85em; color: white; flex-shrink: 0; }
        .trip-point-icon.start { background: #4CAF50; }
        .trip-point-icon.end { background: #E30613; }
        .trip-point-text { flex: 1; min-width: 0; }
        .trip-point-label { font-size: 0.7em; color: #666; text-transform: uppercase; }
        .trip-point-address { font-size: 0.9em; color: #333; font-weight: 500; word-wrap: break-word; }
        .trip-connector { width: 2px; height: 20px; background: #ddd; margin-left: 13px; }
        .trip-price { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 2px dashed #ddd; }
        .trip-price-label { font-size: 0.85em; color: #666; }
        .trip-price-value { font-size: 1.3em; font-weight: bold; color: #00A854; }

        .cancel-booking-btn { width: 100%; padding: 14px; background: #f5f5f5; border: 2px solid #E30613; color: #E30613; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 8px; font-size: 0.95em; }
        .cancel-booking-btn:hover { background: #E30613; color: white; }

        .evaluation-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10005; display: none; align-items: center; justify-content: center; padding: 15px; overflow-y: auto; }
        .evaluation-modal.active { display: flex; }
        .evaluation-container { background: white; border-radius: 15px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .evaluation-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 20px 15px; color: white; text-align: center; border-radius: 15px 15px 0 0; }
        .evaluation-header h2 { font-size: 1.4em; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .evaluation-header p { font-size: 0.9em; opacity: 0.95; }
        .evaluation-content { padding: 20px 15px; }
        
        .evaluation-driver-summary { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .evaluation-driver-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; color: white; flex-shrink: 0; overflow: hidden; }
        .evaluation-driver-info h3 { font-size: 1em; color: #333; margin-bottom: 4px; }
        .evaluation-driver-info p { font-size: 0.85em; color: #666; }
        
        .rating-section { margin-bottom: 25px; }
        .rating-section h3 { font-size: 1em; color: #333; margin-bottom: 12px; text-align: center; }
        .star-rating { display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .star { font-size: 2.5em; color: #ddd; cursor: pointer; transition: all 0.2s; }
        .star:hover, .star.active { color: #FFC107; transform: scale(1.1); }
        .rating-label { text-align: center; font-size: 0.9em; color: #666; font-weight: 600; min-height: 24px; }
        
        .criteria-section { margin-bottom: 25px; }
        .criteria-section h3 { font-size: 1em; color: #333; margin-bottom: 15px; }
        .criteria-item { margin-bottom: 15px; }
        .criteria-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .criteria-label { font-size: 0.9em; color: #333; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .criteria-value { font-size: 0.85em; color: #00A854; font-weight: bold; }
        .criteria-stars { display: flex; gap: 4px; }
        .criteria-star { font-size: 1.2em; color: #ddd; cursor: pointer; transition: all 0.2s; }
        .criteria-star:hover, .criteria-star.active { color: #FFC107; }
        
        .comment-section { margin-bottom: 20px; }
        .comment-section h3 { font-size: 1em; color: #333; margin-bottom: 10px; }
        .comment-textarea { width: 100%; min-height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 0.9em; resize: vertical; }
        .comment-textarea:focus { outline: none; border-color: #00A854; }
        .comment-counter { text-align: right; font-size: 0.8em; color: #999; margin-top: 4px; }
        
        .evaluation-actions { display: flex; gap: 10px; padding-top: 15px; border-top: 1px solid #e0e0e0; }
        .evaluation-btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-weight: bold; font-size: 1em; cursor: pointer; transition: all 0.3s; }
        .btn-skip { background: #f5f5f5; color: #666; }
        .btn-submit-evaluation { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-submit-evaluation:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-skip:hover { background: #e0e0e0; }
        .btn-submit-evaluation:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,168,84,0.3); }
        .fa-spinner { animation: spin 1s linear infinite; }

        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10002; display: none; align-items: center; justify-content: center; padding: 20px; }
        .permission-modal.active { display: flex; }
        .permission-content { background: white; border-radius: 15px; padding: 25px 20px; max-width: 400px; width: 100%; text-align: center; }
        .permission-icon { font-size: 3em; margin-bottom: 15px; }
        .permission-title { font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 12px; }
        .permission-text { color: #666; line-height: 1.5; margin-bottom: 20px; font-size: 0.95em; }
        .permission-steps { background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
        .permission-steps h4 { font-size: 0.9em; color: #333; margin-bottom: 10px; }
        .permission-steps ol { margin-left: 20px; color: #666; font-size: 0.85em; }
        .permission-steps li { margin-bottom: 6px; }
        .permission-actions { display: flex; gap: 10px; }
        .permission-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.95em; }
        .btn-allow { background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; }
        .btn-cancel { background: #f5f5f5; color: #666; }
        .notification { position: fixed; top: 15px; right: 15px; left: 15px; max-width: 400px; margin: 0 auto; padding: 12px 20px; border-radius: 10px; color: white; font-weight: 600; z-index: 10001; animation: slideIn 0.3s; box-shadow: 0 8px 25px rgba(0,0,0,0.3); font-size: 0.9em; }
        @keyframes slideIn { from { transform: translateY(-100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #E30613; }
        .notification.info { background: #2196F3; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.2); border-top-color: #FECB00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 1.1em; margin-top: 18px; }

        .chatbot-button { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.4em; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.3); z-index: 9998; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .chatbot-window { position: fixed; bottom: 80px; right: 15px; left: 15px; max-width: 400px; height: 450px; background: white; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); z-index: 9999; display: none; flex-direction: column; overflow: hidden; margin: 0 auto; }
        .chatbot-window.active { display: flex; }
        .chatbot-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 12px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .chatbot-header div { font-size: 0.95em; font-weight: bold; }
        .chatbot-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1.1em; }
        .chatbot-messages { flex: 1; overflow-y: auto; padding: 12px; background: #f5f5f5; }
        .chatbot-message { margin-bottom: 10px; }
        .message-bot, .message-user { display: flex; gap: 8px; align-items: flex-start; }
        .message-user { flex-direction: row-reverse; }
        .message-avatar { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.9em; }
        .avatar-bot { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .avatar-user { background: #667eea; color: white; }
        .message-content { max-width: 70%; padding: 9px 12px; border-radius: 12px; line-height: 1.4; font-size: 0.85em; word-wrap: break-word; }
        .content-bot { background: white; border-bottom-left-radius: 4px; }
        .content-user { background: linear-gradient(135deg, #00A854, #FECB00); color: white; border-bottom-right-radius: 4px; }
        .chatbot-input-container { padding: 10px; background: white; display: flex; gap: 8px; }
        .chatbot-input { flex: 1; padding: 9px 12px; border: 2px solid #ddd; border-radius: 18px; font-size: 0.9em; min-width: 0; }
        .chatbot-input:focus { outline: none; border-color: #00A854; }
        .chatbot-send { width: 36px; height: 36px; background: #00A854; color: white; border: none; border-radius: 50%; cursor: pointer; flex-shrink: 0; font-size: 0.9em; }

        @media (max-width: 768px) {
            body { font-size: 14px; }
            .hero-section { padding: 30px 12px; }
            .hero-logo { width: 85px; height: 65px; }
            .hero-title { font-size: 1.6em; }
            .hero-subtitle { font-size: 0.9em; }
            .hero-cta { padding: 10px 24px; font-size: 0.95em; }
            
            .map-container { margin: 15px 10px; border-radius: 12px; }
            .map-header { flex-direction: column; padding: 10px 12px; }
            .map-logo { font-size: 1em; }
            .search-container { width: 100%; max-width: none; }
            .search-input { font-size: 0.9em; padding: 9px 32px 9px 10px; }
            .map-controls { width: 100%; justify-content: center; }
            .map-btn { padding: 7px 10px; font-size: 0.8em; }
            #map { height: 320px; }
            
            .booking-section { margin: 20px auto; padding: 0 10px; }
            .booking-container { padding: 20px 12px; border-radius: 12px; }
            .booking-header h2 { font-size: 1.4em; }
            .booking-header p { font-size: 0.9em; }
            .booking-form { gap: 12px; }
            .form-group label { font-size: 0.9em; }
            .form-group input, .form-group select { padding: 11px; font-size: 0.9em; }
            .input-with-button { gap: 5px; }
            .btn-map-select { padding: 11px 8px; font-size: 0.8em; min-width: 60px; }
            .btn-gps { min-width: 50px; padding: 11px 6px; }
            .datetime-group { gap: 8px; }
            
            .vehicle-options { gap: 8px; }
            .vehicle-option { padding: 10px 6px; }
            .vehicle-option-icon { font-size: 1.6em; }
            .vehicle-option-name { font-size: 0.8em; }
            .vehicle-option-price { font-size: 0.75em; }
            
            .payment-methods { gap: 6px; }
            .payment-method { padding: 9px 5px; }
            .payment-method-icon { font-size: 1.2em; }
            .payment-method-name { font-size: 0.7em; }
            
            .booking-summary { padding: 18px 12px; }
            .summary-title { font-size: 1.1em; }
            .summary-item { font-size: 0.85em; }
            .summary-total { font-size: 1em; padding: 9px 10px; }
            .booking-actions { gap: 8px; }
            .btn-book { padding: 12px 8px; font-size: 0.95em; }
            
            .tracking-container { margin: 5px; min-height: calc(100vh - 10px); border-radius: 12px; }
            .tracking-header { padding: 12px; }
            .tracking-header h2 { font-size: 1.1em; }
            .tracking-close { width: 32px; height: 32px; }
            #trackingMap { height: 240px; }
            .tracking-info { padding: 12px; }
            
            .driver-approaching-box { padding: 15px 12px; }
            .driver-approaching-title { font-size: 0.9em; }
            .driver-eta { font-size: 2em; }
            .driver-detail-value { font-size: 1.1em; }
            
            .status-timeline { padding: 12px; }
            .status-step { gap: 10px; padding: 8px 0; }
            .status-icon { width: 32px; height: 32px; font-size: 1em; }
            .status-text h4 { font-size: 0.85em; }
            .status-text p { font-size: 0.72em; }
            .status-time { font-size: 0.7em; }
            
            .driver-card { padding: 12px; }
            .driver-avatar { width: 50px; height: 50px; font-size: 1.5em; }
            .driver-info h3 { font-size: 0.95em; }
            .driver-info p { font-size: 0.8em; }
            .driver-vehicle { padding: 9px; }
            .driver-actions { gap: 6px; }
            .driver-action-btn { padding: 9px; font-size: 0.8em; }
            
            .trip-details { padding: 12px; }
            .trip-details h3 { font-size: 0.9em; }
            .trip-point-icon { width: 26px; height: 26px; font-size: 0.8em; }
            .trip-point-address { font-size: 0.85em; }
            .trip-price-value { font-size: 1.2em; }
            
            .cancel-booking-btn { padding: 12px; font-size: 0.9em; }
            
            .evaluation-container { max-height: 95vh; }
            .evaluation-header { padding: 18px 12px; }
            .evaluation-header h2 { font-size: 1.3em; }
            .evaluation-content { padding: 18px 12px; }
            .evaluation-driver-avatar { width: 45px; height: 45px; font-size: 1.4em; }
            .star { font-size: 2.2em; gap: 6px; }
            .criteria-item { margin-bottom: 12px; }
            .comment-textarea { min-height: 80px; font-size: 0.85em; }
            .evaluation-btn { padding: 12px; font-size: 0.95em; }
            
            .chatbot-button { width: 46px; height: 46px; font-size: 1.3em; bottom: 18px; right: 18px; }
            .chatbot-window { bottom: 75px; right: 12px; left: 12px; height: 420px; }
            .notification { font-size: 0.85em; padding: 10px 16px; }
            
            .permission-content { padding: 20px 15px; }
            .permission-icon { font-size: 2.5em; }
            .permission-title { font-size: 1.2em; }
            .permission-text { font-size: 0.9em; }
            .permission-steps { padding: 12px; }
            .permission-steps h4 { font-size: 0.85em; }
            .permission-steps ol { font-size: 0.8em; }
            .permission-steps li { margin-bottom: 5px; }
            .permission-btn { padding: 11px; font-size: 0.9em; }
        }
        
        @media (max-width: 380px) {
            .hero-title { font-size: 1.4em; }
            .booking-header h2 { font-size: 1.3em; }
            .btn-map-select { padding: 11px 6px; font-size: 0.75em; min-width: 55px; }
            .btn-map-select i { font-size: 0.9em; }
            .btn-gps { min-width: 45px; padding: 11px 5px; }
            .vehicle-options { grid-template-columns: 1fr 1fr; }
            .payment-methods { grid-template-columns: repeat(3, 1fr); }
            .payment-method-name { font-size: 0.65em; }
            .driver-eta { font-size: 1.8em; }
            .star { font-size: 2em; gap: 4px; }
            
            .permission-modal { padding: 15px; }
            .permission-content { padding: 18px 12px; }
            .permission-icon { font-size: 2.2em; }
            .permission-title { font-size: 1.1em; }
            .permission-text { font-size: 0.85em; }
            .permission-steps { padding: 10px; }
            .permission-steps h4 { font-size: 0.8em; }
            .permission-steps ol { margin-left: 18px; font-size: 0.75em; }
            .permission-actions { flex-direction: column; }
            .permission-btn { padding: 10px; font-size: 0.85em; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Chargement...</div>
    </div>

    <section class="hero-section">
        <img src="https://i.imgur.com/VtgG6pR.png" alt="Al Bourakh" class="hero-logo" onerror="this.style.display='none'">
        <h1 class="hero-title"><i class="fas fa-route"></i> Al Bourakh</h1>
        <p class="hero-subtitle">üöï Transport VTC ‚Ä¢ Suivi en Temps R√©el ‚Ä¢ 24/7</p>
        <button class="hero-cta" onclick="scrollToBooking()">
            <i class="fas fa-car"></i> R√©server une course
        </button>
    </section>

    <div class="map-container">
        <div class="map-header">
            <div class="map-logo">üöï Al Bourakh GPS</div>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Rechercher une adresse...">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="map-controls">
                <button class="map-btn btn-secondary" onclick="findMyLocation()">
                    <i class="fas fa-location-arrow"></i> Position
                </button>
                <button class="map-btn btn-outline" onclick="toggleTraffic()">
                    <i class="fas fa-traffic-light"></i> Trafic
                </button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <section class="booking-section">
        <div class="booking-container">
            <div class="booking-header">
                <h2>üöï R√©servez votre trajet</h2>
                <p>R√©servation simple et rapide</p>
            </div>

            <form class="booking-form" id="bookingForm" onsubmit="return false;">
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> Point de d√©part</label>
                    <div class="input-with-button">
                        <input type="text" id="bookingFrom" required placeholder="Votre position...">
                        <button type="button" class="btn-map-select btn-gps" onclick="getCurrentPosition()" title="Utiliser ma position actuelle">
                            <i class="fas fa-crosshairs" id="gpsIcon"></i> GPS
                        </button>
                        <button type="button" class="btn-map-select" onclick="selectOnMap('from')">
                            <i class="fas fa-map"></i> Carte
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-flag-checkered"></i> Destination</label>
                    <div class="input-with-button">
                        <input type="text" id="bookingTo" required placeholder="O√π allez-vous?">
                        <button type="button" class="btn-map-select" onclick="selectOnMap('to')">
                            <i class="fas fa-map"></i> Carte
                        </button>
                    </div>
                </div>
                
                <div class="datetime-group">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="bookingDate" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Heure</label>
                        <input type="time" id="bookingTime" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-phone"></i> T√©l√©phone</label>
                    <input type="tel" id="bookingPhone" required placeholder="+221 77 XXX XX XX">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Nom (optionnel)</label>
                    <input type="text" id="bookingName" placeholder="Votre nom">
                </div>
            </form>

            <div style="margin-top: 25px;">
                <h3 style="text-align: center; color: #00A854; margin-bottom: 12px; font-size: 1.1em;">
                    <i class="fas fa-car"></i> Type de v√©hicule
                </h3>
                <div class="vehicle-options">
                    <div class="vehicle-option" onclick="selectVehicle('standard', 1500)">
                        <div class="vehicle-option-icon">üöó</div>
                        <div class="vehicle-option-name">Standard</div>
                        <div class="vehicle-option-price">1 500 FCFA+</div>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('confort', 2000)">
                        <div class="vehicle-option-icon">‚ú®</div>
                        <div class="vehicle-option-name">Confort</div>
                        <div class="vehicle-option-price">2 000 FCFA+</div>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('van', 2500)">
                        <div class="vehicle-option-icon">üöê</div>
                        <div class="vehicle-option-name">Van</div>
                        <div class="vehicle-option-price">2 500 FCFA+</div>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('premium', 3500)">
                        <div class="vehicle-option-icon">üëë</div>
                        <div class="vehicle-option-name">Premium</div>
                        <div class="vehicle-option-price">3 500 FCFA+</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <h3 style="text-align: center; color: #00A854; margin-bottom: 12px; font-size: 1.1em;">
                    <i class="fas fa-credit-card"></i> Paiement
                </h3>
                <div class="payment-methods">
                    <div class="payment-method" onclick="selectPayment('cash')">
                        <div class="payment-method-icon">üíµ</div>
                        <div class="payment-method-name">Esp√®ces</div>
                    </div>
                    <div class="payment-method" onclick="selectPayment('orange')">
                        <div class="payment-method-icon">üì±</div>
                        <div class="payment-method-name">Orange Money</div>
                    </div>
                    <div class="payment-method" onclick="selectPayment('wave')">
                        <div class="payment-method-icon">üí≥</div>
                        <div class="payment-method-name">Wave</div>
                    </div>
                </div>
            </div>

            <div class="booking-summary" id="bookingSummary">
                <div class="summary-title">üìã R√©capitulatif</div>
                <div class="summary-items">
                    <div class="summary-item"><span>Trajet:</span><span id="summaryRoute">-</span></div>
                    <div class="summary-item"><span>Date:</span><span id="summaryDateTime">-</span></div>
                    <div class="summary-item"><span>V√©hicule:</span><span id="summaryVehicle">-</span></div>
                    <div class="summary-item"><span>Paiement:</span><span id="summaryPayment">-</span></div>
                </div>
                <div class="summary-total">
                    <span>Total estim√©:</span>
                    <span id="summaryTotal">0 FCFA</span>
                </div>
            </div>

            <div class="booking-actions">
                <button type="button" class="btn-book btn-book-secondary" onclick="previewBooking()">
                    <i class="fas fa-eye"></i> Aper√ßu
                </button>
                <button type="button" class="btn-book btn-book-primary" onclick="confirmBooking()">
                    <i class="fas fa-check"></i> Confirmer
                </button>
            </div>
        </div>
    </section>

    <div class="tracking-modal" id="trackingModal">
        <div class="tracking-container">
            <div class="tracking-header">
                <h2><i class="fas fa-route"></i> Suivi de course</h2>
                <button class="tracking-close" onclick="closeTracking()">√ó</button>
            </div>

            <div id="trackingMap"></div>

            <div class="tracking-info">
                <!-- ‚úÖ NOUVEAU : Badge indiquant le mode de trajet -->
                <div class="route-mode-badge" id="routeModeBadge" style="display: none;">
                    <i class="fas fa-car-side"></i>
                    <span id="routeModeText">Chauffeur en approche</span>
                </div>

                <div class="driver-approaching-box" id="driverApproachingBox">
                    <div class="driver-approaching-title">üöó Votre chauffeur arrive</div>
                    <div class="driver-eta" id="driverETA">--</div>
                    <div class="driver-eta-label">minutes</div>
                    <div class="driver-details-row">
                        <div class="driver-detail">
                            <div class="driver-detail-value" id="driverDistance">--</div>
                            <div class="driver-detail-label">Distance</div>
                        </div>
                        <div class="driver-detail">
                            <div class="driver-detail-value" id="driverArrivalTime">--</div>
                            <div class="driver-detail-label">Arriv√©e pr√©vue</div>
                        </div>
                    </div>
                </div>

                <div class="status-timeline">
                    <div class="status-step" id="step1">
                        <div class="status-icon active"><i class="fas fa-check"></i></div>
                        <div class="status-text">
                            <h4>R√©servation confirm√©e</h4>
                            <p>Votre course a √©t√© enregistr√©e</p>
                        </div>
                        <div class="status-time" id="step1Time">--:--</div>
                    </div>
                    <div class="status-step" id="step2">
                        <div class="status-icon" id="step2Icon"><i class="fas fa-user-check"></i></div>
                        <div class="status-text">
                            <h4>Chauffeur assign√©</h4>
                            <p id="step2Text">En attente d'un chauffeur...</p>
                        </div>
                        <div class="status-time" id="step2Time">--:--</div>
                    </div>
                    <div class="status-step" id="step3">
                        <div class="status-icon" id="step3Icon"><i class="fas fa-car"></i></div>
                        <div class="status-text">
                            <h4>Chauffeur en route</h4>
                            <p id="step3Text">Le chauffeur se dirige vers vous</p>
                        </div>
                        <div class="status-time" id="step3Time">--:--</div>
                    </div>
                    <div class="status-step" id="step4">
                        <div class="status-icon" id="step4Icon"><i class="fas fa-map-pin"></i></div>
                        <div class="status-text">
                            <h4>Chauffeur arriv√©</h4>
                            <p>Le chauffeur est au point de prise en charge</p>
                        </div>
                        <div class="status-time" id="step4Time">--:--</div>
                    </div>
                    <div class="status-step" id="step5">
                        <div class="status-icon" id="step5Icon"><i class="fas fa-flag-checkered"></i></div>
                        <div class="status-text">
                            <h4>Course en cours</h4>
                            <p>Direction votre destination</p>
                        </div>
                        <div class="status-time" id="step5Time">--:--</div>
                    </div>
                </div>

                <div class="driver-card" id="driverCard" style="display: none;">
                    <div class="driver-card-header">
                        <div class="driver-avatar">üë§</div>
                        <div class="driver-info">
                            <h3 id="driverName">Chauffeur</h3>
                            <p><span class="driver-rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span> <span id="driverRating">4.9</span></p>
                        </div>
                    </div>
                    <div class="driver-vehicle">
                        <div class="vehicle-info">
                            <span class="vehicle-icon">üöó</span>
                            <div>
                                <div id="vehicleModel" style="font-weight: bold; font-size: 0.9em;">Toyota Corolla</div>
                                <div id="vehiclePlate" style="font-size: 0.75em; color: #666;">DK-1234-AB</div>
                            </div>
                        </div>
                    </div>
                    <div class="driver-actions">
                        <button class="driver-action-btn btn-call" onclick="callDriver()">
                            <i class="fas fa-phone"></i> Appeler
                        </button>
                        <button class="driver-action-btn btn-message" onclick="messageDriver()">
                            <i class="fas fa-comment"></i> Message
                        </button>
                    </div>
                </div>

                <div class="trip-details">
                    <h3>üó∫Ô∏è D√©tails du trajet</h3>
                    <div class="trip-route">
                        <div class="trip-point">
                            <div class="trip-point-icon start"><i class="fas fa-circle"></i></div>
                            <div class="trip-point-text">
                                <div class="trip-point-label">D√©part</div>
                                <div class="trip-point-address" id="tripFrom">-</div>
                            </div>
                        </div>
                        <div class="trip-connector"></div>
                        <div class="trip-point">
                            <div class="trip-point-icon end"><i class="fas fa-flag"></i></div>
                            <div class="trip-point-text">
                                <div class="trip-point-label">Destination</div>
                                <div class="trip-point-address" id="tripTo">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="trip-price">
                        <span class="trip-price-label">Prix estim√©</span>
                        <span class="trip-price-value" id="tripPrice">0 FCFA</span>
                    </div>
                </div>

                <button class="cancel-booking-btn" onclick="cancelBooking()">
                    <i class="fas fa-times"></i> Annuler la r√©servation
                </button>
            </div>
        </div>
    </div>

    <div class="evaluation-modal" id="evaluationModal">
        <div class="evaluation-container">
            <div class="evaluation-header">
                <h2><i class="fas fa-star"></i> √âvaluez votre course</h2>
                <p>Votre avis nous aide √† am√©liorer notre service</p>
            </div>
            
            <div class="evaluation-content">
                <div class="evaluation-driver-summary">
                    <div class="evaluation-driver-avatar">üë§</div>
                    <div class="evaluation-driver-info">
                        <h3 id="evalDriverName">Chauffeur</h3>
                        <p id="evalVehicle">Toyota Corolla ‚Ä¢ DK-1234-AB</p>
                    </div>
                </div>

                <div class="rating-section">
                    <h3>Note globale</h3>
                    <div class="star-rating" id="overallRating">
                        <span class="star" data-rating="1">‚òÖ</span>
                        <span class="star" data-rating="2">‚òÖ</span>
                        <span class="star" data-rating="3">‚òÖ</span>
                        <span class="star" data-rating="4">‚òÖ</span>
                        <span class="star" data-rating="5">‚òÖ</span>
                    </div>
                    <div class="rating-label" id="overallRatingLabel">S√©lectionnez une note</div>
                </div>

                <div class="criteria-section">
                    <h3>Crit√®res d'√©valuation</h3>
                    
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-label">
                                <i class="fas fa-car" style="color: #2196F3;"></i> Conduite
                            </span>
                            <span class="criteria-value" id="conduiteValue">-</span>
                        </div>
                        <div class="criteria-stars" id="conduiteRating">
                            <span class="criteria-star" data-criteria="conduite" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="conduite" data-rating="5">‚òÖ</span>
                        </div>
                    </div>

                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-label">
                                <i class="fas fa-clock" style="color: #FF9800;"></i> Ponctualit√©
                            </span>
                            <span class="criteria-value" id="ponctualiteValue">-</span>
                        </div>
                        <div class="criteria-stars" id="ponctualiteRating">
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="ponctualite" data-rating="5">‚òÖ</span>
                        </div>
                    </div>

                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-label">
                                <i class="fas fa-spray-can" style="color: #00BCD4;"></i> Propret√©
                            </span>
                            <span class="criteria-value" id="propreteValue">-</span>
                        </div>
                        <div class="criteria-stars" id="propreteRating">
                            <span class="criteria-star" data-criteria="proprete" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="proprete" data-rating="5">‚òÖ</span>
                        </div>
                    </div>

                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-label">
                                <i class="fas fa-smile" style="color: #4CAF50;"></i> Amabilit√©
                            </span>
                            <span class="criteria-value" id="amabiliteValue">-</span>
                        </div>
                        <div class="criteria-stars" id="amabiliteRating">
                            <span class="criteria-star" data-criteria="amabilite" data-rating="1">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="2">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="3">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="4">‚òÖ</span>
                            <span class="criteria-star" data-criteria="amabilite" data-rating="5">‚òÖ</span>
                        </div>
                    </div>
                </div>

                <div class="comment-section">
                    <h3><i class="fas fa-comment-dots"></i> Commentaire (optionnel)</h3>
                    <textarea 
                        id="evaluationComment" 
                        class="comment-textarea" 
                        placeholder="Partagez votre exp√©rience avec ce chauffeur..."
                        maxlength="500"
                    ></textarea>
                    <div class="comment-counter">
                        <span id="commentLength">0</span>/500
                    </div>
                </div>

                <div class="evaluation-actions">
                    <button class="evaluation-btn btn-skip" id="skipEvaluationBtn">
                        Plus tard
                    </button>
                    <button class="evaluation-btn btn-submit-evaluation" id="submitEvaluationBtn" disabled>
                        <i class="fas fa-paper-plane"></i> Envoyer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="chatbot-button" onclick="toggleChatbot()">üí¨</div>

    <div class="permission-modal" id="permissionModal">
        <div class="permission-content">
            <div class="permission-icon">üìç</div>
            <div class="permission-title">Activer la g√©olocalisation</div>
            <div class="permission-text">
                Al Bourakh a besoin d'acc√©der √† votre position pour vous offrir le meilleur service.
            </div>
            <div class="permission-steps">
                <h4>üí° Comment activer :</h4>
                <ol>
                    <li>Appuyez sur l'ic√¥ne üîí ou ‚ìò dans la barre d'adresse</li>
                    <li>Trouvez "Position" ou "Localisation"</li>
                    <li>S√©lectionnez "Autoriser"</li>
                    <li>Rechargez la page</li>
                </ol>
            </div>
            <div class="permission-actions">
                <button class="permission-btn btn-cancel" onclick="closePermissionModal()">Plus tard</button>
                <button class="permission-btn btn-allow" onclick="requestLocationPermission()">Autoriser</button>
            </div>
        </div>
    </div>

    <div class="chatbot-window" id="chatbotWindow">
        <div class="chatbot-header">
            <div>ü§ñ Assistant Al Bourakh</div>
            <button class="chatbot-close" onclick="toggleChatbot()">√ó</button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="chatbot-message message-bot">
                <div class="message-avatar avatar-bot">üöï</div>
                <div class="message-content content-bot">
                    Bonjour! Je suis l'assistant Al Bourakh. Comment puis-je vous aider?
                </div>
            </div>
        </div>
        <div class="chatbot-input-container">
            <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Votre question..." onkeypress="if(event.key==='Enter')sendChatMessage()">
            <button class="chatbot-send" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
            authDomain: "albourakh-sn-ok.firebaseapp.com",
            projectId: "albourakh-sn-ok",
            storageBucket: "albourakh-sn-ok.firebasestorage.app",
            messagingSenderId: "297875396274",
            appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log('üöï Al Bourakh Client v2.4 - SYNCHRONISATION TRAJETS');

        let map, trackingMap, trafficLayer, autocomplete, geocoder;
        let directionsService, directionsRenderer, trackingDirectionsRenderer;
        let userMarker, departureMarker, destinationMarker;
        let driverMarker, clientPickupMarker;
        let selectedVehicle = null, selectedVehiclePrice = 0, selectedPayment = null;
        let mapSelectionMode = null;
        let departureCoords = null, destinationCoords = null;
        let currentBooking = null;
        let reservationListener = null;
        let driverListener = null;
        let lastDriverPosition = null;
        let trackingUpdateInterval = null;
        
        // ‚úÖ NOUVEAU : Variable pour g√©rer le mode de trajet
        let currentTrackingMode = 'approche'; // 'approche' ou 'course'
        
        let evaluationData = {
            noteGlobale: 0,
            conduite: 0,
            ponctualite: 0,
            proprete: 0,
            amabilite: 0,
            commentaire: ''
        };
        
        let simulationMode = false;
        let simulatedDriverPosition = null;

        function normalizePhoneForComparison(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, '');
        }

        function getPhoneVariants(phone) {
            const digits = normalizePhoneForComparison(phone);
            const variants = new Set();
            
            variants.add(digits);
            const localNumber = digits.slice(-9);
            
            variants.add(localNumber);
            variants.add('+221' + localNumber);
            variants.add('221' + localNumber);
            variants.add('00221' + localNumber);
            
            if (digits.startsWith('221')) {
                variants.add('+' + digits);
                const local = digits.substring(3);
                variants.add(local);
                variants.add('+221' + local);
            }
            
            if (digits.startsWith('+221')) {
                variants.add(digits.substring(1));
                variants.add(digits.substring(4));
            }
            
            return [...variants].filter(v => {
                const cleaned = v.replace(/\D/g, '');
                return cleaned.length >= 9;
            });
        }

        async function fetchDriverPhoto(driverId, driverPhone, driverNom, driverPrenom) {
            console.log('üì∏ Recherche photo chauffeur:', { driverId, driverPhone, driverNom, driverPrenom });
            
            try {
                console.log('üì° Recherche dans drivers...');
                const driverDoc = await db.collection('drivers').doc(driverId).get();
                
                if (driverDoc.exists) {
                    const driverData = driverDoc.data();
                    
                    const photoUrl = driverData.photoProfil ||
                                   driverData.photoIdentite || 
                                   driverData.photoUrl || 
                                   driverData.photos?.photoProfil ||
                                   driverData.photos?.photoIdentite ||
                                   driverData.photos?.photo_identite;
                    
                    if (photoUrl) {
                        console.log('‚úÖ Photo trouv√©e dans drivers:', photoUrl);
                        return photoUrl;
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur recherche dans drivers:', error);
            }
            
            if (driverPhone) {
                try {
                    console.log('üì° Recherche dans candidatures par t√©l√©phone...');
                    
                    const phoneVariants = getPhoneVariants(driverPhone);
                    
                    const candidaturesSnapshot = await db.collection('candidatures')
                        .where('statut', '==', 'acceptee')
                        .get();
                    
                    for (const doc of candidaturesSnapshot.docs) {
                        const candidature = doc.data();
                        const candidaturePhone = candidature.telephone || candidature.phone || '';
                        const candidatureDigits = normalizePhoneForComparison(candidaturePhone);
                        
                        for (const variant of phoneVariants) {
                            const variantDigits = normalizePhoneForComparison(variant);
                            
                            if (candidatureDigits === variantDigits || 
                                candidatureDigits.endsWith(variantDigits.slice(-9)) ||
                                variantDigits.endsWith(candidatureDigits.slice(-9))) {
                                
                                const photoUrl = candidature.photoProfil ||
                                               candidature.photos?.photoProfil ||
                                               candidature.photos?.photoIdentite || 
                                               candidature.photos?.photo_identite ||
                                               candidature.photoIdentite || 
                                               candidature.photoUrl ||
                                               candidature.photo;
                                
                                if (photoUrl) {
                                    console.log('‚úÖ Photo trouv√©e dans candidatures (t√©l√©phone):', photoUrl);
                                    return photoUrl;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur recherche dans candidatures:', error);
                }
            }
            
            if (driverNom && driverPrenom) {
                try {
                    console.log('üì° Recherche dans candidatures par nom/pr√©nom...');
                    
                    const candidaturesSnapshot = await db.collection('candidatures')
                        .where('statut', '==', 'acceptee')
                        .get();
                    
                    for (const doc of candidaturesSnapshot.docs) {
                        const candidature = doc.data();
                        const nomMatch = candidature.nom?.toLowerCase().trim() === driverNom?.toLowerCase().trim();
                        const prenomMatch = candidature.prenom?.toLowerCase().trim() === driverPrenom?.toLowerCase().trim();
                        
                        if (nomMatch && prenomMatch) {
                            const photoUrl = candidature.photoProfil ||
                                           candidature.photos?.photoProfil ||
                                           candidature.photos?.photoIdentite || 
                                           candidature.photos?.photo_identite ||
                                           candidature.photoIdentite || 
                                           candidature.photoUrl ||
                                           candidature.photo;
                            
                            if (photoUrl) {
                                console.log('‚úÖ Photo trouv√©e dans candidatures (nom):', photoUrl);
                                return photoUrl;
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur recherche par nom:', error);
                }
            }
            
            console.log('‚ùå AUCUNE PHOTO TROUV√âE');
            return null;
        }

        function initMap() {
            const dakar = { lat: 14.6937, lng: -17.4441 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: dakar,
                zoom: 12,
                disableDefaultUI: true,
                zoomControl: true
            });

            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true,
                polylineOptions: { strokeColor: '#00A854', strokeWeight: 5 }
            });

            trafficLayer = new google.maps.TrafficLayer();

            const searchInput = document.getElementById('searchInput');
            autocomplete = new google.maps.places.Autocomplete(searchInput, {
                componentRestrictions: { country: 'sn' }
            });
            autocomplete.addListener('place_changed', onPlaceSelected);

            initBookingAutocomplete();
            map.addListener('click', handleMapClick);
            autoDetectLocation();
            initDateTime();
            initEvaluationListeners();

            console.log('‚úÖ Map initialized');
        }

        function initBookingAutocomplete() {
            const fromInput = document.getElementById('bookingFrom');
            const toInput = document.getElementById('bookingTo');

            const autocompleteFrom = new google.maps.places.Autocomplete(fromInput, {
                componentRestrictions: { country: 'sn' }
            });
            autocompleteFrom.addListener('place_changed', () => {
                const place = autocompleteFrom.getPlace();
                if (place.geometry) {
                    departureCoords = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    };
                    updateMarker('departure', departureCoords);
                    calculateRoute();
                }
            });

            const autocompleteTo = new google.maps.places.Autocomplete(toInput, {
                componentRestrictions: { country: 'sn' }
            });
            autocompleteTo.addListener('place_changed', () => {
                const place = autocompleteTo.getPlace();
                if (place.geometry) {
                    destinationCoords = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    };
                    updateMarker('destination', destinationCoords);
                    calculateRoute();
                }
            });
        }

        function onPlaceSelected() {
            const place = autocomplete.getPlace();
            if (place.geometry) {
                map.setCenter(place.geometry.location);
                map.setZoom(15);
            }
        }

        function autoDetectLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        departureCoords = userPos;
                        
                        map.setCenter(userPos);
                        map.setZoom(14);

                        geocoder.geocode({ location: userPos }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                document.getElementById('bookingFrom').value = results[0].formatted_address;
                                updateMarker('departure', userPos);
                            }
                        });
                    },
                    () => console.log('Geolocation denied')
                );
            }
        }

        async function getCurrentPosition() {
            const gpsBtn = event.currentTarget;
            const gpsIcon = document.getElementById('gpsIcon');
            const fromInput = document.getElementById('bookingFrom');
            
            if (window.self !== window.top) {
                showNotification('‚ö†Ô∏è GPS d√©sactiv√© dans cette pr√©visualisation', 'error');
                gpsBtn.classList.add('error');
                setTimeout(() => {
                    gpsBtn.classList.remove('error');
                    showTestLocationModal();
                }, 1500);
                return;
            }
            
            if (!navigator.geolocation) {
                showNotification('‚ùå G√©olocalisation non disponible sur cet appareil', 'error');
                gpsBtn.classList.add('error');
                setTimeout(() => {
                    gpsBtn.classList.remove('error');
                    showTestLocationModal();
                }, 1500);
                return;
            }

            if (navigator.permissions && navigator.permissions.query) {
                try {
                    const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                    
                    if (permissionStatus.state === 'denied') {
                        showPermissionModal();
                        gpsBtn.classList.add('error');
                        setTimeout(() => gpsBtn.classList.remove('error'), 2000);
                        return;
                    }
                } catch (e) {
                    console.log('Permissions API non support√©e');
                }
            }

            gpsBtn.classList.add('loading');
            gpsBtn.disabled = true;
            fromInput.placeholder = 'üìç R√©cup√©ration de votre position...';
            showNotification('üìç Localisation en cours...', 'info');

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    departureCoords = userPos;
                    map.setCenter(userPos);
                    map.setZoom(16);
                    
                    geocoder.geocode({ location: userPos }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            fromInput.value = results[0].formatted_address;
                            updateMarker('departure', userPos);
                            
                            if (destinationCoords) {
                                calculateRoute();
                            }
                            
                            gpsBtn.classList.remove('loading');
                            gpsBtn.classList.add('success');
                            gpsBtn.disabled = false;
                            fromInput.placeholder = 'Votre position...';
                            
                            const accuracy = Math.round(position.coords.accuracy);
                            showNotification(`‚úÖ Position d√©tect√©e (¬±${accuracy}m)`, 'success');
                            
                            setTimeout(() => {
                                gpsBtn.classList.remove('success');
                            }, 2000);
                        }
                    });
                },
                (error) => {
                    gpsBtn.classList.remove('loading');
                    gpsBtn.classList.add('error');
                    gpsBtn.disabled = false;
                    fromInput.placeholder = 'Votre position...';
                    
                    let errorMessage = '‚ùå Erreur de localisation';
                    let showModal = false;
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '‚ö†Ô∏è Autorisation requise';
                            showModal = true;
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '‚ùå Signal GPS indisponible';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '‚è±Ô∏è D√©lai d√©pass√©';
                            break;
                    }
                    
                    showNotification(errorMessage, 'error');
                    
                    if (showModal) {
                        setTimeout(() => showPermissionModal(), 1000);
                    }
                    
                    setTimeout(() => {
                        gpsBtn.classList.remove('error');
                    }, 2000);
                },
                options
            );
        }

        function showTestLocationModal() {
            const testLocations = [
                { name: 'Place de l\'Ind√©pendance', lat: 14.6937, lng: -17.4441 },
                { name: 'Plateau (Centre-ville)', lat: 14.6843, lng: -17.4444 },
                { name: 'Almadies', lat: 14.7458, lng: -17.5071 },
                { name: 'Parcelles Assainies', lat: 14.7644, lng: -17.4383 },
                { name: 'Grand Yoff', lat: 14.7503, lng: -17.4581 },
                { name: 'Pikine', lat: 14.7549, lng: -17.3901 }
            ];
            
            let html = `
                <div class="permission-modal active" id="testLocationModal" style="z-index: 10003;">
                    <div class="permission-content">
                        <div class="permission-icon">üó∫Ô∏è</div>
                        <div class="permission-title">Mode Test - Choisir une position</div>
                        <div class="permission-text">
                            Le GPS n'est pas disponible dans cette pr√©visualisation. Choisissez une position de test √† Dakar :
                        </div>
                        <div style="max-height: 250px; overflow-y: auto; margin: 15px 0;">
            `;
            
            testLocations.forEach((loc, i) => {
                html += `
                    <button onclick="setTestLocation(${loc.lat}, ${loc.lng}, '${loc.name}')" 
                            style="width: 100%; padding: 12px; margin-bottom: 8px; background: #f5f5f5; 
                                   border: 2px solid #ddd; border-radius: 8px; cursor: pointer; text-align: left;
                                   font-size: 0.9em; transition: all 0.2s;">
                        <strong>${loc.name}</strong><br>
                        <small style="color: #666;">Lat: ${loc.lat.toFixed(4)}, Lng: ${loc.lng.toFixed(4)}</small>
                    </button>
                `;
            });
            
            html += `
                        </div>
                        <div class="permission-actions">
                            <button class="permission-btn btn-cancel" onclick="closeTestLocationModal()">Annuler</button>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #FFF9C4; border-radius: 8px; font-size: 0.8em; color: #666;">
                            üí° <strong>Pour utiliser le vrai GPS :</strong><br>
                            D√©ployez sur un serveur HTTPS (Vercel, Netlify, etc.)
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('testLocationModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
            document.body.style.overflow = 'hidden';
        }

        function setTestLocation(lat, lng, name) {
            const userPos = { lat, lng };
            departureCoords = userPos;
            
            map.setCenter(userPos);
            map.setZoom(15);
            
            geocoder.geocode({ location: userPos }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    document.getElementById('bookingFrom').value = results[0].formatted_address;
                } else {
                    document.getElementById('bookingFrom').value = name;
                }
                
                updateMarker('departure', userPos);
                
                if (destinationCoords) {
                    calculateRoute();
                }
            });
            
            closeTestLocationModal();
            showNotification(`‚úÖ Position : ${name}`, 'success');
        }

        function closeTestLocationModal() {
            const modal = document.getElementById('testLocationModal');
            if (modal) modal.remove();
            document.body.style.overflow = '';
        }

        function showPermissionModal() {
            document.getElementById('permissionModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePermissionModal() {
            document.getElementById('permissionModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function requestLocationPermission() {
            closePermissionModal();
            showNotification('üí° Appuyez sur "Autoriser"', 'info');
            setTimeout(() => getCurrentPosition(), 500);
        }

        function initDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            
            const dateInput = document.getElementById('bookingDate');
            const timeInput = document.getElementById('bookingTime');
            
            dateInput.value = now.toISOString().split('T')[0];
            dateInput.min = new Date().toISOString().split('T')[0];
            timeInput.value = now.toTimeString().slice(0, 5);
        }

        function findMyLocation() {
            if (navigator.geolocation) {
                showNotification('üìç Localisation...', 'info');
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 0
                };
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        map.setCenter(userPos);
                        map.setZoom(16);
                        
                        if (userMarker) userMarker.setMap(null);
                        userMarker = new google.maps.Marker({
                            position: userPos,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeColor: 'white',
                                strokeWeight: 3
                            },
                            animation: google.maps.Animation.BOUNCE,
                            title: 'Vous √™tes ici'
                        });
                        
                        setTimeout(() => userMarker.setAnimation(null), 2000);
                        
                        const accuracy = Math.round(pos.coords.accuracy);
                        showNotification(`‚úÖ Position trouv√©e (¬±${accuracy}m)`, 'success');
                    },
                    (error) => {
                        let errorMsg = '‚ùå Localisation refus√©e';
                        if (error.code === error.TIMEOUT) {
                            errorMsg = '‚ùå D√©lai de localisation d√©pass√©';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMsg = '‚ùå Position GPS indisponible';
                        }
                        showNotification(errorMsg, 'error');
                    },
                    options
                );
            } else {
                showNotification('‚ùå G√©olocalisation non support√©e', 'error');
            }
        }

        function toggleTraffic() {
            if (trafficLayer.getMap()) {
                trafficLayer.setMap(null);
                showNotification('üö¶ Trafic d√©sactiv√©', 'info');
            } else {
                trafficLayer.setMap(map);
                showNotification('üö¶ Trafic activ√©', 'success');
            }
        }

        function selectOnMap(type) {
            mapSelectionMode = type;
            showNotification(`üó∫Ô∏è Cliquez sur la carte pour ${type === 'from' ? 'le d√©part' : 'la destination'}`, 'info');
            map.getDiv().style.cursor = 'crosshair';
            document.querySelector('.map-container').scrollIntoView({ behavior: 'smooth' });
        }

        function handleMapClick(event) {
            if (!mapSelectionMode) return;
            
            const location = event.latLng;
            geocoder.geocode({ location: location }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const address = results[0].formatted_address;
                    
                    if (mapSelectionMode === 'from') {
                        document.getElementById('bookingFrom').value = address;
                        departureCoords = { lat: location.lat(), lng: location.lng() };
                        updateMarker('departure', departureCoords);
                    } else {
                        document.getElementById('bookingTo').value = address;
                        destinationCoords = { lat: location.lat(), lng: location.lng() };
                        updateMarker('destination', destinationCoords);
                    }
                    
                    calculateRoute();
                    showNotification(`‚úÖ ${mapSelectionMode === 'from' ? 'D√©part' : 'Destination'} s√©lectionn√©`, 'success');
                }
                
                mapSelectionMode = null;
                map.getDiv().style.cursor = '';
            });
        }

        function updateMarker(type, coords) {
            if (type === 'departure') {
                if (departureMarker) departureMarker.setMap(null);
                departureMarker = new google.maps.Marker({
                    position: coords,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#4CAF50',
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 3
                    },
                    label: { text: 'A', color: 'white', fontWeight: 'bold' }
                });
            } else {
                if (destinationMarker) destinationMarker.setMap(null);
                destinationMarker = new google.maps.Marker({
                    position: coords,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#E30613',
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 3
                    },
                    label: { text: 'B', color: 'white', fontWeight: 'bold' }
                });
            }
        }

        function calculateRoute() {
            if (!departureCoords || !destinationCoords) return;

            directionsService.route({
                origin: departureCoords,
                destination: destinationCoords,
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                }
            });
        }

        function selectVehicle(type, price) {
            selectedVehicle = type;
            selectedVehiclePrice = price;
            document.querySelectorAll('.vehicle-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            showNotification(`‚úÖ V√©hicule: ${type}`, 'success');
        }

        function selectPayment(method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            showNotification(`‚úÖ Paiement: ${method}`, 'success');
        }

        function previewBooking() {
            const from = document.getElementById('bookingFrom').value.trim();
            const to = document.getElementById('bookingTo').value.trim();
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            const phone = document.getElementById('bookingPhone').value.trim();

            if (!from || !to || !date || !time || !phone) {
                showNotification('‚ö†Ô∏è Remplissez tous les champs', 'error');
                return;
            }
            if (!selectedVehicle) {
                showNotification('‚ö†Ô∏è S√©lectionnez un v√©hicule', 'error');
                return;
            }
            if (!selectedPayment) {
                showNotification('‚ö†Ô∏è S√©lectionnez un paiement', 'error');
                return;
            }

            let distance = 10;
            if (departureCoords && destinationCoords) {
                distance = calculateDistance(departureCoords, destinationCoords);
            }
            const pricePerKm = { standard: 200, confort: 250, van: 300, premium: 400 };
            const totalPrice = Math.round(selectedVehiclePrice + (distance * pricePerKm[selectedVehicle]));

            const vehicleNames = { standard: 'üöó Standard', confort: '‚ú® Confort', van: 'üöê Van', premium: 'üëë Premium' };
            const paymentNames = { cash: 'üíµ Esp√®ces', orange: 'üì± Orange Money', wave: 'üí≥ Wave' };

            document.getElementById('summaryRoute').textContent = `${from.substring(0, 15)}... ‚Üí ${to.substring(0, 15)}...`;
            document.getElementById('summaryDateTime').textContent = `${date} √† ${time}`;
            document.getElementById('summaryVehicle').textContent = vehicleNames[selectedVehicle];
            document.getElementById('summaryPayment').textContent = paymentNames[selectedPayment];
            document.getElementById('summaryTotal').textContent = `${totalPrice.toLocaleString()} FCFA`;

            document.getElementById('bookingSummary').style.display = 'block';
            document.getElementById('bookingSummary').scrollIntoView({ behavior: 'smooth' });
        }

        function calculateDistance(p1, p2) {
            const R = 6371;
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLon = (p2.lng - p1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function confirmBooking() {
            const summary = document.getElementById('bookingSummary');
            if (summary.style.display === 'none') {
                showNotification('‚ö†Ô∏è Cliquez d\'abord sur Aper√ßu', 'error');
                return;
            }

            showLoading('Enregistrement...');

            const bookingData = {
                clientNom: document.getElementById('bookingName').value.trim() || 'Client',
                clientTelephone: document.getElementById('bookingPhone').value.trim(),
                depart: document.getElementById('bookingFrom').value.trim(),
                destination: document.getElementById('bookingTo').value.trim(),
                departCoords: departureCoords,
                destinationCoords: destinationCoords,
                dateReservation: document.getElementById('bookingDate').value,
                heureReservation: document.getElementById('bookingTime').value,
                vehiculeType: selectedVehicle,
                modePaiement: selectedPayment,
                prixEstime: parseInt(document.getElementById('summaryTotal').textContent.replace(/\D/g, '')),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                statut: 'en_attente',
                chauffeurAssigne: null,
                nomChauffeur: null,
                telephoneChauffeur: null
            };

            try {
                const docRef = await db.collection('reservations').add(bookingData);
                
                currentBooking = {
                    id: docRef.id,
                    ...bookingData
                };

                hideLoading();
                showNotification('‚úÖ R√©servation confirm√©e!', 'success');

                openTracking();
                startReservationListener(docRef.id);

            } catch (error) {
                hideLoading();
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function openTracking() {
            document.getElementById('trackingModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            document.getElementById('tripFrom').textContent = currentBooking.depart;
            document.getElementById('tripTo').textContent = currentBooking.destination;
            document.getElementById('tripPrice').textContent = currentBooking.prixEstime.toLocaleString() + ' FCFA';

            document.getElementById('step1Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            // ‚úÖ INITIALISER EN MODE APPROCHE
            currentTrackingMode = 'approche';
            updateTrackingModeDisplay();

            setTimeout(() => initTrackingMap(), 300);
        }

        function closeTracking() {
            document.getElementById('trackingModal').classList.remove('active');
            document.body.style.overflow = '';
            
            if (reservationListener) {
                reservationListener();
                reservationListener = null;
            }
            if (driverListener) {
                driverListener();
                driverListener = null;
            }
        }

        function initTrackingMap() {
            if (!currentBooking || !currentBooking.departCoords) return;

            trackingMap = new google.maps.Map(document.getElementById('trackingMap'), {
                center: currentBooking.departCoords,
                zoom: 14,
                disableDefaultUI: true,
                zoomControl: true
            });

            trackingDirectionsRenderer = new google.maps.DirectionsRenderer({
                map: trackingMap,
                suppressMarkers: true,
                polylineOptions: { strokeColor: '#2196F3', strokeWeight: 5, strokeOpacity: 0.8 }
            });

            clientPickupMarker = new google.maps.Marker({
                position: currentBooking.departCoords,
                map: trackingMap,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#4CAF50',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 3
                },
                label: { text: 'üìç', fontSize: '16px' }
            });

            if (currentBooking.destinationCoords) {
                new google.maps.Marker({
                    position: currentBooking.destinationCoords,
                    map: trackingMap,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#E30613',
                        fillOpacity: 0.7,
                        strokeColor: 'white',
                        strokeWeight: 2
                    }
                });
            }
        }

        function startReservationListener(reservationId) {
            console.log('üëÇ √âcoute r√©servation:', reservationId);

            reservationListener = db.collection('reservations').doc(reservationId)
                .onSnapshot(async (doc) => {
                    if (!doc.exists) return;

                    const data = doc.data();
                    console.log('üì¶ Mise √† jour:', data.statut);

                    currentBooking = { id: doc.id, ...data };

                    // ‚úÖ D√âTECTION AUTOMATIQUE DU CHANGEMENT DE MODE
                    if (data.statut === 'en_cours' && currentTrackingMode === 'approche') {
                        console.log('üîÑ BASCULEMENT VERS MODE COURSE');
                        currentTrackingMode = 'course';
                        updateTrackingModeDisplay();
                        calculateCourseRoute(); // ‚úÖ Calculer le trajet de la course
                    }

                    updateStatusTimeline(data.statut);

                    if (data.chauffeurAssigne && !driverListener) {
                        updateStep2(data);
                        startDriverTracking(data.chauffeurAssigne);
                    }

                    if (data.nomChauffeur) {
                        await showDriverCard(data);
                    }
                });
        }

        // ‚úÖ NOUVELLE FONCTION : Mise √† jour de l'affichage selon le mode
        function updateTrackingModeDisplay() {
            const badge = document.getElementById('routeModeBadge');
            const text = document.getElementById('routeModeText');
            
            if (currentTrackingMode === 'approche') {
                badge.classList.remove('course-mode');
                badge.style.display = 'flex';
                text.innerHTML = '<i class="fas fa-car-side"></i> Chauffeur en approche';
            } else if (currentTrackingMode === 'course') {
                badge.classList.add('course-mode');
                badge.style.display = 'flex';
                text.innerHTML = '<i class="fas fa-route"></i> Course en cours - Direction destination';
            }
        }

        // ‚úÖ NOUVELLE FONCTION : Calculer le trajet de la course (d√©part ‚Üí destination)
        function calculateCourseRoute() {
            if (!currentBooking.departCoords || !currentBooking.destinationCoords || !directionsService) {
                console.error('‚ùå Impossible de calculer le trajet de la course');
                return;
            }

            console.log('üó∫Ô∏è Calcul du trajet de course:', currentBooking.departCoords, '‚Üí', currentBooking.destinationCoords);

            directionsService.route({
                origin: currentBooking.departCoords,
                destination: currentBooking.destinationCoords,
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                if (status === 'OK') {
                    console.log('‚úÖ Trajet de course calcul√©');
                    
                    // ‚úÖ AFFICHER LE TRAJET DE LA COURSE
                    trackingDirectionsRenderer.setDirections(result);
                    trackingDirectionsRenderer.setOptions({
                        polylineOptions: { 
                            strokeColor: '#00A854', // Vert pour la course
                            strokeWeight: 5, 
                            strokeOpacity: 0.8 
                        }
                    });

                    const leg = result.routes[0].legs[0];
                    
                    // ‚úÖ Mettre √† jour l'affichage avec les infos de la course
                    document.getElementById('driverApproachingBox').innerHTML = `
                        <div class="driver-approaching-title">üöó Course en cours</div>
                        <div class="driver-eta" style="font-size: 1.5em;">${leg.distance.text}</div>
                        <div class="driver-eta-label">Distance restante</div>
                        <div class="driver-details-row">
                            <div class="driver-detail">
                                <div class="driver-detail-value">${leg.duration.text}</div>
                                <div class="driver-detail-label">Temps estim√©</div>
                            </div>
                            <div class="driver-detail">
                                <div class="driver-detail-value">${new Date(Date.now() + leg.duration.value * 1000).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div>
                                <div class="driver-detail-label">Arriv√©e pr√©vue</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('driverApproachingBox').style.background = 'linear-gradient(135deg, #00A854, #FECB00)';

                    // ‚úÖ Ajuster la vue de la carte pour inclure tout le trajet
                    if (trackingMap) {
                        const bounds = new google.maps.LatLngBounds();
                        bounds.extend(currentBooking.departCoords);
                        bounds.extend(currentBooking.destinationCoords);
                        trackingMap.fitBounds(bounds, { padding: 50 });
                    }
                } else {
                    console.error('‚ùå Erreur calcul trajet course:', status);
                }
            });
        }

        function updateStep2(data) {
            document.getElementById('step2Icon').classList.add('active');
            document.getElementById('step2Text').textContent = `${data.nomChauffeur || 'Chauffeur'} assign√©`;
            document.getElementById('step2Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function startDriverTracking(driverId) {
            console.log('üöó Suivi chauffeur:', driverId);
            
            if (driverListener) {
                driverListener();
                driverListener = null;
            }

            driverListener = db.collection('drivers').doc(driverId)
                .onSnapshot((doc) => {
                    if (!doc.exists) return;

                    const driverData = doc.data();
                    
                    if (driverData.position && driverData.position.latitude && driverData.position.longitude) {
                        const driverPos = {
                            lat: driverData.position.latitude,
                            lng: driverData.position.longitude
                        };
                        
                        lastDriverPosition = driverPos;
                        updateDriverMarker(driverPos);
                        
                        // ‚úÖ CALCULER LA ROUTE SELON LE MODE
                        if (currentTrackingMode === 'approche') {
                            calculateApproachRoute(driverPos);
                        }
                        // Si on est en mode 'course', on garde le trajet d√©part ‚Üí destination
                        
                        updateStep3();
                    }
                });

            setTimeout(() => {
                if (!lastDriverPosition && currentBooking) {
                    startSimulationMode();
                }
            }, 5000);
        }
        
        function startSimulationMode() {
            if (simulationMode) return;
            simulationMode = true;
            
            console.log('üß™ Mode simulation');
            showNotification('üìç Mode d√©mo', 'info');
            
            if (currentBooking && currentBooking.departCoords) {
                simulatedDriverPosition = {
                    lat: currentBooking.departCoords.lat + 0.015,
                    lng: currentBooking.departCoords.lng + 0.015
                };
                
                updateDriverMarker(simulatedDriverPosition);
                calculateApproachRoute(simulatedDriverPosition);
                updateStep3();
                
                trackingUpdateInterval = setInterval(() => {
                    if (!currentBooking || !simulatedDriverPosition) {
                        clearInterval(trackingUpdateInterval);
                        return;
                    }
                    
                    // ‚úÖ EN MODE APPROCHE : avancer vers le point de prise en charge
                    if (currentTrackingMode === 'approche') {
                        const target = currentBooking.departCoords;
                        const speed = 0.002;
                        
                        const dLat = target.lat - simulatedDriverPosition.lat;
                        const dLng = target.lng - simulatedDriverPosition.lng;
                        const distance = Math.sqrt(dLat * dLat + dLng * dLng);
                        
                        if (distance < 0.001) {
                            clearInterval(trackingUpdateInterval);
                            updateStatusTimeline('arrive');
                            return;
                        }
                        
                        simulatedDriverPosition = {
                            lat: simulatedDriverPosition.lat + (dLat / distance) * speed,
                            lng: simulatedDriverPosition.lng + (dLng / distance) * speed
                        };
                        
                        updateDriverMarker(simulatedDriverPosition);
                        calculateApproachRoute(simulatedDriverPosition);
                    }
                    // ‚úÖ EN MODE COURSE : ne plus mettre √† jour (le trajet est fixe)
                    
                }, 3000);
            }
        }

        function updateDriverMarker(position) {
            if (!trackingMap) return;

            if (driverMarker) {
                driverMarker.setPosition(position);
            } else {
                driverMarker = new google.maps.Marker({
                    position: position,
                    map: trackingMap,
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 8,
                        fillColor: '#2196F3',
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 2
                    },
                    zIndex: 100
                });
            }

            // ‚úÖ AJUSTER LA VUE SELON LE MODE
            if (currentTrackingMode === 'approche') {
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(position);
                if (currentBooking.departCoords) {
                    bounds.extend(currentBooking.departCoords);
                }
                trackingMap.fitBounds(bounds, { padding: 50 });
            }
            // En mode 'course', la vue est d√©j√† ajust√©e par calculateCourseRoute()
        }

        function calculateApproachRoute(driverPos) {
            if (!currentBooking.departCoords || !directionsService) return;

            directionsService.route({
                origin: driverPos,
                destination: currentBooking.departCoords,
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                if (status === 'OK') {
                    trackingDirectionsRenderer.setDirections(result);
                    trackingDirectionsRenderer.setOptions({
                        polylineOptions: { 
                            strokeColor: '#2196F3', // Bleu pour l'approche
                            strokeWeight: 5, 
                            strokeOpacity: 0.8 
                        }
                    });

                    const leg = result.routes[0].legs[0];
                    
                    const durationMinutes = Math.ceil(leg.duration.value / 60);
                    document.getElementById('driverETA').textContent = durationMinutes;
                    document.getElementById('driverDistance').textContent = leg.distance.text;
                    
                    const arrivalTime = new Date(Date.now() + leg.duration.value * 1000);
                    document.getElementById('driverArrivalTime').textContent = 
                        arrivalTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                    document.getElementById('driverApproachingBox').style.display = 'block';
                }
            });
        }

        function updateStep3() {
            const step3Icon = document.getElementById('step3Icon');
            step3Icon.classList.remove('active');
            step3Icon.classList.add('current');
            document.getElementById('step3Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function updateStatusTimeline(statut) {
            const step4Icon = document.getElementById('step4Icon');
            const step5Icon = document.getElementById('step5Icon');

            switch(statut) {
                case 'arrive':
                    step4Icon.classList.add('active');
                    document.getElementById('step3Icon').classList.remove('current');
                    document.getElementById('step3Icon').classList.add('active');
                    document.getElementById('step4Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    document.getElementById('driverApproachingBox').innerHTML = `
                        <div class="driver-approaching-title">‚úÖ Chauffeur arriv√©!</div>
                        <div class="driver-eta" style="font-size: 1.5em;">Rejoignez votre chauffeur</div>
                    `;
                    document.getElementById('driverApproachingBox').style.background = 'linear-gradient(135deg, #4CAF50, #8BC34A)';
                    break;

                case 'en_cours':
                    step4Icon.classList.add('active');
                    step5Icon.classList.add('current');
                    document.getElementById('step5Time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    // ‚úÖ Le basculement vers le trajet de course est g√©r√© dans startReservationListener()
                    break;

                case 'terminee':
                    step5Icon.classList.remove('current');
                    step5Icon.classList.add('active');
                    
                    document.getElementById('driverApproachingBox').innerHTML = `
                        <div class="driver-approaching-title">üéâ Course termin√©e!</div>
                        <div class="driver-eta" style="font-size: 1.2em;">Merci d'avoir choisi Al Bourakh</div>
                    `;
                    document.getElementById('driverApproachingBox').style.background = 'linear-gradient(135deg, #9C27B0, #E91E63)';
                    
                    if (trackingUpdateInterval) {
                        clearInterval(trackingUpdateInterval);
                        trackingUpdateInterval = null;
                    }
                    
                    setTimeout(() => {
                        openEvaluationModal();
                    }, 2000);
                    break;

                case 'annulee':
                    closeTracking();
                    showNotification('‚ùå R√©servation annul√©e', 'error');
                    break;
            }
        }

        async function showDriverCard(data) {
            const driverCard = document.getElementById('driverCard');
            driverCard.style.display = 'block';

            const driverName = data.nomChauffeur || 'Chauffeur';
            
            const nameParts = driverName.split(' ');
            const driverPrenom = nameParts[0] || '';
            const driverNom = nameParts.slice(1).join(' ') || '';
            
            document.getElementById('driverName').textContent = driverName;
            
            console.log('üöó Affichage carte chauffeur:', driverName, 'ID:', data.chauffeurAssigne);
            
            let photoUrl = null;
            if (data.chauffeurAssigne) {
                showLoading('Chargement photo...');
                photoUrl = await fetchDriverPhoto(
                    data.chauffeurAssigne,
                    data.telephoneChauffeur,
                    driverNom,
                    driverPrenom
                );
                hideLoading();
            }
            
            const driverAvatar = document.querySelector('.driver-avatar');
            const evalDriverAvatar = document.querySelector('.evaluation-driver-avatar');
            
            if (photoUrl) {
                console.log('‚úÖ Affichage photo:', photoUrl);
                driverAvatar.innerHTML = `<img src="${photoUrl}" alt="${driverName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.parentElement.innerHTML='üë§'">`;
                if (evalDriverAvatar) {
                    evalDriverAvatar.innerHTML = `<img src="${photoUrl}" alt="${driverName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.parentElement.innerHTML='üë§'">`;
                }
            } else {
                console.log('‚ö†Ô∏è Pas de photo, affichage emoji par d√©faut');
                driverAvatar.innerHTML = 'üë§';
                if (evalDriverAvatar) {
                    evalDriverAvatar.innerHTML = 'üë§';
                }
            }
            
            let marque = 'V√©hicule';
            let modele = '';
            let immatriculation = 'XX-0000-XX';
            let rating = 4.9;
            
            if (data.chauffeurAssigne) {
                try {
                    console.log('üì° R√©cup√©ration depuis drivers...');
                    const driverDoc = await db.collection('drivers').doc(data.chauffeurAssigne).get();
                    
                    if (driverDoc.exists) {
                        const driverData = driverDoc.data();
                        console.log('üì¶ Donn√©es driver re√ßues:', driverData);
                        
                        rating = driverData.noteGlobale || driverData.rating || 4.9;
                        
                        marque = driverData.marque ||
                                driverData.vehiculeMarque || 
                                driverData.marqueVehicule || 
                                driverData.vehicule?.marque ||
                                driverData.vehicleBrand ||
                                data.vehiculeType || 
                                'V√©hicule';
                        
                        modele = driverData.modele ||
                                driverData.vehiculeModele || 
                                driverData.modeleVehicule || 
                                driverData.vehicule?.modele ||
                                '';
                        
                        immatriculation = driverData.immatriculation || 
                                         driverData.numeroImmatriculation || 
                                         driverData.vehicule?.immatriculation ||
                                         driverData.plaque ||
                                         'XX-0000-XX';
                        
                        console.log('‚úÖ Infos v√©hicule depuis drivers:', {marque, modele, immatriculation, rating});
                    } else {
                        console.warn('‚ö†Ô∏è Document driver introuvable, essai avec candidatures...');
                        
                        const candidatureDoc = await db.collection('candidatures').doc(data.chauffeurAssigne).get();
                        if (candidatureDoc.exists) {
                            const candidatureData = candidatureDoc.data();
                            console.log('üì¶ Donn√©es candidature re√ßues (fallback):', candidatureData);
                            
                            rating = candidatureData.noteGlobale || candidatureData.rating || 4.9;
                            marque = candidatureData.vehiculeMarque || candidatureData.marqueVehicule || candidatureData.marque || marque;
                            modele = candidatureData.vehiculeModele || candidatureData.modeleVehicule || candidatureData.modele || modele;
                            immatriculation = candidatureData.immatriculation || candidatureData.numeroImmatriculation || candidatureData.plaque || immatriculation;
                            
                            console.log('‚úÖ Infos v√©hicule depuis candidatures (fallback):', {marque, modele, immatriculation, rating});
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur r√©cup√©ration infos:', error);
                }
            }
            
            document.getElementById('driverRating').textContent = rating;
            
            const vehicleModelText = modele ? `${marque} ${modele}` : marque;
            document.getElementById('vehicleModel').textContent = vehicleModelText;
            document.getElementById('vehiclePlate').textContent = immatriculation;
            
            console.log('üé® Affichage:', vehicleModelText, immatriculation);
            
            if (currentBooking) {
                currentBooking.vehiculeMarque = marque;
                currentBooking.vehiculeModele = modele;
                currentBooking.immatriculation = immatriculation;
                currentBooking.noteGlobaleChauffeur = rating;
                currentBooking.photoChauffeur = photoUrl;
                console.log('üíæ Donn√©es sauvegard√©es (avec photo)');
            }
            
            driverCard.dataset.phone = data.telephoneChauffeur || '';
        }

        function callDriver() {
            const phone = document.getElementById('driverCard').dataset.phone;
            if (phone) {
                window.location.href = `tel:${phone}`;
            } else {
                showNotification('Num√©ro non disponible', 'error');
            }
        }

        function messageDriver() {
            const phone = document.getElementById('driverCard').dataset.phone;
            if (phone) {
                window.location.href = `sms:${phone}`;
            } else {
                showNotification('Num√©ro non disponible', 'error');
            }
        }

        async function cancelBooking() {
            if (!confirm('Annuler cette r√©servation?')) return;

            if (currentBooking && currentBooking.id) {
                try {
                    await db.collection('reservations').doc(currentBooking.id).update({
                        statut: 'annulee',
                        dateAnnulation: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            closeTracking();
            currentBooking = null;
            showNotification('R√©servation annul√©e', 'info');
        }

        function initEvaluationListeners() {
            const overallStars = document.querySelectorAll('#overallRating .star');
            overallStars.forEach(star => {
                star.addEventListener('click', () => {
                    const rating = parseInt(star.dataset.rating);
                    evaluationData.noteGlobale = rating;
                    updateOverallStars(rating);
                    updateSubmitButton();
                });
            });

            const criteriaStars = document.querySelectorAll('.criteria-star');
            criteriaStars.forEach(star => {
                star.addEventListener('click', () => {
                    const criteria = star.dataset.criteria;
                    const rating = parseInt(star.dataset.rating);
                    evaluationData[criteria] = rating;
                    updateCriteriaStars(criteria, rating);
                    updateSubmitButton();
                });
            });

            const commentTextarea = document.getElementById('evaluationComment');
            commentTextarea.addEventListener('input', () => {
                const length = commentTextarea.value.length;
                document.getElementById('commentLength').textContent = length;
                evaluationData.commentaire = commentTextarea.value;
            });

            const submitBtn = document.getElementById('submitEvaluationBtn');
            submitBtn.addEventListener('click', submitEvaluation);

            const skipBtn = document.getElementById('skipEvaluationBtn');
            skipBtn.addEventListener('click', skipEvaluation);

            console.log('‚úÖ Event listeners d\'√©valuation initialis√©s');
        }

        function updateOverallStars(rating) {
            const stars = document.querySelectorAll('#overallRating .star');
            const labels = ['Tr√®s mauvais', 'Mauvais', 'Moyen', 'Bon', 'Excellent'];
            
            stars.forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                if (starRating <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });

            document.getElementById('overallRatingLabel').textContent = labels[rating - 1];
        }

        function updateCriteriaStars(criteria, rating) {
            const stars = document.querySelectorAll(`#${criteria}Rating .criteria-star`);
            
            stars.forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                if (starRating <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });

            document.getElementById(`${criteria}Value`).textContent = `${rating}/5`;
        }

        function updateSubmitButton() {
            const btn = document.getElementById('submitEvaluationBtn');
            
            if (evaluationData.noteGlobale > 0) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function openEvaluationModal() {
            if (!currentBooking) {
                console.error('‚ùå Pas de currentBooking disponible');
                return;
            }

            console.log('üåü Ouverture modal √©valuation', currentBooking);

            document.getElementById('evalDriverName').textContent = 
                currentBooking.nomChauffeur || 'Votre chauffeur';
            
            let vehiculeText = '';
            
            const marque = currentBooking.vehiculeMarque;
            const modele = currentBooking.vehiculeModele;
            const immat = currentBooking.immatriculation;
            
            if (marque && marque !== 'V√©hicule' && marque !== 'XX-0000-XX') {
                vehiculeText = modele ? `${marque} ${modele}` : marque;
                if (immat && immat !== 'XX-0000-XX') {
                    vehiculeText += ` ‚Ä¢ ${immat}`;
                }
            } else {
                const typeVehicule = currentBooking.vehiculeType || 'standard';
                const typeNames = {
                    standard: 'üöó V√©hicule Standard',
                    confort: '‚ú® V√©hicule Confort',
                    van: 'üöê Van',
                    premium: 'üëë V√©hicule Premium'
                };
                vehiculeText = typeNames[typeVehicule] || 'V√©hicule';
            }
            
            document.getElementById('evalVehicle').textContent = vehiculeText;
            console.log('üöó V√©hicule affich√©:', vehiculeText);

            const evalDriverAvatar = document.querySelector('.evaluation-driver-avatar');
            if (currentBooking.photoChauffeur) {
                evalDriverAvatar.innerHTML = `<img src="${currentBooking.photoChauffeur}" alt="${currentBooking.nomChauffeur}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.parentElement.innerHTML='üë§'">`;
            } else {
                evalDriverAvatar.innerHTML = 'üë§';
            }

            evaluationData = {
                noteGlobale: 0,
                conduite: 0,
                ponctualite: 0,
                proprete: 0,
                amabilite: 0,
                commentaire: ''
            };

            document.querySelectorAll('.star, .criteria-star').forEach(s => s.classList.remove('active'));
            document.getElementById('overallRatingLabel').textContent = 'S√©lectionnez une note';
            document.querySelectorAll('.criteria-value').forEach(v => v.textContent = '-');
            document.getElementById('evaluationComment').value = '';
            document.getElementById('commentLength').textContent = '0';
            document.getElementById('submitEvaluationBtn').disabled = true;

            document.getElementById('evaluationModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            console.log('‚úÖ Modal √©valuation ouvert');
        }

        function closeEvaluationModal() {
            document.getElementById('evaluationModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function skipEvaluation() {
            closeEvaluationModal();
            closeTracking();
            showNotification('√âvaluation ignor√©e', 'info');
            currentBooking = null;
        }

        async function submitEvaluation() {
            console.log('üöÄ submitEvaluation appel√©e', evaluationData);
            
            if (evaluationData.noteGlobale === 0) {
                showNotification('‚ö†Ô∏è Veuillez noter la course', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitEvaluationBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner"></i> Envoi...';
            
            console.log('üì§ Envoi de l\'√©valuation...');

            try {
                const evaluationDoc = {
                    reservationId: currentBooking.id,
                    chauffeurId: currentBooking.chauffeurAssigne,
                    nomChauffeur: currentBooking.nomChauffeur || 'Chauffeur',
                    clientNom: currentBooking.clientNom || 'Client',
                    clientTelephone: currentBooking.clientTelephone,
                    noteGlobale: evaluationData.noteGlobale,
                    conduite: evaluationData.conduite || 0,
                    ponctualite: evaluationData.ponctualite || 0,
                    proprete: evaluationData.proprete || 0,
                    amabilite: evaluationData.amabilite || 0,
                    commentaire: evaluationData.commentaire.trim(),
                    vehiculeMarque: currentBooking.vehiculeMarque || '',
                    vehiculeModele: currentBooking.vehiculeModele || '',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    dateEvaluation: new Date().toISOString()
                };

                console.log('üìù Donn√©es √† sauvegarder:', evaluationDoc);

                const evalRef = await db.collection('evaluations').add(evaluationDoc);
                console.log('‚úÖ √âvaluation sauvegard√©e avec ID:', evalRef.id);

                await db.collection('reservations').doc(currentBooking.id).update({
                    evaluationSoumise: true,
                    noteClient: evaluationData.noteGlobale,
                    dateEvaluation: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ R√©servation mise √† jour');

                if (currentBooking.chauffeurAssigne) {
                    try {
                        const evaluationsSnap = await db.collection('evaluations')
                            .where('chauffeurId', '==', currentBooking.chauffeurAssigne)
                            .get();
                        
                        let totalNotes = 0;
                        let count = 0;
                        evaluationsSnap.forEach(doc => {
                            totalNotes += doc.data().noteGlobale;
                            count++;
                        });
                        
                        const moyenneNote = count > 0 ? parseFloat((totalNotes / count).toFixed(1)) : 0;
                        
                        await db.collection('candidatures').doc(currentBooking.chauffeurAssigne).update({
                            noteGlobale: moyenneNote,
                            nombreEvaluations: count
                        });
                        console.log('‚úÖ Note chauffeur mise √† jour:', moyenneNote, '(', count, '√©valuations)');
                    } catch (error) {
                        console.error('‚ö†Ô∏è Erreur mise √† jour note:', error);
                    }
                }

                submitBtn.innerHTML = '<i class="fas fa-check"></i> Envoy√© !';
                showNotification('‚úÖ Merci pour votre √©valuation!', 'success');
                
                console.log('üéâ √âvaluation termin√©e avec succ√®s');
                
                setTimeout(() => {
                    closeEvaluationModal();
                    closeTracking();
                    currentBooking = null;
                }, 1500);

            } catch (error) {
                console.error('‚ùå Erreur lors de l\'√©valuation:', error);
                
                if (error.code === 'permission-denied') {
                    showNotification('‚ùå Erreur de permissions Firebase - Contactez l\'admin', 'error');
                    console.error('üîí ERREUR PERMISSIONS: Ajoutez ces r√®gles Firestore:');
                } else {
                    showNotification('‚ùå Erreur: ' + error.message, 'error');
                }
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        function scrollToBooking() {
            document.querySelector('.booking-section').scrollIntoView({ behavior: 'smooth' });
        }

        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function showLoading(text = 'Chargement...') {
            const overlay = document.getElementById('loadingOverlay');
            overlay.querySelector('.loading-text').textContent = text;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function toggleChatbot() {
            document.getElementById('chatbotWindow').classList.toggle('active');
        }

        function sendChatMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            setTimeout(() => {
                const response = getBotResponse(message);
                addChatMessage(response, 'bot');
            }, 500);
        }

        function addChatMessage(text, sender) {
            const container = document.getElementById('chatbotMessages');
            const div = document.createElement('div');
            div.className = `chatbot-message message-${sender}`;
            div.innerHTML = `
                <div class="message-avatar avatar-${sender}">${sender === 'bot' ? 'üöï' : 'üë§'}</div>
                <div class="message-content content-${sender}">${text}</div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function getBotResponse(message) {
            const msg = message.toLowerCase();
            if (msg.includes('prix') || msg.includes('tarif')) {
                return 'Nos tarifs: Standard 1500F+, Confort 2000F+, Van 2500F+, Premium 3500F+';
            }
            if (msg.includes('contact')) {
                return 'üìû +221 77 123 45 67 (24h/24)';
            }
            if (msg.includes('suivi')) {
                return 'Apr√®s confirmation, suivez votre chauffeur en temps r√©el!';
            }
            return 'Assistant Al Bourakh √† votre service!';
        }

        window.initMap = initMap;
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBI1svukv3Ts7fN97ke5OGfwo2V-vRUGHI&callback=initMap&libraries=places"></script> 
</body> 
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Bourakh - Administration Chauffeurs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #00A854, #FECB00);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        .header h1 { font-size: 2.2em; display: flex; align-items: center; gap: 15px; }
        .header p { margin-top: 10px; opacity: 0.9; }
        .logout-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #00A854, #FECB00);
            color: white;
        }
        .tab-btn:hover { transform: translateY(-2px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        .stat-icon.green { background: #d4edda; color: #00A854; }
        .stat-icon.blue { background: #cce5ff; color: #004085; }
        .stat-icon.orange { background: #fff3cd; color: #856404; }
        .stat-icon.red { background: #f8d7da; color: #721c24; }
        .stat-icon.purple { background: #e2d9f3; color: #6f42c1; }
        .stat-info h3 { font-size: 1.8em; color: #333; margin-bottom: 3px; }
        .stat-info p { color: #666; font-size: 0.9em; }
        .main-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-box {
            flex: 1;
            max-width: 350px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
        }
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00A854, #FECB00);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,168,84,0.3); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #E30613; color: white; }
        .btn-danger:hover { background: #c50510; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f8f9fa; }
        th { padding: 12px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #dee2e6; font-size: 0.9em; }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; }
        tbody tr { transition: all 0.3s; }
        tbody tr:hover { background: #f8f9fa; }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
        }
        .status-disponible { background: #d4edda; color: #155724; }
        .status-en_course, .status-en-course { background: #cce5ff; color: #004085; }
        .status-hors_ligne, .status-hors-ligne { background: #f8d7da; color: #721c24; }
        .status-en_attente { background: #fff3cd; color: #856404; }
        .status-acceptee { background: #d4edda; color: #155724; }
        .status-refusee { background: #f8d7da; color: #721c24; }
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.85em;
        }
        .btn-view { background: #17a2b8; color: white; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-delete { background: #E30613; color: white; }
        .btn-accept { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideInRight 0.3s;
            max-width: 350px;
        }
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast.success { border-left: 4px solid #00A854; }
        .toast.error { border-left: 4px solid #E30613; }
        .toast.info { border-left: 4px solid #2196F3; }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .loading.active { display: flex; }
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top-color: #FECB00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 1.2em; margin-top: 20px; }
        .login-container {
            max-width: 450px;
            margin: 80px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #00A854, #FECB00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
        }
        .login-title { color: #00A854; font-size: 1.8em; margin-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #00A854; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            max-width: 900px;
            width: 100%;
            border-radius: 15px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            background: linear-gradient(135deg, #00A854, #FECB00);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 1.4em; }
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
        }
        .modal-body { padding: 25px; }
        .docs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .doc-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .doc-card:hover { border-color: #00A854; transform: translateY(-3px); }
        .doc-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
        }
        .doc-card .doc-label {
            padding: 10px;
            background: #f8f9fa;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
        }
        .doc-card a {
            display: block;
            padding: 10px;
            background: #00A854;
            color: white;
            text-align: center;
            text-decoration: none;
            font-size: 0.85em;
        }
        .doc-card a:hover { background: #008844; }
        .info-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .info-section h4 {
            color: #00A854;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .info-item { padding: 8px 0; }
        .info-item label { color: #666; font-size: 0.85em; display: block; }
        .info-item span { font-weight: 600; color: #333; }
        .image-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        .image-viewer.active { display: flex; }
        .image-viewer img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .image-viewer .close-viewer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
        }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.5em; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .action-bar { flex-direction: column; align-items: stretch; }
            .search-box { max-width: 100%; }
            .tabs { justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">üîê</div>
                <h1 class="login-title">Administration</h1>
                <p style="color: #666;">Al Bourakh - Gestion des Chauffeurs</p>
            </div>
            <div class="form-group">
                <label>üìß Email Administrateur</label>
                <input type="email" id="adminEmail" placeholder="admin@albourakh.sn">
            </div>
            <div class="form-group">
                <label>üîí Mot de passe</label>
                <input type="password" id="adminPassword" placeholder="Votre mot de passe">
            </div>
            <button class="btn btn-primary" onclick="loginAdmin()" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Se connecter
            </button>
            <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">
                Version 2.0 - Al Bourakh ¬© 2025
            </p>
        </div>
    </div>

    <div id="adminDashboard" style="display: none;">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-shield-alt"></i> Administration - Chauffeurs</h1>
                <p>G√©rez les chauffeurs et les candidatures Al Bourakh</p>
                <button class="logout-btn" onclick="logoutAdmin()">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('candidatures')">
                    <i class="fas fa-file-alt"></i> Candidatures
                </button>
                <button class="tab-btn" onclick="switchTab('chauffeurs')">
                    <i class="fas fa-users"></i> Chauffeurs Actifs
                </button>
            </div>

            <!-- TAB CANDIDATURES -->
            <div id="tab-candidatures" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon purple"><i class="fas fa-inbox"></i></div>
                        <div class="stat-info">
                            <h3 id="totalCandidatures">0</h3>
                            <p>Total Candidatures</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
                        <div class="stat-info">
                            <h3 id="pendingCandidatures">0</h3>
                            <p>En Attente</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-check"></i></div>
                        <div class="stat-info">
                            <h3 id="acceptedCandidatures">0</h3>
                            <p>Accept√©es</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red"><i class="fas fa-times"></i></div>
                        <div class="stat-info">
                            <h3 id="rejectedCandidatures">0</h3>
                            <p>Refus√©es</p>
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="action-bar">
                        <div class="search-box">
                            <input type="text" id="searchCandidatures" placeholder="Rechercher une candidature..." onkeyup="searchCandidatures()">
                            <i class="fas fa-search"></i>
                        </div>
                        <button class="btn btn-secondary" onclick="loadCandidatures()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Candidat</th>
                                    <th>T√©l√©phone</th>
                                    <th>V√©hicule</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="candidaturesTableBody">
                                <tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB CHAUFFEURS -->
            <div id="tab-chauffeurs" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <h3 id="totalDrivers">0</h3>
                            <p>Total Chauffeurs</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-info">
                            <h3 id="availableDrivers">0</h3>
                            <p>Disponibles</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fas fa-car"></i></div>
                        <div class="stat-info">
                            <h3 id="busyDrivers">0</h3>
                            <p>En Course</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red"><i class="fas fa-power-off"></i></div>
                        <div class="stat-info">
                            <h3 id="offlineDrivers">0</h3>
                            <p>Hors Ligne</p>
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="action-bar">
                        <div class="search-box">
                            <input type="text" id="searchDrivers" placeholder="Rechercher un chauffeur..." onkeyup="searchDrivers()">
                            <i class="fas fa-search"></i>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-primary" onclick="newDriver()">
                                <i class="fas fa-plus"></i> Nouveau
                            </button>
                            <button class="btn btn-secondary" onclick="loadDrivers()">
                                <i class="fas fa-sync-alt"></i> Actualiser
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Chauffeur</th>
                                    <th>T√©l√©phone</th>
                                    <th>V√©hicule</th>
                                    <th>Note</th>
                                    <th>Courses</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="driversTableBody">
                                <tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL D√âTAILS -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">D√©tails</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- VISIONNEUSE D'IMAGE -->
    <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()">
        <button class="close-viewer" onclick="closeImageViewer()">√ó</button>
        <img id="viewerImage" src="" alt="Document">
    </div>

    <!-- LOADING -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Chargement...</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
            authDomain: "albourakh-sn-ok.firebaseapp.com",
            projectId: "albourakh-sn-ok",
            storageBucket: "albourakh-sn-ok.firebasestorage.app",
            messagingSenderId: "297875396274",
            appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let allCandidatures = [];
        let allDrivers = [];

        // Collection unique pour les candidatures
        const CANDIDATURES_COLLECTION = 'candidatures';

        // === UTILITAIRES ===
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoading(text = 'Chargement...') {
            document.getElementById('loading').querySelector('.loading-text').textContent = text;
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            if (tab === 'candidatures') loadCandidatures();
            else loadDrivers();
        }

        // === AUTHENTIFICATION ===
        async function loginAdmin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            if (!email || !password) { showToast('Remplissez tous les champs', 'error'); return; }
            showLoading('Connexion...');
            try {
                await auth.signInWithEmailAndPassword(email, password);
                hideLoading();
                showToast('‚úÖ Connexion r√©ussie!', 'success');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadCandidatures();
            } catch (error) {
                hideLoading();
                showToast('Email ou mot de passe incorrect', 'error');
            }
        }

        async function logoutAdmin() {
            if (confirm('Voulez-vous vous d√©connecter ?')) {
                await auth.signOut();
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('adminDashboard').style.display = 'none';
                showToast('D√©connexion r√©ussie', 'info');
            }
        }

        document.getElementById('adminPassword').addEventListener('keypress', e => {
            if (e.key === 'Enter') loginAdmin();
        });

        // === CANDIDATURES ===
        async function loadCandidatures() {
            console.log('========== CHARGEMENT CANDIDATURES ==========');
            console.log('üîê Auth currentUser:', auth.currentUser);
            console.log('üîê Auth email:', auth.currentUser?.email);
            
            if (!auth.currentUser) {
                console.log('‚ùå Pas connect√© - arr√™t');
                showToast('Veuillez vous reconnecter', 'error');
                return;
            }
            
            showLoading('Chargement des candidatures...');
            console.log('üîÑ D√©but du chargement...');
            
            try {
                allCandidatures = [];
                
                console.log(`üìÇ Tentative de lecture: ${CANDIDATURES_COLLECTION}`);
                
                // Test simple de connexion
                const testRef = db.collection(CANDIDATURES_COLLECTION);
                console.log('üìÇ R√©f√©rence collection cr√©√©e:', testRef.path);
                
                // R√©cup√©rer tous les documents
                console.log('üìÇ Ex√©cution de get()...');
                const snapshot = await testRef.get();
                
                console.log('üìä R√©sultat snapshot:');
                console.log('   - size:', snapshot.size);
                console.log('   - empty:', snapshot.empty);
                console.log('   - docs count:', snapshot.docs.length);
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        console.log(`üìÑ Document: ${doc.id}`, data.prenom, data.nom);
                        allCandidatures.push({ 
                            id: doc.id, 
                            prenom: data.prenom || '',
                            nom: data.nom || '',
                            telephone: data.telephone || '',
                            email: data.email || '',
                            adresse: data.adresse || '',
                            vehicule: data.vehicule || {},
                            documents: data.documents || {},
                            photos: data.photos || {},
                            statut: data.statut || 'en_attente',
                            dateCreation: data.dateCreation || data.dateCandidate || null,
                            ...data
                        });
                    });
                } else {
                    console.log('‚ö†Ô∏è La collection est vide ou inaccessible');
                }
                
                console.log(`‚úÖ Total charg√©: ${allCandidatures.length}`);
                
                // Trier par date
                allCandidatures.sort((a, b) => {
                    const dateA = a.dateCreation?.toDate ? a.dateCreation.toDate() : new Date(0);
                    const dateB = b.dateCreation?.toDate ? b.dateCreation.toDate() : new Date(0);
                    return dateB - dateA;
                });
                
                updateCandidaturesStats();
                displayCandidatures(allCandidatures);
                hideLoading();
                
                if (allCandidatures.length === 0) {
                    showToast('Aucune candidature trouv√©e', 'info');
                } else {
                    showToast(`‚úÖ ${allCandidatures.length} candidature(s) charg√©e(s)`, 'success');
                }
                
                console.log('========== FIN CHARGEMENT ==========');
                
            } catch (error) {
                console.error('‚ùå ERREUR CRITIQUE:', error);
                console.error('‚ùå Code:', error.code);
                console.error('‚ùå Message:', error.message);
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        function updateCandidaturesStats() {
            const total = allCandidatures.length;
            const pending = allCandidatures.filter(c => 
                c.statut === 'en_attente' || c.statut === 'nouvelle' || !c.statut
            ).length;
            const accepted = allCandidatures.filter(c => 
                c.statut === 'acceptee' || c.statut === 'accepte' || c.statut === 'validee'
            ).length;
            const rejected = allCandidatures.filter(c => 
                c.statut === 'refusee' || c.statut === 'refuse' || c.statut === 'rejetee'
            ).length;
            document.getElementById('totalCandidatures').textContent = total;
            document.getElementById('pendingCandidatures').textContent = pending;
            document.getElementById('acceptedCandidatures').textContent = accepted;
            document.getElementById('rejectedCandidatures').textContent = rejected;
        }

        function displayCandidatures(candidatures) {
            const tbody = document.getElementById('candidaturesTableBody');
            if (candidatures.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">
                    <i class="fas fa-inbox" style="font-size:3em;opacity:0.3;display:block;margin-bottom:15px;"></i>
                    Aucune candidature trouv√©e<br>
                    <small style="color:#aaa;">V√©rifiez que des candidatures ont √©t√© soumises via le formulaire</small>
                </td></tr>`;
                return;
            }
            tbody.innerHTML = candidatures.map(c => {
                // Normaliser le statut pour l'affichage
                let statut = c.statut || 'en_attente';
                if (statut === 'nouvelle') statut = 'en_attente';
                if (statut === 'accepte' || statut === 'validee') statut = 'acceptee';
                if (statut === 'refuse' || statut === 'rejetee') statut = 'refusee';
                
                const date = c.dateCreation?.toDate ? c.dateCreation.toDate().toLocaleDateString('fr-FR') : 'N/A';
                const isPending = statut === 'en_attente';
                
                return `
                <tr>
                    <td>
                        <strong>${c.prenom || ''} ${c.nom || ''}</strong>
                        <br><small style="color:#666;">${c.email || ''}</small>
                    </td>
                    <td>${c.telephone || 'N/A'}</td>
                    <td>
                        ${c.vehicule?.marque || ''} ${c.vehicule?.modele || ''}
                        <br><small style="color:#666;">${c.vehicule?.immatriculation || ''}</small>
                    </td>
                    <td>${date}</td>
                    <td><span class="status-badge status-${statut}">${getStatusLabel(statut)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-icon btn-view" onclick="viewCandidature('${c.id}')" title="D√©tails"><i class="fas fa-eye"></i></button>
                            ${isPending ? `
                                <button class="btn btn-icon btn-accept" onclick="acceptCandidature('${c.id}')" title="Accepter"><i class="fas fa-check"></i></button>
                                <button class="btn btn-icon btn-reject" onclick="rejectCandidature('${c.id}')" title="Refuser"><i class="fas fa-times"></i></button>
                            ` : ''}
                            <button class="btn btn-icon btn-delete" onclick="deleteCandidature('${c.id}')" title="Supprimer"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function getStatusLabel(statut) {
            const labels = {
                'en_attente': '‚è≥ En Attente',
                'acceptee': '‚úÖ Accept√©e',
                'refusee': '‚ùå Refus√©e',
                'disponible': 'üü¢ Disponible',
                'en_course': 'üîµ En Course',
                'hors_ligne': '‚ö´ Hors Ligne'
            };
            return labels[statut] || statut;
        }

        function searchCandidatures() {
            const term = document.getElementById('searchCandidatures').value.toLowerCase();
            const filtered = allCandidatures.filter(c =>
                (c.prenom?.toLowerCase().includes(term)) ||
                (c.nom?.toLowerCase().includes(term)) ||
                (c.telephone?.includes(term)) ||
                (c.email?.toLowerCase().includes(term))
            );
            displayCandidatures(filtered);
        }

        // === VOIR D√âTAILS CANDIDATURE ===
        function viewCandidature(id) {
            const c = allCandidatures.find(x => x.id === id);
            if (!c) return showToast('Candidature non trouv√©e', 'error');
            
            console.log('========== D√âTAILS CANDIDATURE ==========');
            console.log('üìã ID:', c.id);
            console.log('üìã Objet complet:', c);
            console.log('üìÑ c.documents:', c.documents);
            console.log('üì∑ c.photos:', c.photos);
            
            // V√©rifier si documents/photos sont dans l'objet original
            if (c.documents) {
                console.log('üìÑ Cl√©s documents:', Object.keys(c.documents));
                Object.entries(c.documents).forEach(([k, v]) => {
                    console.log(`   - ${k}:`, typeof v, v ? v.substring(0, 50) + '...' : 'vide');
                });
            }
            if (c.photos) {
                console.log('üì∑ Cl√©s photos:', Object.keys(c.photos));
                Object.entries(c.photos).forEach(([k, v]) => {
                    console.log(`   - ${k}:`, typeof v, Array.isArray(v) ? `Array(${v.length})` : (v ? v.substring(0, 50) + '...' : 'vide'));
                });
            }
            console.log('==========================================');

            const html = `
                <div class="info-section">
                    <h4><i class="fas fa-user"></i> Informations Personnelles</h4>
                    <div class="info-grid">
                        <div class="info-item"><label>Nom complet</label><span>${c.prenom || ''} ${c.nom || ''}</span></div>
                        <div class="info-item"><label>T√©l√©phone</label><span>${c.telephone || 'N/A'}</span></div>
                        <div class="info-item"><label>Email</label><span>${c.email || 'N/A'}</span></div>
                        <div class="info-item"><label>Adresse</label><span>${c.adresse || 'N/A'}</span></div>
                        <div class="info-item"><label>Date de naissance</label><span>${c.dateNaissance || 'N/A'}</span></div>
                        <div class="info-item"><label>Statut</label><span class="status-badge status-${c.statut || 'en_attente'}">${getStatusLabel(c.statut || 'en_attente')}</span></div>
                    </div>
                </div>

                <div class="info-section">
                    <h4><i class="fas fa-car"></i> V√©hicule</h4>
                    <div class="info-grid">
                        <div class="info-item"><label>Marque</label><span>${c.vehicule?.marque || 'N/A'}</span></div>
                        <div class="info-item"><label>Mod√®le</label><span>${c.vehicule?.modele || 'N/A'}</span></div>
                        <div class="info-item"><label>Ann√©e</label><span>${c.vehicule?.annee || 'N/A'}</span></div>
                        <div class="info-item"><label>Couleur</label><span>${c.vehicule?.couleur || 'N/A'}</span></div>
                        <div class="info-item"><label>Immatriculation</label><span>${c.vehicule?.immatriculation || 'N/A'}</span></div>
                        <div class="info-item"><label>Places</label><span>${c.vehicule?.nombrePlaces || 'N/A'}</span></div>
                    </div>
                </div>

                <div class="info-section">
                    <h4><i class="fas fa-folder-open"></i> Documents Upload√©s</h4>
                    <div class="docs-grid">
                        ${renderDocuments(c.documents, c)}
                    </div>
                </div>

                <div class="info-section">
                    <h4><i class="fas fa-camera"></i> Photos</h4>
                    <div class="docs-grid">
                        ${renderPhotos(c.photos, c)}
                    </div>
                </div>

                ${c.statut === 'en_attente' || !c.statut ? `
                <div style="display:flex;gap:15px;margin-top:20px;">
                    <button class="btn btn-success" onclick="acceptCandidature('${c.id}')" style="flex:1;">
                        <i class="fas fa-check"></i> Accepter la candidature
                    </button>
                    <button class="btn btn-danger" onclick="rejectCandidature('${c.id}')" style="flex:1;">
                        <i class="fas fa-times"></i> Refuser la candidature
                    </button>
                </div>` : ''}
            `;

            document.getElementById('modalTitle').textContent = `üë§ ${c.prenom || ''} ${c.nom || ''}`;
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').classList.add('active');
        }

        function renderDocuments(documents, candidature = null) {
            let allDocs = {};
            
            // R√©cup√©rer depuis l'objet documents
            if (documents && typeof documents === 'object') {
                Object.entries(documents).forEach(([key, value]) => {
                    if (value && typeof value === 'string' && value.startsWith('http')) {
                        allDocs[key] = value;
                    } else if (Array.isArray(value)) {
                        allDocs[key] = value;
                    }
                });
            }
            
            // Chercher aussi √† la racine de la candidature
            if (candidature) {
                const docFields = ['permis', 'carteGrise', 'assurance', 'cni', 'casierJudiciaire', 
                                   'pieceIdentite', 'certificatMedical', 'carteIdentite'];
                Object.keys(candidature).forEach(key => {
                    const value = candidature[key];
                    // Si c'est une URL de document
                    if (value && typeof value === 'string' && value.startsWith('http') && 
                        (docFields.some(f => key.toLowerCase().includes(f.toLowerCase())) || 
                         key.toLowerCase().includes('document') || key.toLowerCase().includes('permis') ||
                         key.toLowerCase().includes('carte') || key.toLowerCase().includes('assurance'))) {
                        if (!allDocs[key]) allDocs[key] = value;
                    }
                });
            }
            
            console.log('üìÑ Documents √† afficher:', allDocs);
            
            if (Object.keys(allDocs).length === 0) {
                return '<p style="color:#999;grid-column:1/-1;">Aucun document upload√©</p>';
            }
            
            const docLabels = {
                'permis': 'ü™™ Permis de conduire',
                'carteGrise': 'üìÑ Carte grise',
                'assurance': 'üõ°Ô∏è Assurance',
                'cni': 'üÜî Carte d\'identit√©',
                'pieceIdentite': 'üÜî Pi√®ce d\'identit√©',
                'carteIdentite': 'üÜî Carte d\'identit√©',
                'casierJudiciaire': 'üìã Casier judiciaire',
                'certificatMedical': 'üè• Certificat m√©dical'
            };
            
            let html = '';
            Object.entries(allDocs).forEach(([key, value]) => {
                if (!value) return;
                const label = docLabels[key] || key.replace(/([A-Z])/g, ' $1').trim();
                
                if (Array.isArray(value)) {
                    value.forEach((url, i) => {
                        if (url && typeof url === 'string' && url.startsWith('http')) {
                            html += createDocCard(url, `${label} ${i+1}`);
                        }
                    });
                } else if (typeof value === 'string' && value.startsWith('http')) {
                    html += createDocCard(value, label);
                }
            });
            
            return html || '<p style="color:#999;grid-column:1/-1;">Aucun document upload√©</p>';
        }

        function renderPhotos(photos, candidature = null) {
            let allPhotos = {};
            
            // R√©cup√©rer depuis l'objet photos
            if (photos && typeof photos === 'object') {
                Object.entries(photos).forEach(([key, value]) => {
                    if (value && typeof value === 'string' && value.startsWith('http')) {
                        allPhotos[key] = value;
                    } else if (Array.isArray(value)) {
                        allPhotos[key] = value;
                    }
                });
            }
            
            // Chercher aussi √† la racine de la candidature (tous les champs contenant 'photo')
            if (candidature) {
                Object.keys(candidature).forEach(key => {
                    const value = candidature[key];
                    const keyLower = key.toLowerCase();
                    
                    // Si le champ contient 'photo' dans son nom
                    if (keyLower.includes('photo')) {
                        if (value && typeof value === 'string' && value.startsWith('http')) {
                            if (!allPhotos[key]) allPhotos[key] = value;
                        } else if (Array.isArray(value)) {
                            if (!allPhotos[key]) allPhotos[key] = value;
                        }
                    }
                });
            }
            
            console.log('üì∑ Photos √† afficher:', allPhotos);
            
            if (Object.keys(allPhotos).length === 0) {
                return '<p style="color:#999;grid-column:1/-1;">Aucune photo upload√©e</p>';
            }
            
            const photoLabels = {
                'photoProfil': 'üë§ Photo de profil',
                'photo': 'üë§ Photo',
                'photoVehicule': 'üöó Photo du v√©hicule',
                'photosVehicule': 'üöó Photos du v√©hicule',
                'photoVehiculeAvant': 'üöó V√©hicule (avant)',
                'photoVehiculeArriere': 'üöó V√©hicule (arri√®re)',
                'photoVehiculeCote': 'üöó V√©hicule (c√¥t√©)',
                'photoInterieur': 'üöó Int√©rieur v√©hicule'
            };
            
            let html = '';
            Object.entries(allPhotos).forEach(([key, value]) => {
                if (!value) return;
                const label = photoLabels[key] || key.replace(/([A-Z])/g, ' $1').trim();
                
                if (Array.isArray(value)) {
                    value.forEach((url, i) => {
                        if (url && typeof url === 'string' && url.startsWith('http')) {
                            html += createPhotoCard(url, `${label} ${i+1}`);
                        }
                    });
                } else if (typeof value === 'string' && value.startsWith('http')) {
                    html += createPhotoCard(value, label);
                }
            });
            
            return html || '<p style="color:#999;grid-column:1/-1;">Aucune photo upload√©e</p>';
        }

        function createDocCard(url, label) {
            const isImage = url.match(/\.(jpg|jpeg|png|gif|webp)/i) || url.includes('firebasestorage');
            return `
            <div class="doc-card">
                ${isImage ? `<img src="${url}" alt="${label}" onclick="openImageViewer('${url}')" onerror="this.onerror=null;this.parentElement.innerHTML='<div style=\\'height:150px;display:flex;align-items:center;justify-content:center;background:#f8d7da;color:#721c24;\\'>Erreur de chargement</div><div class=\\'doc-label\\'>${label}</div><a href=\\'${url}\\' target=\\'_blank\\'><i class=\\'fas fa-external-link-alt\\'></i> Ouvrir</a>';">` : 
                `<div style="height:150px;display:flex;align-items:center;justify-content:center;background:#f0f0f0;"><i class="fas fa-file-pdf" style="font-size:3em;color:#E30613;"></i></div>`}
                <div class="doc-label">${label}</div>
                <a href="${url}" target="_blank"><i class="fas fa-external-link-alt"></i> Ouvrir</a>
            </div>`;
        }

        function createPhotoCard(url, label) {
            return `
            <div class="doc-card">
                <img src="${url}" alt="${label}" onclick="openImageViewer('${url}')" onerror="this.onerror=null;this.parentElement.innerHTML='<div style=\\'height:150px;display:flex;align-items:center;justify-content:center;background:#f8d7da;color:#721c24;padding:10px;text-align:center;\\'>Erreur de chargement</div><div class=\\'doc-label\\'>${label}</div><a href=\\'${url}\\' target=\\'_blank\\'><i class=\\'fas fa-external-link-alt\\'></i> Ouvrir</a>';">
                <div class="doc-label">${label}</div>
                <a href="${url}" target="_blank"><i class="fas fa-external-link-alt"></i> Ouvrir</a>
            </div>`;
        }

        function openImageViewer(url) {
            document.getElementById('viewerImage').src = url;
            document.getElementById('imageViewer').classList.add('active');
        }

        function closeImageViewer() {
            document.getElementById('imageViewer').classList.remove('active');
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        // === ACCEPTER CANDIDATURE ===
        async function acceptCandidature(id) {
            const c = allCandidatures.find(x => x.id === id);
            if (!c) return;
            if (!confirm(`Accepter la candidature de ${c.prenom} ${c.nom} ?\n\nUn compte chauffeur sera cr√©√©.`)) return;

            showLoading('Cr√©ation du compte chauffeur...');
            try {
                const driverData = {
                    prenom: c.prenom || '',
                    nom: c.nom || '',
                    nomComplet: `${c.prenom || ''} ${c.nom || ''}`.trim(),
                    email: c.email || '',
                    telephone: c.telephone || '',
                    adresse: c.adresse || '',
                    dateNaissance: c.dateNaissance || '',
                    vehicule: c.vehicule || {},
                    documents: c.documents || {},
                    photos: c.photos || {},
                    statut: 'hors_ligne',
                    actif: true,
                    disponible: true,
                    rating: 5.0,
                    coursesCompletees: 0,
                    coursesEnCours: 0,
                    revenusTotal: 0,
                    candidatureId: id,
                    dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
                    derniereActivite: firebase.firestore.FieldValue.serverTimestamp()
                };

                const driverRef = await db.collection('drivers').add(driverData);
                
                // Mettre √† jour la candidature
                await db.collection(CANDIDATURES_COLLECTION).doc(id).update({
                    statut: 'acceptee',
                    driverId: driverRef.id,
                    dateTraitement: firebase.firestore.FieldValue.serverTimestamp()
                });

                hideLoading();
                closeModal();
                showToast(`‚úÖ ${c.prenom} ${c.nom} accept√©! Compte chauffeur cr√©√©.`, 'success');
                loadCandidatures();
            } catch (error) {
                hideLoading();
                console.error('Erreur acceptation:', error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        // === REFUSER CANDIDATURE ===
        async function rejectCandidature(id) {
            const c = allCandidatures.find(x => x.id === id);
            if (!c) return;
            const motif = prompt(`Refuser la candidature de ${c.prenom} ${c.nom} ?\n\nMotif (optionnel):`);
            if (motif === null) return;

            showLoading('Mise √† jour...');
            try {
                await db.collection(CANDIDATURES_COLLECTION).doc(id).update({
                    statut: 'refusee',
                    motifRefus: motif || '',
                    dateTraitement: firebase.firestore.FieldValue.serverTimestamp()
                });
                hideLoading();
                closeModal();
                showToast(`‚ùå Candidature de ${c.prenom} ${c.nom} refus√©e.`, 'info');
                loadCandidatures();
            } catch (error) {
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        // === SUPPRIMER CANDIDATURE ===
        async function deleteCandidature(id) {
            if (!confirm('Supprimer d√©finitivement cette candidature ?')) return;
            showLoading('Suppression...');
            try {
                await db.collection(CANDIDATURES_COLLECTION).doc(id).delete();
                hideLoading();
                showToast('‚úÖ Candidature supprim√©e', 'success');
                loadCandidatures();
            } catch (error) {
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        // === CHAUFFEURS (code existant conserv√©) ===
        async function loadDrivers() {
            if (!auth.currentUser) return;
            showLoading('Chargement des chauffeurs...');
            try {
                const snapshot = await db.collection('drivers').get();
                allDrivers = [];
                snapshot.forEach(doc => allDrivers.push({ id: doc.id, ...doc.data() }));
                updateDriversStats();
                displayDrivers(allDrivers);
                hideLoading();
            } catch (error) {
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        function updateDriversStats() {
            document.getElementById('totalDrivers').textContent = allDrivers.length;
            document.getElementById('availableDrivers').textContent = allDrivers.filter(d => d.statut === 'disponible').length;
            document.getElementById('busyDrivers').textContent = allDrivers.filter(d => d.statut === 'en_course').length;
            document.getElementById('offlineDrivers').textContent = allDrivers.filter(d => d.statut === 'hors_ligne' || !d.statut).length;
        }

        function displayDrivers(drivers) {
            const tbody = document.getElementById('driversTableBody');
            if (drivers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Aucun chauffeur</td></tr>`;
                return;
            }
            tbody.innerHTML = drivers.map(d => {
                const statut = d.statut || 'hors_ligne';
                return `
                <tr>
                    <td><strong>${d.prenom || ''} ${d.nom || ''}</strong><br><small style="color:#666;">${d.email || ''}</small></td>
                    <td>${d.telephone || 'N/A'}</td>
                    <td>${d.vehicule?.marque || ''} ${d.vehicule?.modele || ''}<br><small style="color:#666;">${d.vehicule?.immatriculation || ''}</small></td>
                    <td><strong style="color:#FECB00;">‚≠ê ${(d.rating || 0).toFixed(1)}</strong></td>
                    <td>${d.coursesCompletees || 0}</td>
                    <td><span class="status-badge status-${statut}">${getStatusLabel(statut)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-icon btn-view" onclick="viewDriver('${d.id}')" title="D√©tails"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-icon btn-edit" onclick="editDriver('${d.id}')" title="Modifier"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-icon btn-delete" onclick="deleteDriver('${d.id}')" title="Supprimer"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function searchDrivers() {
            const term = document.getElementById('searchDrivers').value.toLowerCase();
            const filtered = allDrivers.filter(d =>
                (d.prenom?.toLowerCase().includes(term)) ||
                (d.nom?.toLowerCase().includes(term)) ||
                (d.telephone?.includes(term))
            );
            displayDrivers(filtered);
        }

        function viewDriver(id) {
            const d = allDrivers.find(x => x.id === id);
            if (!d) return;
            const html = `
                <div class="info-section">
                    <h4><i class="fas fa-user"></i> Informations</h4>
                    <div class="info-grid">
                        <div class="info-item"><label>Nom</label><span>${d.prenom || ''} ${d.nom || ''}</span></div>
                        <div class="info-item"><label>T√©l√©phone</label><span>${d.telephone || 'N/A'}</span></div>
                        <div class="info-item"><label>Email</label><span>${d.email || 'N/A'}</span></div>
                        <div class="info-item"><label>Statut</label><span class="status-badge status-${d.statut || 'hors_ligne'}">${getStatusLabel(d.statut || 'hors_ligne')}</span></div>
                    </div>
                </div>
                <div class="info-section">
                    <h4><i class="fas fa-car"></i> V√©hicule</h4>
                    <div class="info-grid">
                        <div class="info-item"><label>Marque</label><span>${d.vehicule?.marque || 'N/A'}</span></div>
                        <div class="info-item"><label>Mod√®le</label><span>${d.vehicule?.modele || 'N/A'}</span></div>
                        <div class="info-item"><label>Immatriculation</label><span>${d.vehicule?.immatriculation || 'N/A'}</span></div>
                    </div>
                </div>
                <div class="info-section">
                    <h4><i class="fas fa-chart-bar"></i> Statistiques</h4>
                    <div class="info-grid">
                        <div class="info-item"><label>Note</label><span>‚≠ê ${(d.rating || 0).toFixed(1)}</span></div>
                        <div class="info-item"><label>Courses</label><span>${d.coursesCompletees || 0}</span></div>
                        <div class="info-item"><label>Revenus</label><span>${(d.revenusTotal || 0).toLocaleString()} FCFA</span></div>
                    </div>
                </div>
                <div class="info-section">
                    <h4><i class="fas fa-folder-open"></i> Documents</h4>
                    <div class="docs-grid">${renderDocuments(d.documents, d)}</div>
                </div>
                <div class="info-section">
                    <h4><i class="fas fa-camera"></i> Photos</h4>
                    <div class="docs-grid">${renderPhotos(d.photos, d)}</div>
                </div>
            `;
            document.getElementById('modalTitle').textContent = `üë§ ${d.prenom || ''} ${d.nom || ''}`;
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').classList.add('active');
        }

        function editDriver(id) {
            const d = allDrivers.find(x => x.id === id);
            if (!d) return;
            const html = `
                <div class="form-group"><label>Pr√©nom</label><input type="text" id="editPrenom" value="${d.prenom || ''}"></div>
                <div class="form-group"><label>Nom</label><input type="text" id="editNom" value="${d.nom || ''}"></div>
                <div class="form-group"><label>T√©l√©phone</label><input type="text" id="editTel" value="${d.telephone || ''}"></div>
                <div class="form-group"><label>Immatriculation</label><input type="text" id="editPlate" value="${d.vehicule?.immatriculation || ''}"></div>
                <div class="form-group">
                    <label>Statut</label>
                    <select id="editStatut">
                        <option value="disponible" ${d.statut === 'disponible' ? 'selected' : ''}>Disponible</option>
                        <option value="en_course" ${d.statut === 'en_course' ? 'selected' : ''}>En Course</option>
                        <option value="hors_ligne" ${d.statut === 'hors_ligne' ? 'selected' : ''}>Hors Ligne</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="saveDriver('${id}')" style="width:100%;margin-top:15px;">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            `;
            document.getElementById('modalTitle').textContent = `‚úèÔ∏è Modifier ${d.prenom || ''} ${d.nom || ''}`;
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').classList.add('active');
        }

        async function saveDriver(id) {
            showLoading('Enregistrement...');
            try {
                await db.collection('drivers').doc(id).update({
                    prenom: document.getElementById('editPrenom').value,
                    nom: document.getElementById('editNom').value,
                    telephone: document.getElementById('editTel').value,
                    'vehicule.immatriculation': document.getElementById('editPlate').value,
                    statut: document.getElementById('editStatut').value
                });
                hideLoading();
                closeModal();
                showToast('‚úÖ Chauffeur modifi√©', 'success');
                loadDrivers();
            } catch (error) {
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function deleteDriver(id) {
            if (!confirm('Supprimer d√©finitivement ce chauffeur ?')) return;
            showLoading('Suppression...');
            try {
                await db.collection('drivers').doc(id).delete();
                hideLoading();
                showToast('‚úÖ Chauffeur supprim√©', 'success');
                loadDrivers();
            } catch (error) {
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        function newDriver() {
            const html = `
                <div class="form-group"><label>Pr√©nom *</label><input type="text" id="newPrenom" placeholder="Mamadou"></div>
                <div class="form-group"><label>Nom *</label><input type="text" id="newNom" placeholder="Diop"></div>
                <div class="form-group"><label>T√©l√©phone *</label><input type="text" id="newTel" placeholder="+221771234567"></div>
                <div class="form-group"><label>Email</label><input type="email" id="newEmail" placeholder="email@exemple.com"></div>
                <div class="form-group"><label>Marque v√©hicule</label><input type="text" id="newMarque" placeholder="Toyota"></div>
                <div class="form-group"><label>Mod√®le</label><input type="text" id="newModele" placeholder="Corolla"></div>
                <div class="form-group"><label>Immatriculation</label><input type="text" id="newPlate" placeholder="DK-1234-AB"></div>
                <button class="btn btn-primary" onclick="createDriver()" style="width:100%;margin-top:15px;">
                    <i class="fas fa-plus"></i> Cr√©er le chauffeur
                </button>
            `;
            document.getElementById('modalTitle').textContent = '‚ûï Nouveau Chauffeur';
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').classList.add('active');
        }

        async function createDriver() {
            const prenom = document.getElementById('newPrenom').value.trim();
            const nom = document.getElementById('newNom').value.trim();
            const tel = document.getElementById('newTel').value.trim();
            if (!prenom || !nom || !tel) { showToast('Pr√©nom, nom et t√©l√©phone requis', 'error'); return; }

            showLoading('Cr√©ation...');
            try {
                await db.collection('drivers').add({
                    prenom, nom,
                    telephone: tel,
                    email: document.getElementById('newEmail').value.trim(),
                    vehicule: {
                        marque: document.getElementById('newMarque').value.trim(),
                        modele: document.getElementById('newModele').value.trim(),
                        immatriculation: document.getElementById('newPlate').value.trim()
                    },
                    statut: 'hors_ligne',
                    actif: true,
                    rating: 5.0,
                    coursesCompletees: 0,
                    revenusTotal: 0,
                    dateCreation: firebase.firestore.FieldValue.serverTimestamp()
                });
                hideLoading();
                closeModal();
                showToast('‚úÖ Chauffeur cr√©√©', 'success');
                loadDrivers();
            } catch (error) {
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        // Auto-check auth state
        auth.onAuthStateChanged(user => {
            if (user && document.getElementById('adminDashboard').style.display !== 'none') {
                loadCandidatures();
            }
        });

        console.log('üöï Al Bourakh Admin v2.0 - Pr√™t!');
    </script>
</body>
</html>
